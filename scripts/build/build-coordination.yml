# Build Coordination Configuration
# Coordinates building of GUI, API, and Docker systems
# Implements build phases from lucid-container-build-plan.plan.md

build_coordination:
  version: "1.0.0"
  description: "Build coordination for Lucid multi-system architecture"
  last_updated: "2025-01-10T19:08:00Z"

# Build Environment Configuration
build_environment:
  default_environment: "production"
  supported_environments:
    - "development"
    - "staging"
    - "production"
  
  platform_config:
    target_platform: "linux/arm64"
    supported_platforms:
      - "linux/amd64"
      - "linux/arm64"
    
  registry_config:
    default_registry: "ghcr.io"
    image_name: "HamiGames/Lucid"
    default_tag: "latest"
    
  build_config:
    parallel_builds: true
    build_timeout: 1800  # 30 minutes
    cleanup_registry: true
    distroless_only: true
    multi_stage_builds: true

# Build Phases Configuration
build_phases:
  # Pre-Build Phase
  pre_build:
    name: "Pre-Build Phase"
    description: "Cleanup and setup before building"
    parallel: false
    steps:
      - name: "validate_build_environment"
        description: "Validate Windows 11 build host and Raspberry Pi target"
        timeout: 300
        required: true
        
      - name: "cleanup_docker_registry"
        description: "Clean all existing images from Docker Hub registry"
        timeout: 600
        required: true
        
      - name: "generate_environment_configs"
        description: "Generate ALL environment configuration files"
        timeout: 120
        required: true
        
      - name: "build_base_images"
        description: "Build foundation distroless base images"
        timeout: 900
        required: true

  # Phase 1: Foundation Services
  foundation:
    name: "Phase 1: Foundation Services"
    description: "Build database and authentication services"
    parallel: true
    depends_on: ["pre_build"]
    services:
      - name: "lucid-mongodb"
        image: "mongo:7.0"
        distroless: false  # Base image
        build_timeout: 300
        
      - name: "lucid-redis"
        image: "redis:7-alpine"
        distroless: false  # Base image
        build_timeout: 300
        
      - name: "lucid-elasticsearch"
        image: "elasticsearch:8.11.0"
        distroless: false  # Base image
        build_timeout: 600
        
      - name: "lucid-auth-service"
        image: "lucid-auth-service:latest-arm64"
        distroless: true
        build_timeout: 600
        base_image: "gcr.io/distroless/python3-debian12"
        
      - name: "lucid-storage-database"
        image: "lucid-storage-database:latest-arm64"
        distroless: true
        build_timeout: 600
        base_image: "gcr.io/distroless/python3-debian12"

  # Phase 2: Core Services
  core:
    name: "Phase 2: Core Services"
    description: "Build API gateway, blockchain core, and service mesh"
    parallel: true
    depends_on: ["foundation"]
    services:
      - name: "lucid-api-gateway"
        image: "lucid-api-gateway:latest-arm64"
        distroless: true
        build_timeout: 600
        base_image: "gcr.io/distroless/python3-debian12"
        
      - name: "lucid-blockchain-core"
        image: "lucid-blockchain-core:latest-arm64"
        distroless: true
        build_timeout: 900
        base_image: "gcr.io/distroless/python3-debian12"
        
      - name: "lucid-service-mesh-controller"
        image: "lucid-service-mesh-controller:latest-arm64"
        distroless: true
        build_timeout: 600
        base_image: "gcr.io/distroless/python3-debian12"

  # Phase 3: Application Services
  application:
    name: "Phase 3: Application Services"
    description: "Build session management, RDP services, and node management"
    parallel: true
    depends_on: ["core"]
    services:
      - name: "lucid-session-pipeline"
        image: "lucid-session-pipeline:latest-arm64"
        distroless: true
        build_timeout: 600
        base_image: "gcr.io/distroless/python3-debian12"
        
      - name: "lucid-session-recorder"
        image: "lucid-session-recorder:latest-arm64"
        distroless: true
        build_timeout: 600
        base_image: "gcr.io/distroless/python3-debian12"
        
      - name: "lucid-chunk-processor"
        image: "lucid-chunk-processor:latest-arm64"
        distroless: true
        build_timeout: 600
        base_image: "gcr.io/distroless/python3-debian12"
        
      - name: "lucid-session-storage"
        image: "lucid-session-storage:latest-arm64"
        distroless: true
        build_timeout: 600
        base_image: "gcr.io/distroless/python3-debian12"
        
      - name: "lucid-session-api"
        image: "lucid-session-api:latest-arm64"
        distroless: true
        build_timeout: 600
        base_image: "gcr.io/distroless/python3-debian12"
        
      - name: "lucid-rdp-server-manager"
        image: "lucid-rdp-server-manager:latest-arm64"
        distroless: true
        build_timeout: 600
        base_image: "gcr.io/distroless/python3-debian12"
        
      - name: "lucid-xrdp-integration"
        image: "lucid-xrdp-integration:latest-arm64"
        distroless: true
        build_timeout: 900
        base_image: "gcr.io/distroless/python3-debian12"
        
      - name: "lucid-session-controller"
        image: "lucid-session-controller:latest-arm64"
        distroless: true
        build_timeout: 600
        base_image: "gcr.io/distroless/python3-debian12"
        
      - name: "lucid-resource-monitor"
        image: "lucid-resource-monitor:latest-arm64"
        distroless: true
        build_timeout: 600
        base_image: "gcr.io/distroless/python3-debian12"
        
      - name: "lucid-node-management"
        image: "lucid-node-management:latest-arm64"
        distroless: true
        build_timeout: 600
        base_image: "gcr.io/distroless/python3-debian12"

  # Phase 4: Support Services
  support:
    name: "Phase 4: Support Services"
    description: "Build admin interface and TRON payment services"
    parallel: true
    depends_on: ["application"]
    services:
      - name: "lucid-admin-interface"
        image: "lucid-admin-interface:latest-arm64"
        distroless: true
        build_timeout: 900
        base_image: "gcr.io/distroless/python3-debian12"
        
      - name: "lucid-tron-client"
        image: "lucid-tron-client:latest-arm64"
        distroless: true
        build_timeout: 600
        base_image: "gcr.io/distroless/python3-debian12"
        isolated_network: true
        
      - name: "lucid-payout-router"
        image: "lucid-payout-router:latest-arm64"
        distroless: true
        build_timeout: 600
        base_image: "gcr.io/distroless/python3-debian12"
        isolated_network: true
        
      - name: "lucid-wallet-manager"
        image: "lucid-wallet-manager:latest-arm64"
        distroless: true
        build_timeout: 600
        base_image: "gcr.io/distroless/python3-debian12"
        isolated_network: true
        
      - name: "lucid-usdt-manager"
        image: "lucid-usdt-manager:latest-arm64"
        distroless: true
        build_timeout: 600
        base_image: "gcr.io/distroless/python3-debian12"
        isolated_network: true
        
      - name: "lucid-trx-staking"
        image: "lucid-trx-staking:latest-arm64"
        distroless: true
        build_timeout: 600
        base_image: "gcr.io/distroless/python3-debian12"
        isolated_network: true
        
      - name: "lucid-payment-gateway"
        image: "lucid-payment-gateway:latest-arm64"
        distroless: true
        build_timeout: 600
        base_image: "gcr.io/distroless/python3-debian12"
        isolated_network: true

  # GUI Integration Phase
  gui_integration:
    name: "GUI Integration Phase"
    description: "Build GUI integration services"
    parallel: true
    depends_on: ["support"]
    services:
      - name: "lucid-gui-api-bridge"
        image: "lucid-gui-api-bridge:latest-arm64"
        distroless: true
        build_timeout: 600
        base_image: "gcr.io/distroless/python3-debian12"
        
      - name: "lucid-gui-docker-manager"
        image: "lucid-gui-docker-manager:latest-arm64"
        distroless: true
        build_timeout: 600
        base_image: "gcr.io/distroless/python3-debian12"
        
      - name: "lucid-gui-tor-manager"
        image: "lucid-gui-tor-manager:latest-arm64"
        distroless: true
        build_timeout: 600
        base_image: "gcr.io/distroless/python3-debian12"
        
      - name: "lucid-gui-hardware-wallet"
        image: "lucid-gui-hardware-wallet:latest-arm64"
        distroless: true
        build_timeout: 600
        base_image: "gcr.io/distroless/python3-debian12"

  # Electron GUI Phase
  electron_gui:
    name: "Electron GUI Phase"
    description: "Build Electron GUI applications"
    parallel: false
    depends_on: ["gui_integration"]
    applications:
      - name: "lucid-user-gui"
        platform: "win32"
        arch: "x64"
        build_timeout: 900
        
      - name: "lucid-developer-gui"
        platform: "win32"
        arch: "x64"
        build_timeout: 900
        
      - name: "lucid-node-gui"
        platform: "win32"
        arch: "x64"
        build_timeout: 900
        
      - name: "lucid-admin-gui"
        platform: "win32"
        arch: "x64"
        build_timeout: 900
        
      - name: "lucid-user-gui-linux"
        platform: "linux"
        arch: "arm64"
        build_timeout: 900
        
      - name: "lucid-developer-gui-linux"
        platform: "linux"
        arch: "arm64"
        build_timeout: 900
        
      - name: "lucid-node-gui-linux"
        platform: "linux"
        arch: "arm64"
        build_timeout: 900
        
      - name: "lucid-admin-gui-linux"
        platform: "linux"
        arch: "arm64"
        build_timeout: 900

# Build Validation Configuration
build_validation:
  tron_isolation:
    enabled: true
    timeout: 300
    checks:
      - name: "scan_blockchain_for_tron"
        description: "Scan blockchain/ directory for TRON references"
        command: "grep -r 'tron' blockchain/ --exclude-dir=node_modules"
        expected_result: "zero_matches"
        
      - name: "scan_blockchain_for_tronweb"
        description: "Scan blockchain/ directory for TronWeb references"
        command: "grep -r 'TronWeb' blockchain/"
        expected_result: "zero_matches"
        
      - name: "scan_blockchain_for_payment"
        description: "Scan blockchain/ directory for payment logic"
        command: "grep -r 'payment' blockchain/core/"
        expected_result: "zero_matches"

  distroless_compliance:
    enabled: true
    timeout: 600
    checks:
      - name: "verify_distroless_base"
        description: "Verify all containers use distroless base images"
        command: "grep -r 'gcr.io/distroless' Dockerfile*"
        expected_result: "all_containers"
        
      - name: "verify_no_shell_access"
        description: "Verify no shell access in runtime containers"
        command: "docker run --rm <image> /bin/sh -c 'echo test'"
        expected_result: "executable_file_not_found"
        
      - name: "verify_non_root_user"
        description: "Verify containers run as non-root user"
        command: "docker run --rm <image> id -u"
        expected_result: "65532"

  integration_tests:
    enabled: true
    timeout: 1800
    test_suites:
      - name: "phase1_integration_tests"
        description: "Test Phase 1 foundation services"
        timeout: 600
        
      - name: "phase2_integration_tests"
        description: "Test Phase 2 core services"
        timeout: 600
        
      - name: "phase3_integration_tests"
        description: "Test Phase 3 application services"
        timeout: 600
        
      - name: "phase4_integration_tests"
        description: "Test Phase 4 support services"
        timeout: 600
        
      - name: "gui_integration_tests"
        description: "Test GUI integration services"
        timeout: 600

# Deployment Configuration
deployment:
  pi_deployment:
    enabled: true
    host: "192.168.0.75"
    user: "pickme"
    deploy_dir: "/opt/lucid/production"
    
    phases:
      - name: "copy_configs"
        description: "Copy configuration files to Pi"
        timeout: 300
        
      - name: "copy_compose_files"
        description: "Copy Docker Compose files to Pi"
        timeout: 300
        
      - name: "pull_images"
        description: "Pull Docker images on Pi"
        timeout: 1800
        
      - name: "deploy_foundation"
        description: "Deploy Phase 1 foundation services"
        timeout: 600
        
      - name: "deploy_core"
        description: "Deploy Phase 2 core services"
        timeout: 600
        
      - name: "deploy_application"
        description: "Deploy Phase 3 application services"
        timeout: 600
        
      - name: "deploy_support"
        description: "Deploy Phase 4 support services"
        timeout: 600
        
      - name: "deploy_gui_integration"
        description: "Deploy GUI integration services"
        timeout: 600

# Build Reporting Configuration
build_reporting:
  enabled: true
  output_format: "json"
  output_directory: "build/reports"
  
  report_sections:
    - "build_info"
    - "build_phases"
    - "validation_results"
    - "deployment_status"
    - "images_built"
    - "performance_metrics"
    - "error_logs"
    
  performance_metrics:
    enabled: true
    metrics:
      - "build_duration"
      - "image_sizes"
      - "build_success_rate"
      - "deployment_duration"
      
  error_reporting:
    enabled: true
    log_levels: ["ERROR", "WARNING"]
    include_stack_traces: true
    max_error_entries: 100

# Build Optimization Configuration
build_optimization:
  parallel_builds:
    enabled: true
    max_parallel_jobs: 4
    job_timeout: 1800
    
  caching:
    enabled: true
    cache_layers: true
    cache_build_context: true
    cache_registry: true
    
  resource_limits:
    memory_limit: "8G"
    cpu_limit: "4"
    disk_space_limit: "50G"
    
  build_cleanup:
    enabled: true
    cleanup_intermediate_images: true
    cleanup_build_cache: true
    cleanup_logs: false

# Security Configuration
security:
  image_scanning:
    enabled: true
    scanner: "trivy"
    scan_levels: ["HIGH", "CRITICAL"]
    fail_on_vulnerabilities: true
    
  signing:
    enabled: false  # Enable when signing keys are available
    sign_images: false
    
  secrets_management:
    enabled: true
    secrets_file: "configs/environment/.secrets"
    encrypt_secrets: true
    
  network_security:
    isolated_networks: true
    tron_isolation: true
    internal_communication_only: true
