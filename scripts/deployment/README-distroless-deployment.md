# Distroless Deployment for Lucid Project

This directory contains comprehensive deployment scripts for the Lucid project using distroless containers and pre-built images from Docker Hub (pickme namespace).

## Overview

The distroless deployment provides:
- **Security**: Distroless containers with minimal attack surface
- **Performance**: ARM64-optimized images for Raspberry Pi 5
- **Scalability**: Multi-stage build infrastructure for CI/CD
- **Isolation**: Network isolation for TRON payment services
- **Monitoring**: Comprehensive health checks and verification

## Quick Start

### Full Deployment (Recommended)

```bash
# SSH to Raspberry Pi
ssh pickme@192.168.0.75

# Navigate to project
cd /mnt/myssd/Lucid/Lucid

# Set project root
export PROJECT_ROOT="/mnt/myssd/Lucid/Lucid"

# Run complete deployment
bash scripts/deployment/deploy-distroless-complete.sh full
```

### Step-by-Step Deployment

```bash
# Step 1: Create networks and environment files
bash scripts/deployment/deploy-distroless-complete.sh networks

# Step 2: Deploy distroless base infrastructure
bash scripts/deployment/deploy-distroless-complete.sh distroless

# Step 3: Deploy Lucid services
bash scripts/deployment/deploy-distroless-complete.sh lucid

# Step 4: Deploy multi-stage build (optional)
bash scripts/deployment/deploy-distroless-complete.sh multi-stage

# Step 5: Verify deployment
bash scripts/deployment/verify-distroless-deployment.sh
```

## Deployment Scripts

### Core Deployment Scripts

| Script | Purpose | Description |
|--------|---------|-------------|
| `deploy-distroless-complete.sh` | Main orchestrator | Complete deployment with options |
| `create-distroless-networks.sh` | Network setup | Creates all 6 Docker networks |
| `create-distroless-env.sh` | Environment config | Creates distroless-specific .env file |
| `deploy-distroless-base.sh` | Base infrastructure | Deploys distroless runtime/development/security |
| `deploy-lucid-services.sh` | Lucid services | Deploys all Lucid services in phases |
| `deploy-multi-stage-build.sh` | Build infrastructure | Deploys multi-stage build tools |
| `verify-distroless-deployment.sh` | Verification | Comprehensive deployment verification |

### Deployment Options

#### 1. Full Deployment
```bash
bash scripts/deployment/deploy-distroless-complete.sh full
```
- Creates all networks
- Generates secure .env files
- Deploys distroless base infrastructure
- Deploys all Lucid services
- Optionally deploys multi-stage build

#### 2. Networks Only
```bash
bash scripts/deployment/deploy-distroless-complete.sh networks
```
- Creates all 6 Docker networks
- Generates secure .env files
- Creates distroless-specific .env file
- Skips service deployment

#### 3. Distroless Base Only
```bash
bash scripts/deployment/deploy-distroless-complete.sh distroless
```
- Deploys distroless runtime environment
- Deploys distroless development environment (optional)
- Deploys distroless security configuration (optional)
- Requires networks and .env files

#### 4. Lucid Services Only
```bash
bash scripts/deployment/deploy-distroless-complete.sh lucid
```
- Deploys Foundation services (MongoDB, Redis, Elasticsearch, Auth)
- Deploys Core services (API Gateway, Blockchain, Service Mesh)
- Deploys Application services (Sessions, RDP, Node Management)
- Deploys Support services (Admin Interface, TRON Payment System)
- Deploys GUI Integration (optional)
- Requires networks and .env files

#### 5. Multi-Stage Build Only
```bash
bash scripts/deployment/deploy-distroless-complete.sh multi-stage
```
- Deploys multi-stage build infrastructure
- Deploys build tools and optimization
- Deploys development and testing environments
- Requires networks

## Network Configuration

### Primary Networks

| Network | Subnet | Purpose | Services |
|---------|--------|---------|----------|
| `lucid-pi-network` | 172.20.0.0/16 | Main services | Foundation, Core, Application, Admin |
| `lucid-tron-isolated` | 172.21.0.0/16 | TRON services | TRON payment system (ISOLATED) |
| `lucid-gui-network` | 172.22.0.0/16 | GUI services | Electron GUI integration |

### Additional Networks

| Network | Subnet | Purpose | Services |
|---------|--------|---------|----------|
| `lucid-distroless-production` | 172.23.0.0/16 | Distroless production | Distroless runtime infrastructure |
| `lucid-distroless-dev` | 172.24.0.0/16 | Distroless development | Development and testing |
| `lucid-multi-stage-network` | 172.25.0.0/16 | Build infrastructure | Multi-stage builds and CI/CD |

## Environment Configuration

### Environment Files

| File | Purpose | Generated By |
|------|---------|--------------|
| `.env.foundation` | Phase 1 secrets | `generate-all-env-complete.sh` |
| `.env.core` | Phase 2 secrets | `generate-all-env-complete.sh` |
| `.env.application` | Phase 3 secrets | `generate-all-env-complete.sh` |
| `.env.support` | Phase 4 secrets | `generate-all-env-complete.sh` |
| `.env.gui` | GUI secrets | `generate-all-env-complete.sh` |
| `.env.distroless` | Distroless-specific | `create-distroless-env.sh` |

### Security Features

- **Cryptographic passwords**: All passwords are 32+ bytes, base64 encoded
- **JWT secrets**: 64+ bytes for secure token signing
- **Encryption keys**: 32+ bytes for data encryption
- **No weak defaults**: Deployment fails if .env files not loaded
- **Network isolation**: TRON services isolated from blockchain core

## Service Deployment

### Phase 1: Foundation Services

**Pre-built images:**
- `pickme/lucid-mongodb:latest-arm64` - MongoDB 7.0 with replica set
- `pickme/lucid-redis:latest-arm64` - Redis 7.0 with persistence
- `pickme/lucid-elasticsearch:latest-arm64` - Elasticsearch 8.11.0
- `pickme/lucid-auth-service:latest-arm64` - TRON-based auth service

**Network:** `lucid-pi-network` (172.20.0.0/16)

**Ports:**
- MongoDB: 27017
- Redis: 6379
- Elasticsearch: 9200/9300
- Auth Service: 8089

### Phase 2: Core Services

**Pre-built images:**
- `pickme/lucid-api-gateway:latest-arm64` - API Gateway (8080/8081)
- `pickme/lucid-blockchain-engine:latest-arm64` - Blockchain core (8084)
- `pickme/lucid-session-anchoring:latest-arm64` - Session anchoring (8085)
- `pickme/lucid-block-manager:latest-arm64` - Block manager (8086)
- `pickme/lucid-data-chain:latest-arm64` - Data chain (8087)
- `pickme/lucid-service-mesh-controller:latest-arm64` - Service mesh (8500/8501/8502)

**Network:** `lucid-pi-network` (172.20.0.0/16)

### Phase 3: Application Services

**Pre-built images:**

**Session Management:**
- `pickme/lucid-session-pipeline:latest-arm64` - Session pipeline (8083)
- `pickme/lucid-session-recorder:latest-arm64` - Session recorder (8110)
- `pickme/lucid-chunk-processor:latest-arm64` - Chunk processor (8111)
- `pickme/lucid-session-storage:latest-arm64` - Session storage (8112)
- `pickme/lucid-session-api:latest-arm64` - Session API (8113)

**RDP Services:**
- `pickme/lucid-rdp-server-manager:latest-arm64` - RDP server manager (8081)
- `pickme/lucid-xrdp-integration:latest-arm64` - XRDP integration (3389)
- `pickme/lucid-session-controller:latest-arm64` - Session controller (8082)
- `pickme/lucid-resource-monitor:latest-arm64` - Resource monitor (8090)

**Node Management:**
- `pickme/lucid-node-management:latest-arm64` - Node management (8095)

**Network:** `lucid-pi-network` (172.20.0.0/16)

### Phase 4: Support Services

**Pre-built images:**

**Admin Interface (on lucid-pi-network):**
- `pickme/lucid-admin-interface:latest-arm64` - Admin interface (8120)

**TRON Payment Services (on lucid-tron-isolated):**
- `pickme/lucid-tron-client:latest-arm64` - TRON client (8091)
- `pickme/lucid-payout-router:latest-arm64` - Payout router (8092)
- `pickme/lucid-wallet-manager:latest-arm64` - Wallet manager (8093)
- `pickme/lucid-usdt-manager:latest-arm64` - USDT manager (8094)
- `pickme/lucid-trx-staking:latest-arm64` - TRX staking (8097)
- `pickme/lucid-payment-gateway:latest-arm64` - Payment gateway (8098)

**Networks:**
- Admin: `lucid-pi-network` (172.20.0.0/16)
- TRON: `lucid-tron-isolated` (172.21.0.0/16) - ISOLATED

## Distroless Base Infrastructure

### Runtime Configuration

**Services:**
- `distroless-runtime` - Main ARM64 runtime
- `minimal-runtime` - Minimal resource-constrained runtime
- `arm64-runtime` - ARM64-optimized runtime for Pi 5

**Features:**
- Read-only filesystem
- No new privileges
- Minimal attack surface
- ARM64 optimizations

### Development Configuration

**Services:**
- `dev-distroless` - Development environment with hot reload
- `dev-minimal` - Minimal dev configuration
- `dev-tools` - Development tools container

**Features:**
- Hot reload support
- Debug capabilities
- Development database
- Code coverage

### Security Configuration

**Services:**
- `secure-distroless` - Security-hardened distroless
- `minimal-secure` - Minimal security configuration
- `security-monitor` - Security monitoring

**Features:**
- AppArmor/Seccomp profiles
- Enhanced security options
- Security monitoring
- Compliance features

## Multi-Stage Build Infrastructure

### Build Tools

**Services:**
- `build-orchestrator` - Multi-stage build orchestrator
- `layer-analyzer` - Layer analysis and optimization
- `cache-optimizer` - Build cache optimization
- `build-validator` - Build validation and testing

**Features:**
- Layer optimization
- Build caching
- Performance monitoring
- Test result aggregation

### Development Environment

**Services:**
- `dev-multi-stage` - Multi-stage development environment
- `dev-builder` - Development builder tools
- `dev-tools` - Development utilities
- `dev-database` - Development database

**Features:**
- Multi-stage builds
- Development tools
- Testing capabilities
- Performance analysis

## Verification

### Health Checks

The verification script checks:
- **Networks**: All 6 networks with correct subnets
- **Environment files**: All .env files present and secure
- **Containers**: All containers running and healthy
- **Endpoints**: Service health endpoints responding
- **Security**: Database authentication required
- **Isolation**: Network isolation working correctly

### Manual Testing

```bash
# Test service endpoints
curl http://localhost:8080/health  # API Gateway
curl http://localhost:8089/health  # Auth Service
curl http://localhost:8084/health  # Blockchain Core
curl http://localhost:8120/health  # Admin Interface

# Test database security
docker exec lucid-mongodb mongosh -u lucid -p wrongpassword --authenticationDatabase admin --eval "db.runCommand('ping')"
docker exec lucid-redis redis-cli ping

# Check network isolation
docker inspect lucid-tron-client | grep lucid-tron-isolated
docker inspect lucid-api-gateway | grep lucid-pi-network
```

## Troubleshooting

### Common Issues

#### 1. Network Creation Fails
```bash
# Check existing networks
docker network ls

# Remove conflicting networks
docker network rm <network_name>

# Recreate networks
bash scripts/deployment/create-distroless-networks.sh
```

#### 2. Environment Files Missing
```bash
# Generate .env files
bash scripts/config/generate-all-env-complete.sh

# Create distroless .env file
bash scripts/deployment/create-distroless-env.sh
```

#### 3. Container Startup Fails
```bash
# Check container logs
docker logs <container_name>

# Check container health
docker inspect <container_name> | grep -A 10 Health

# Restart specific service
docker-compose -f <compose_file> restart <service_name>
```

#### 4. Service Endpoints Not Responding
```bash
# Check if containers are running
docker ps | grep <service_name>

# Check port bindings
docker port <container_name>

# Test internal connectivity
docker exec <container_name> curl localhost:<port>/health
```

### Debug Mode

```bash
# Enable debug logging
export LOG_LEVEL=DEBUG

# Run with verbose output
bash -x scripts/deployment/deploy-distroless-complete.sh full
```

## Security Considerations

### Container Security
- **Distroless images**: Minimal attack surface
- **Non-root execution**: All containers run as non-root user
- **Read-only filesystem**: Containers use read-only root filesystem
- **No new privileges**: Security option enabled
- **Capability dropping**: All capabilities dropped, only necessary ones added

### Network Security
- **Isolated networks**: TRON services isolated from blockchain core
- **No inter-container communication**: ICC disabled for security networks
- **IP masquerading**: Controlled network access with masquerading

### Data Security
- **Encrypted passwords**: All passwords are cryptographically generated
- **JWT secrets**: Secure token signing with 64+ byte secrets
- **Database authentication**: MongoDB and Redis require authentication
- **Environment isolation**: .env files not in version control

## Performance Optimization

### Resource Limits
- **Memory limits**: Configurable memory limits per container
- **CPU limits**: CPU usage limits for resource control
- **File descriptor limits**: Ulimit restrictions for security
- **Process limits**: Process count restrictions

### ARM64 Optimizations
- **Platform-specific images**: ARM64-optimized distroless images
- **Resource tuning**: Platform-specific resource allocations
- **Performance monitoring**: Real-time performance metrics

## Monitoring and Maintenance

### Health Monitoring
- **Container health checks**: Comprehensive health check configurations
- **Service endpoints**: Health endpoints for all services
- **Network monitoring**: Network connectivity and isolation verification
- **Security monitoring**: Security status and compliance checking

### Maintenance Tasks
- **Regular updates**: Update base images for security patches
- **Security scans**: Regular security scans of images
- **Resource monitoring**: Monitor resource usage and adjust limits
- **Backup procedures**: Regular backup of data and configurations

## Contributing

When adding new deployment configurations:
1. Follow security best practices
2. Include comprehensive health checks
3. Document security implications
4. Test on multiple environments
5. Update this README with new features

## References

- [Distroless Images](https://github.com/GoogleContainerTools/distroless)
- [Docker Security Best Practices](https://docs.docker.com/engine/security/)
- [Multi-Stage Docker Builds](https://docs.docker.com/build/building/multi-stage/)
- [Container Security Guide](https://cheatsheetseries.owasp.org/cheatsheets/Docker_Security_Cheat_Sheet.html)
