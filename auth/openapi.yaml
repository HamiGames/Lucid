# Lucid Authentication Service - OpenAPI Specification
# Optional YAML configuration for API documentation
# File: auth/openapi.yaml
# Purpose: OpenAPI 3.0 specification for Lucid Authentication Service

openapi: 3.0.3
info:
  title: Lucid Authentication Service
  description: |
    TRON-based authentication service with hardware wallet support.
    
    Features:
    - TRON signature verification
    - Hardware wallet integration (Ledger, Trezor, KeepKey)
    - JWT token management (15min access, 7day refresh)
    - RBAC engine (4 roles: USER, NODE_OPERATOR, ADMIN, SUPER_ADMIN)
    - Session management
    - Rate limiting
    - Audit logging
  version: 1.0.0
  contact:
    name: Lucid Development Team
    email: support@lucid.example
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: http://localhost:8089
    description: Local development server
  - url: http://lucid-auth-service:8089
    description: Docker container service
  - url: https://auth.lucid.example
    description: Production server

tags:
  - name: Authentication
    description: User authentication endpoints
  - name: Users
    description: User management endpoints
  - name: Sessions
    description: Session management endpoints
  - name: Hardware Wallet
    description: Hardware wallet integration endpoints
  - name: Health
    description: Health check and service info endpoints

paths:
  /health:
    get:
      tags:
        - Health
      summary: Health check endpoint
      description: Returns service health status and dependency checks
      operationId: healthCheck
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
  
  /meta/info:
    get:
      tags:
        - Health
      summary: Service information
      description: Returns service metadata and configuration
      operationId: serviceInfo
      responses:
        '200':
          description: Service information
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ServiceInfo'
  
  /auth/login:
    post:
      tags:
        - Authentication
      summary: Login with TRON signature
      description: Authenticate user with TRON signature and receive JWT tokens
      operationId: login
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LoginResponse'
        '401':
          description: Authentication failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '429':
          description: Rate limit exceeded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  
  /auth/register:
    post:
      tags:
        - Authentication
      summary: Register new user
      description: Register new user with TRON signature verification
      operationId: register
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RegisterRequest'
      responses:
        '201':
          description: User registered successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '429':
          description: Rate limit exceeded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  
  /auth/refresh:
    post:
      tags:
        - Authentication
      summary: Refresh access token
      description: Generate new access token using refresh token
      operationId: refreshToken
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RefreshTokenRequest'
      responses:
        '200':
          description: Token refreshed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RefreshTokenResponse'
        '401':
          description: Invalid refresh token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  
  /auth/logout:
    post:
      tags:
        - Authentication
      summary: Logout user
      description: Revoke current session and blacklist tokens
      operationId: logout
      security:
        - bearerAuth: []
      responses:
        '204':
          description: Logout successful
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  
  /users/me:
    get:
      tags:
        - Users
      summary: Get current user profile
      description: Get authenticated user's profile information
      operationId: getCurrentUser
      security:
        - bearerAuth: []
      responses:
        '200':
          description: User profile
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  
  /sessions:
    get:
      tags:
        - Sessions
      summary: Get user sessions
      description: Get all active sessions for authenticated user
      operationId: getUserSessions
      security:
        - bearerAuth: []
      responses:
        '200':
          description: List of sessions
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/SessionResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  
  /hw/discover:
    get:
      tags:
        - Hardware Wallet
      summary: Discover hardware wallets
      description: Discover available hardware wallet devices
      operationId: discoverHardwareWallets
      security:
        - bearerAuth: []
      responses:
        '200':
          description: List of discovered wallets
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/HardwareWalletInfo'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  
  /hw/connect:
    post:
      tags:
        - Hardware Wallet
      summary: Connect hardware wallet
      description: Connect to a hardware wallet device
      operationId: connectHardwareWallet
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/HardwareWalletConnectRequest'
      responses:
        '200':
          description: Wallet connected successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HardwareWalletResponse'
        '400':
          description: Invalid request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token authentication
  
  schemas:
    HealthResponse:
      type: object
      properties:
        status:
          type: string
          example: "healthy"
        service:
          type: string
          example: "auth-service"
        version:
          type: string
          example: "1.0.0"
        timestamp:
          type: string
          format: date-time
        environment:
          type: string
          example: "production"
        dependencies:
          type: object
          properties:
            database:
              type: boolean
            redis:
              type: boolean
            hardware_wallet:
              type: string
    
    ServiceInfo:
      type: object
      properties:
        service_name:
          type: string
          example: "lucid-auth-service"
        cluster:
          type: string
          example: "09-authentication"
        version:
          type: string
          example: "1.0.0"
        port:
          type: integer
          example: 8089
        features:
          type: object
          properties:
            tron_signature_verification:
              type: boolean
            hardware_wallet_support:
              type: boolean
            jwt_token_management:
              type: boolean
            rbac_engine:
              type: boolean
            supported_hardware_wallets:
              type: array
              items:
                type: string
    
    LoginRequest:
      type: object
      required:
        - tron_address
        - signature
        - message
        - public_key
      properties:
        tron_address:
          type: string
          description: TRON wallet address
          example: "TLEJdVP7upjfEPpvLp9BYQvJVvqGxypNgs"
        signature:
          type: string
          description: TRON signature of the message
          example: "base58_encoded_signature"
        message:
          type: string
          description: Message that was signed
          example: "Sign this message to authenticate with Lucid: 2024-01-01T00:00:00Z"
        public_key:
          type: string
          description: Public key used for signature verification
          example: "base58_encoded_public_key"
        hardware_wallet_info:
          type: object
          description: Optional hardware wallet information
          properties:
            wallet_type:
              type: string
              enum: [ledger, trezor, keepkey]
            device_id:
              type: string
    
    LoginResponse:
      type: object
      properties:
        user_id:
          type: string
        access_token:
          type: string
          description: JWT access token (15 minutes expiry)
        refresh_token:
          type: string
          description: JWT refresh token (7 days expiry)
        token_type:
          type: string
          example: "Bearer"
        expires_in:
          type: integer
          description: Access token expiry in seconds
          example: 900
        user:
          $ref: '#/components/schemas/UserResponse'
    
    RegisterRequest:
      type: object
      required:
        - tron_address
        - signature
        - message
        - public_key
      properties:
        tron_address:
          type: string
        signature:
          type: string
        message:
          type: string
        public_key:
          type: string
        hardware_wallet_info:
          type: object
    
    RefreshTokenRequest:
      type: object
      required:
        - refresh_token
      properties:
        refresh_token:
          type: string
          description: JWT refresh token
    
    RefreshTokenResponse:
      type: object
      properties:
        access_token:
          type: string
        refresh_token:
          type: string
        token_type:
          type: string
          example: "Bearer"
        expires_in:
          type: integer
          example: 900
    
    UserResponse:
      type: object
      properties:
        user_id:
          type: string
        tron_address:
          type: string
        role:
          type: string
          enum: [USER, NODE_OPERATOR, ADMIN, SUPER_ADMIN]
        kyc_status:
          type: string
          enum: [none, pending, verified, rejected, expired]
        permissions:
          type: array
          items:
            type: string
        created_at:
          type: string
          format: date-time
        last_login:
          type: string
          format: date-time
        hardware_wallet_verified:
          type: boolean
    
    SessionResponse:
      type: object
      properties:
        session_id:
          type: string
        user_id:
          type: string
        created_at:
          type: string
          format: date-time
        expires_at:
          type: string
          format: date-time
        metadata:
          type: object
    
    HardwareWalletInfo:
      type: object
      properties:
        wallet_type:
          type: string
          enum: [ledger, trezor, keepkey]
        device_id:
          type: string
        device_path:
          type: string
        firmware_version:
          type: string
        app_version:
          type: string
        status:
          type: string
          enum: [disconnected, connecting, connected, error, locked, ready]
    
    HardwareWalletConnectRequest:
      type: object
      required:
        - wallet_type
        - device_id
      properties:
        wallet_type:
          type: string
          enum: [ledger, trezor, keepkey]
        device_id:
          type: string
        derivation_path:
          type: string
          default: "m/44'/195'/0'/0/0"
    
    HardwareWalletResponse:
      type: object
      properties:
        connected:
          type: boolean
        address:
          type: string
        device_info:
          type: object
    
    ErrorResponse:
      type: object
      properties:
        error:
          type: object
          properties:
            code:
              type: string
              example: "LUCID_ERR_2001"
            message:
              type: string
            service:
              type: string
              example: "auth-service"
            timestamp:
              type: string
              format: date-time
            details:
              type: object

