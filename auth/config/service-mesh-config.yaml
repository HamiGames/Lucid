# Lucid Authentication Service - Service Mesh Configuration
# Optional YAML configuration for service mesh integration
# File: auth/config/service-mesh-config.yaml
# Purpose: Configure service discovery, mesh communication, and service registration

# Service Mesh Global Settings
global:
  enabled: false  # Set to true to enable service mesh integration
  mesh_provider: "consul"  # Options: consul, istio, linkerd
  service_name: "lucid-auth-service"
  service_id: "lucid-auth-service-{instance_id}"
  datacenter: "lucid-dc"
  cluster: "09-authentication"

# Consul Configuration
consul:
  enabled: false
  host: "lucid-service-mesh-controller"
  port: 8500
  scheme: "http"
  token: ""  # Set via environment variable CONSUL_TOKEN
  datacenter: "lucid-dc"
  
  # Service Registration
  service_registration:
    enabled: true
    service_name: "lucid-auth-service"
    service_id: "lucid-auth-service-{hostname}"
    tags:
      - "auth"
      - "authentication"
      - "jwt"
      - "tron"
      - "hardware-wallet"
      - "cluster:09-authentication"
    meta:
      version: "1.0.0"
      environment: "{ENVIRONMENT}"
      platform: "arm64"
    
    # Health Check Configuration
    health_check:
      enabled: true
      http: "http://localhost:8089/health"
      interval: "30s"
      timeout: "10s"
      deregister_critical_service_after: "5m"
      tls_skip_verify: false
    
    # Service Address
    address: "{SERVICE_HOST}"  # Will be resolved from environment
    port: 8089
    
    # Tags for service discovery
    tags:
      - "auth"
      - "authentication"
      - "jwt"
      - "tron"
      - "hardware-wallet"
  
  # Service Discovery
  service_discovery:
    enabled: true
    services:
      - name: "lucid-mongodb"
        tags: ["database", "mongodb"]
      - name: "lucid-redis"
        tags: ["cache", "redis"]
      - name: "lucid-api-gateway"
        tags: ["gateway", "api"]
      - name: "lucid-service-mesh-controller"
        tags: ["mesh", "consul"]
  
  # Key-Value Store
  kv_store:
    enabled: true
    prefix: "lucid/auth/"
    watch_enabled: true
    watch_interval_seconds: 30

# Service Mesh Communication
communication:
  # gRPC Configuration (if using gRPC)
  grpc:
    enabled: false
    port: 50051
    max_message_size: 4194304  # 4MB
    keepalive_time_seconds: 30
    keepalive_timeout_seconds: 5
  
  # HTTP Configuration
  http:
    enabled: true
    port: 8089
    timeout_seconds: 30
    max_connections: 1000
    keepalive_timeout_seconds: 65
  
  # Circuit Breaker
  circuit_breaker:
    enabled: true
    failure_threshold: 5
    success_threshold: 2
    timeout_seconds: 60
    half_open_max_calls: 3
  
  # Retry Policy
  retry:
    enabled: true
    max_attempts: 3
    initial_delay_seconds: 1
    max_delay_seconds: 10
    backoff_multiplier: 2

# Load Balancing
load_balancing:
  enabled: true
  strategy: "round_robin"  # Options: round_robin, least_conn, random, consistent_hash
  health_check:
    enabled: true
    interval_seconds: 30
    timeout_seconds: 5
    unhealthy_threshold: 3
    healthy_threshold: 2

# Traffic Management
traffic_management:
  # Canary Deployments
  canary:
    enabled: false
    weight: 10  # Percentage of traffic to canary
    criteria:
      - header: "X-Canary"
        value: "true"
  
  # A/B Testing
  ab_testing:
    enabled: false
    variants:
      - name: "variant_a"
        weight: 50
      - name: "variant_b"
        weight: 50

# Security
security:
  # mTLS Configuration
  mtls:
    enabled: false
    cert_file: "/etc/lucid/certs/auth-service.crt"
    key_file: "/etc/lucid/certs/auth-service.key"
    ca_file: "/etc/lucid/certs/ca.crt"
  
  # Service-to-Service Authentication
  service_auth:
    enabled: true
    method: "jwt"  # Options: jwt, mTLS, api_key
    jwt_secret_env: "SERVICE_MESH_JWT_SECRET"
    required_claims:
      - "service_name"
      - "service_id"

# Observability
observability:
  # Distributed Tracing
  tracing:
    enabled: false
    provider: "jaeger"  # Options: jaeger, zipkin, datadog
    endpoint: "http://jaeger:14268/api/traces"
    sampling_rate: 0.1  # 10% of requests
  
  # Metrics
  metrics:
    enabled: true
    provider: "prometheus"
    endpoint: "/metrics"
    port: 9090
    interval_seconds: 15
  
  # Logging
  logging:
    enabled: true
    format: "json"
    level: "INFO"
    include_trace_id: true
    include_span_id: true

# Service Dependencies
dependencies:
  required:
    - name: "lucid-mongodb"
      type: "database"
      health_check: true
      retry_on_failure: true
    
    - name: "lucid-redis"
      type: "cache"
      health_check: true
      retry_on_failure: true
  
  optional:
    - name: "lucid-api-gateway"
      type: "gateway"
      health_check: true
      retry_on_failure: false
    
    - name: "lucid-service-mesh-controller"
      type: "mesh"
      health_check: true
      retry_on_failure: false

# Service Mesh Policies
policies:
  # Rate Limiting (mesh-level)
  rate_limiting:
    enabled: false
    requests_per_second: 1000
    burst_size: 100
  
  # Timeout Policies
  timeouts:
    default_timeout_seconds: 30
    per_endpoint:
      "/auth/login": 10
      "/auth/register": 15
      "/hw/connect": 30
  
  # Retry Policies
  retries:
    default_max_attempts: 3
    default_retry_on: ["5xx", "timeout"]
    per_endpoint:
      "/auth/login":
        max_attempts: 1  # No retries for login
        retry_on: []

# Service Mesh Events
events:
  # Service Registration Events
  registration:
    on_startup: true
    on_shutdown: true
    on_health_change: true
  
  # Service Discovery Events
  discovery:
    on_service_added: true
    on_service_removed: true
    on_service_health_change: true

# Configuration Reload
config_reload:
  enabled: true
  watch_config_files: true
  reload_on_change: true
  reload_interval_seconds: 30

