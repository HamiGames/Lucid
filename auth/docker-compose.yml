# Lucid Authentication Service â€“ Standalone Compose aligned with foundation/core stack

version: "3.8"

services:
  lucid-auth-service-dev:
    image: pickme/lucid-auth-service:latest-arm64
    container_name: lucid-auth-service-dev
    restart: unless-stopped
    env_file:
      - ../configs/environment/.env.foundation
      - ../configs/environment/.env.authentication
      - ../configs/environment/.env.secrets
      - ../configs/environment/.env.distroless
    networks:
      lucid-pi-network:
        ipv4_address: 172.20.0.214
    ports:
      - "18089:8089"
    working_dir: /app
    entrypoint: ["python3"]
    command: ["main.py"]
    environment:
      - LUCID_ENV=development
      - LUCID_PLATFORM=arm64
      - AUTH_SERVICE_HOST=lucid-auth-service-dev
      - AUTH_SERVICE_PORT=8089
      - AUTH_SERVICE_URL=http://lucid-auth-service-dev:8089
      - MONGODB_URI=mongodb://lucid:${MONGODB_PASSWORD}@lucid-mongodb:27017/lucid?authSource=admin
      - REDIS_URL=redis://:${REDIS_PASSWORD}@lucid-redis:6379/0
      - API_GATEWAY_URL=http://api-gateway:8080
      - CONSUL_HOST=service-mesh:8500
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
      - JWT_ALGORITHM=HS256
      - JWT_ACCESS_TOKEN_EXPIRE_MINUTES=15
      - JWT_REFRESH_TOKEN_EXPIRE_DAYS=7
      - ENABLE_HARDWARE_WALLET=true
      - LEDGER_SUPPORTED=true
      - TREZOR_SUPPORTED=true
      - KEEPKEY_SUPPORTED=true
      - TRON_NETWORK=${TRON_NETWORK:-mainnet}
    depends_on:
      lucid-mongodb:
        condition: service_healthy
      lucid-redis:
        condition: service_healthy
    user: "65532:65532"
    security_opt:
      - no-new-privileges:true
      - seccomp:unconfined
    cap_drop: ["ALL"]
    cap_add: ["NET_BIND_SERVICE"]
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=100m
    volumes:
      - /mnt/myssd/Lucid/Lucid/logs/auth:/app/logs:rw
      - auth-dev-cache:/tmp/auth
    healthcheck:
      test:
        [
          "CMD",
          "python3",
          "-c",
          'import urllib.request; urllib.request.urlopen("http://localhost:8089/health").read()',
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Optional local MongoDB for dev (renamed to avoid collisions)
  lucid-auth-mongodb-dev:
    image: mongo:7.0
    container_name: lucid-auth-mongodb-dev
    restart: unless-stopped
    env_file:
      - ../configs/environment/.env.foundation
    networks:
      lucid-pi-network:
        ipv4_address: 172.20.0.215
    ports:
      - "27018:27017"
    environment:
      - MONGO_INITDB_ROOT_USERNAME=lucid
      - MONGO_INITDB_ROOT_PASSWORD=${MONGODB_PASSWORD}
      - MONGO_INITDB_DATABASE=lucid_auth
    command: ["mongod", "--auth", "--bind_ip_all"]
    volumes:
      - mongodb-dev-data:/data/db
      - ./scripts/init-mongodb.js:/docker-entrypoint-initdb.d/init.js:ro
    healthcheck:
      test: ["CMD-SHELL", "mongosh --quiet --eval 'db.runCommand({ ping: 1 })'"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Optional local Redis for dev (renamed to avoid collisions)
  lucid-auth-redis-dev:
    image: redis:7.0-alpine
    container_name: lucid-auth-redis-dev
    restart: unless-stopped
    env_file:
      - ../configs/environment/.env.foundation
    networks:
      lucid-pi-network:
        ipv4_address: 172.20.0.216
    ports:
      - "6380:6379"
    command:
      - redis-server
      - --appendonly
      - "yes"
    volumes:
      - redis-dev-data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3

networks:
  lucid-pi-network:
    external: true
    name: lucid-pi-network

volumes:
  auth-dev-cache:
    driver: local
    name: lucid-auth-dev-cache
  mongodb-dev-data:
    driver: local
    name: lucid-auth-dev-mongodb-data
  redis-dev-data:
    driver: local
    name: lucid-auth-dev-redis-data
