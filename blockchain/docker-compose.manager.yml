name: lucid-block-manager
services:
  block-manager:
    image: pickme/lucid-block-manager:latest-arm64
    container_name: block-manager
    restart: unless-stopped
    env_file:
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.secrets
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.foundation
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.core
    networks:
      - lucid-pi-network
    ports:
      - "8086:8086"
    volumes:
      - /mnt/myssd/Lucid/Lucid/data/block-manager:/app/data:rw
      - /mnt/myssd/Lucid/Lucid/logs/block-manager:/app/logs:rw
      - block-manager-cache:/tmp/blocks
    environment:
      - LUCID_ENV=production
      - LUCID_PLATFORM=arm64
      - BLOCK_MANAGER_HOST=block-manager
      - BLOCK_MANAGER_PORT=8086
      - BLOCK_MANAGER_URL=http://block-manager:8086
      - MONGODB_URL=${MONGODB_URL:?MONGODB_URL not set}
      - REDIS_URL=${REDIS_URL:?REDIS_URL not set}
      - BLOCKCHAIN_ENGINE_URL=${BLOCKCHAIN_ENGINE_URL:?BLOCKCHAIN_ENGINE_URL not set}
      - AUTH_SERVICE_URL=${AUTH_SERVICE_URL:-http://lucid-auth-service:8089}
      - BLOCKCHAIN_SECRET_KEY=${BLOCKCHAIN_SECRET_KEY:?BLOCKCHAIN_SECRET_KEY not set}
      - BLOCK_STORAGE_PATH=${BLOCK_STORAGE_PATH:-/app/data/blocks}
      - SYNC_TIMEOUT=${SYNC_TIMEOUT:-30}
    user: "65532:65532"
    security_opt:
      - no-new-privileges:true
      - seccomp:unconfined
    cap_drop:
      - ALL
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=100m
    healthcheck:
      test:
        [
          "CMD",
          "/usr/bin/python3.11",
          "-c",
          "import urllib.request; urllib.request.urlopen('http://localhost:8086/health', timeout=5).read(); exit(0)",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    labels:
      - "lucid.service=block-manager"
      - "lucid.type=distroless"
      - "lucid.platform=arm64"
      - "lucid.security=hardened"
      - "lucid.cluster=core"
    depends_on:
      lucid-mongodb:
        condition: service_healthy
      lucid-redis:
        condition: service_healthy
      lucid-auth-service:
        condition: service_healthy
      blockchain-engine:
        condition: service_healthy

networks:
  lucid-pi-network:
    external: true
    name: lucid-pi-network

volumes:
  block-manager-cache:
    driver: local
    name: lucid-block-manager-cache

