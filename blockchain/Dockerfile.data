# Multi-stage build for distroless container
# File: blockchain/Dockerfile.data
# Purpose: Distroless container build for Lucid Data Chain Service
# Build Host: Windows 11 console
# Target Host: Raspberry Pi (via SSH)
# Phase 2: Blockchain Core Cluster - Data Chain Service

FROM python:3.11-slim as builder

# Set build arguments
ARG BUILDPLATFORM
ARG TARGETPLATFORM
ARG BUILD_DATE
ARG VERSION=1.0.0
ARG GIT_COMMIT=unknown

# Install build dependencies
RUN apt-get update && apt-get install -y \
    build-essential \
    gcc \
    g++ \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Set working directory
WORKDIR /app

# Copy requirements and install dependencies
COPY requirements.txt .
RUN pip install --no-cache-dir --user -r requirements.txt

# Copy data chain source code
COPY data/ ./data/
COPY core/ ./core/
COPY utils/ ./utils/
COPY config/ ./config/

# Create non-root user
RUN useradd --create-home --shell /bin/bash app

# Production stage - Distroless
FROM gcr.io/distroless/python3-debian12

# Set labels for Phase 2 compliance
LABEL maintainer="Lucid Development Team"
LABEL description="Lucid Data Chain - Phase 2 Distroless Container"
LABEL version="1.0.0"
LABEL build_date="${BUILD_DATE}"
LABEL git_commit="${GIT_COMMIT}"
LABEL phase="2"
LABEL cluster="02-blockchain-core"
LABEL service="data-chain"

# Copy Python packages from builder
COPY --from=builder /root/.local /home/app/.local

# Copy application code
COPY --from=builder /app/data /app/data
COPY --from=builder /app/core /app/core
COPY --from=builder /app/utils /app/utils
COPY --from=builder /app/config /app/config

# Set working directory
WORKDIR /app

# Set Python path and environment
ENV PYTHONPATH=/app
ENV PATH=/home/app/.local/bin:$PATH
ENV SERVICE_NAME=data-chain
ENV PORT=8087
ENV LOG_LEVEL=INFO
ENV CHUNK_STORAGE_PATH=/data/chunks
ENV MERKLE_STORAGE_PATH=/data/merkle

# Create app user (distroless has no useradd, using nonroot user)
USER 65532:65532

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD ["python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8087/health')"]

# Expose ports
EXPOSE 8087

# Start application
CMD ["python", "-m", "data.main"]
