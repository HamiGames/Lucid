# Lucid Session Anchoring Service - Anchoring Policies Configuration
# Optional YAML configuration for session anchoring rules
# File: blockchain/config/anchoring-policies.yaml
# Purpose: Define anchoring rules, verification policies, and data integrity checks

# Global Anchoring Configuration
global:
  enabled: true
  anchoring_method: "merkle_tree"  # Options: merkle_tree, direct_hash, batch_anchor
  verification_enabled: true
  auto_anchor_on_session_complete: true

# Anchoring Rules
anchoring_rules:
  # Session Metadata Anchoring
  session_metadata:
    enabled: true
    anchor_on_create: false
    anchor_on_update: true
    anchor_on_complete: true
    required_fields:
      - "session_id"
      - "owner_address"
      - "created_at"
      - "status"
    optional_fields:
      - "participants"
      - "metadata"
      - "tags"

  # Session Chunk Anchoring
  session_chunks:
    enabled: true
    anchor_individual_chunks: false
    batch_anchor_enabled: true
    batch_size: 100
    batch_timeout_seconds: 300
    required_fields:
      - "chunk_id"
      - "session_id"
      - "chunk_hash"
      - "chunk_index"
    verify_chunk_integrity: true

  # Merkle Tree Anchoring
  # ALIGNED WITH: blockchain/core/merkle_tree_builder.py, blockchain/utils/crypto.py
  merkle_tree:
    enabled: true
    tree_depth: 20  # ALIGNED: blockchain/core/merkle_tree_builder.py:31 (MERKLE_TREE_HEIGHT_MAX = 20)
    leaf_hash_algorithm: "blake3"  # ALIGNED: blockchain/core/merkle_tree_builder.py:32
    root_hash_algorithm: "blake3"  # ALIGNED: blockchain/utils/crypto.py:28
    anchor_root_only: true
    include_proof_paths: true
    proof_verification_enabled: true

# Verification Policies
verification:
  # On-Chain Verification
  on_chain:
    enabled: true
    verify_after_anchor: true
    verification_timeout_seconds: 60
    require_confirmation_blocks: 6
    retry_verification_on_failure: true
    max_verification_retries: 3

  # Off-Chain Verification
  off_chain:
    enabled: true
    verify_merkle_proofs: true
    verify_chunk_hashes: true
    verify_session_integrity: true
    cache_verification_results: true
    cache_ttl_seconds: 3600

# Data Integrity Checks
integrity_checks:
  # Hash Verification
  # ALIGNED WITH: blockchain/utils/crypto.py
  hash_verification:
    enabled: true
    verify_chunk_hashes: true
    verify_merkle_root: true
    verify_session_metadata_hash: true
    hash_algorithm: "blake3"  # ALIGNED: blockchain/utils/crypto.py:28 (HASH_ALGORITHM = "blake3")

  # Signature Verification
  signature_verification:
    enabled: true
    require_owner_signature: true
    verify_participant_signatures: false
    signature_algorithm: "ECDSA"

  # Timestamp Validation
  timestamp_validation:
    enabled: true
    validate_created_at: true
    validate_updated_at: true
    validate_completed_at: true
    timestamp_tolerance_seconds: 300

# Anchoring Frequency and Batching
batching:
  enabled: true
  batch_size: 100
  batch_timeout_seconds: 300
  max_batch_wait_seconds: 600
  priority_anchoring:
    enabled: true
    high_priority_sessions: []
    immediate_anchor_roles: ["ADMIN", "SUPER_ADMIN"]

# Storage Configuration
storage:
  # On-Chain Storage
  # ALIGNED WITH: blockchain/blockchain_anchor.py
  on_chain:
    enabled: true
    store_metadata: true
    store_merkle_root: true
    store_chunk_hashes: false  # Only store root, not individual hashes
    gas_limit_per_anchor: 90000  # ALIGNED: blockchain/blockchain_anchor.py:99 (0x15F90 = 90000)
    max_gas_price: 1000000000  # 1 Gwei (ALIGNED: blockchain/blockchain_anchor.py:100, blockchain/on_system_chain/chain_client.py:108)

  # Off-Chain Storage
  off_chain:
    enabled: true
    store_full_chunks: true
    store_merkle_proofs: true
    storage_backend: "mongodb"  # Options: mongodb, ipfs, s3
    compression_enabled: true

# Error Handling and Recovery
error_handling:
  # Retry Policies
  retry:
    enabled: true
    max_retries: 3
    retry_delay_seconds: 5
    exponential_backoff: true
    backoff_multiplier: 2

  # Failure Handling
  failure:
    log_failures: true
    notify_on_failure: false
    fallback_storage: "off_chain"
    queue_failed_anchors: true
    retry_failed_anchors: true
    max_retry_attempts: 5

# Performance Optimization
performance:
  # Async Processing
  async_processing:
    enabled: true
    max_concurrent_anchors: 10
    queue_size: 1000
    worker_threads: 4

  # Caching
  caching:
    enabled: true
    cache_merkle_roots: true
    cache_verification_results: true
    cache_ttl_seconds: 3600
    max_cache_size_mb: 500

# Monitoring and Metrics
monitoring:
  enabled: true
  metrics:
    - "anchoring_success_rate"
    - "anchoring_latency"
    - "verification_success_rate"
    - "merkle_tree_construction_time"
    - "on_chain_confirmation_time"
    - "failed_anchors_count"

  alerts:
    anchoring_failure_rate_threshold: 0.05  # 5%
    anchoring_latency_threshold_seconds: 60
    verification_failure_rate_threshold: 0.01  # 1%

# Security Configuration
security:
  # Access Control
  access_control:
    require_authentication: true
    require_authorization: true
    allowed_roles: ["USER", "NODE_OPERATOR", "ADMIN", "SUPER_ADMIN"]
    owner_only_operations: ["anchor", "verify"]

  # Data Privacy
  privacy:
    encrypt_sensitive_data: false
    mask_pii_in_logs: true
    audit_log_enabled: true
    audit_log_retention_days: 90

