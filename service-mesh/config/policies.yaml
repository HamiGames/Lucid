# Lucid Service Mesh - Policy Configuration
# File: service-mesh/config/policies.yaml
# Purpose: Traffic management and security policies
# All values reference environment variables from .env.* files

policies:
  # Retry policies
  retry:
    default:
      max_attempts: ${RETRY_DEFAULT_MAX_ATTEMPTS:-3}
      per_try_timeout: ${RETRY_DEFAULT_PER_TRY_TIMEOUT:-10s}
      retry_on:
        - connect-failure
        - refused-stream
        - unavailable
        - cancelled
        - retriable-4xx
        - reset
        - gateway-error
      backoff:
        base_interval: ${RETRY_DEFAULT_BASE_INTERVAL:-100ms}
        max_interval: ${RETRY_DEFAULT_MAX_INTERVAL:-10s}
        
    critical_services:
      max_attempts: ${RETRY_CRITICAL_MAX_ATTEMPTS:-5}
      per_try_timeout: ${RETRY_CRITICAL_PER_TRY_TIMEOUT:-30s}
      retry_on:
        - connect-failure
        - refused-stream
        - unavailable
      backoff:
        base_interval: ${RETRY_CRITICAL_BASE_INTERVAL:-500ms}
        max_interval: ${RETRY_CRITICAL_MAX_INTERVAL:-30s}

  # Timeout policies
  timeout:
    default:
      connect_timeout: ${TIMEOUT_DEFAULT_CONNECT:-5s}
      request_timeout: ${TIMEOUT_DEFAULT_REQUEST:-30s}
      idle_timeout: ${TIMEOUT_DEFAULT_IDLE:-300s}
      
    database:
      connect_timeout: ${TIMEOUT_DATABASE_CONNECT:-10s}
      request_timeout: ${TIMEOUT_DATABASE_REQUEST:-60s}
      idle_timeout: ${TIMEOUT_DATABASE_IDLE:-600s}
      
    streaming:
      connect_timeout: ${TIMEOUT_STREAMING_CONNECT:-5s}
      request_timeout: ${TIMEOUT_STREAMING_REQUEST:-0s}
      idle_timeout: ${TIMEOUT_STREAMING_IDLE:-3600s}

  # Circuit breaker policies
  circuit_breaker:
    default:
      consecutive_gateway_failure: ${CB_DEFAULT_GATEWAY_FAILURE:-5}
      consecutive_5xx: ${CB_DEFAULT_5XX:-5}
      interval: ${CB_DEFAULT_INTERVAL:-10s}
      base_ejection_time: ${CB_DEFAULT_EJECTION_TIME:-30s}
      max_ejection_percent: ${CB_DEFAULT_MAX_EJECTION:-50}
      
    strict:
      consecutive_gateway_failure: ${CB_STRICT_GATEWAY_FAILURE:-3}
      consecutive_5xx: ${CB_STRICT_5XX:-3}
      interval: ${CB_STRICT_INTERVAL:-5s}
      base_ejection_time: ${CB_STRICT_EJECTION_TIME:-60s}
      max_ejection_percent: ${CB_STRICT_MAX_EJECTION:-100}

  # Rate limiting policies
  rate_limit:
    default:
      requests_per_unit: ${RATE_LIMIT_DEFAULT_REQUESTS:-1000}
      unit: ${RATE_LIMIT_DEFAULT_UNIT:-MINUTE}
      
    api_gateway:
      requests_per_unit: ${RATE_LIMIT_GATEWAY_REQUESTS:-10000}
      unit: ${RATE_LIMIT_GATEWAY_UNIT:-MINUTE}
      
    auth_service:
      requests_per_unit: ${RATE_LIMIT_AUTH_REQUESTS:-100}
      unit: ${RATE_LIMIT_AUTH_UNIT:-MINUTE}

  # Load balancing policies
  load_balancing:
    default:
      policy: ${LB_DEFAULT_POLICY:-ROUND_ROBIN}
      
    sticky_sessions:
      policy: ${LB_STICKY_POLICY:-RING_HASH}
      hash_key: ${LB_STICKY_HASH_KEY:-x-session-id}
      
    least_connections:
      policy: ${LB_LEAST_CONN_POLICY:-LEAST_REQUEST}

  # mTLS policies
  mtls:
    default:
      mode: ${MTLS_DEFAULT_MODE:-STRICT}
      min_protocol_version: ${MTLS_MIN_PROTOCOL:-TLSv1_2}
      cipher_suites:
        - ECDHE-RSA-AES256-GCM-SHA384
        - ECDHE-RSA-AES128-GCM-SHA256
        
    permissive:
      mode: ${MTLS_PERMISSIVE_MODE:-PERMISSIVE}
      min_protocol_version: ${MTLS_PERMISSIVE_MIN_PROTOCOL:-TLSv1_2}

# Service-specific policy assignments
service_policies:
  api-gateway:
    retry: ${API_GATEWAY_RETRY_POLICY:-default}
    timeout: ${API_GATEWAY_TIMEOUT_POLICY:-default}
    circuit_breaker: ${API_GATEWAY_CB_POLICY:-default}
    rate_limit: ${API_GATEWAY_RATE_LIMIT_POLICY:-api_gateway}
    load_balancing: ${API_GATEWAY_LB_POLICY:-default}
    mtls: ${API_GATEWAY_MTLS_POLICY:-default}
    
  auth-service:
    retry: ${AUTH_RETRY_POLICY:-critical_services}
    timeout: ${AUTH_TIMEOUT_POLICY:-default}
    circuit_breaker: ${AUTH_CB_POLICY:-strict}
    rate_limit: ${AUTH_RATE_LIMIT_POLICY:-auth_service}
    load_balancing: ${AUTH_LB_POLICY:-default}
    mtls: ${AUTH_MTLS_POLICY:-default}
    
  lucid-mongodb:
    retry: ${MONGODB_RETRY_POLICY:-critical_services}
    timeout: ${MONGODB_TIMEOUT_POLICY:-database}
    circuit_breaker: ${MONGODB_CB_POLICY:-default}
    load_balancing: ${MONGODB_LB_POLICY:-default}
    mtls: ${MONGODB_MTLS_POLICY:-permissive}
    
  lucid-redis:
    retry: ${REDIS_RETRY_POLICY:-default}
    timeout: ${REDIS_TIMEOUT_POLICY:-default}
    circuit_breaker: ${REDIS_CB_POLICY:-default}
    load_balancing: ${REDIS_LB_POLICY:-default}
    mtls: ${REDIS_MTLS_POLICY:-permissive}
    
  blockchain-engine:
    retry: ${BLOCKCHAIN_ENGINE_RETRY_POLICY:-critical_services}
    timeout: ${BLOCKCHAIN_ENGINE_TIMEOUT_POLICY:-default}
    circuit_breaker: ${BLOCKCHAIN_ENGINE_CB_POLICY:-strict}
    load_balancing: ${BLOCKCHAIN_ENGINE_LB_POLICY:-default}
    mtls: ${BLOCKCHAIN_ENGINE_MTLS_POLICY:-default}
