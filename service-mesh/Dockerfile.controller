# Multi-stage build for distroless container
# File: service-mesh/Dockerfile.controller
# Purpose: Distroless container build for Lucid Service Mesh Controller
# Build Host: Windows 11 console
# Target Host: Raspberry Pi (via SSH)
# Phase 3: Proper distroless implementation

FROM python:3.11-slim as builder

# Set build arguments
ARG BUILDPLATFORM
ARG TARGETPLATFORM
ARG BUILD_DATE
ARG VERSION=1.0.0
ARG GIT_COMMIT=unknown

# Install build dependencies
RUN apt-get update && apt-get install -y \
    build-essential \
    gcc \
    g++ \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Set working directory
WORKDIR /app

# Copy requirements and install dependencies
COPY infrastructure/service-mesh/requirements.txt .
RUN pip install --no-cache-dir --user -r requirements.txt

# Copy service mesh controller source code
COPY infrastructure/service-mesh/controller/ ./controller/
COPY infrastructure/service-mesh/sidecar/ ./sidecar/
COPY infrastructure/service-mesh/discovery/ ./discovery/
COPY infrastructure/service-mesh/communication/ ./communication/
COPY infrastructure/service-mesh/security/ ./security/

# Production stage - Distroless
FROM gcr.io/distroless/python3-debian12

# Set labels for Phase 3 compliance
LABEL maintainer="Lucid Development Team"
LABEL description="Lucid Service Mesh Controller - Phase 3 Distroless Container"
LABEL version="1.0.0"
LABEL build_date="${BUILD_DATE}"
LABEL git_commit="${GIT_COMMIT}"
LABEL phase="3"
LABEL cluster="10-cross-cluster-integration"
LABEL service="service-mesh-controller"

# Copy Python packages from builder to distroless location
COPY --from=builder /root/.local /usr/local

# Copy application code
COPY --from=builder /app/controller /app/controller
COPY --from=builder /app/sidecar /app/sidecar
COPY --from=builder /app/discovery /app/discovery
COPY --from=builder /app/communication /app/communication
COPY --from=builder /app/security /app/security

# Set working directory
WORKDIR /app

# Set Python path and environment
ENV PYTHONPATH=/app
ENV PATH=/usr/local/bin:$PATH
ENV SERVICE_NAME=service-mesh-controller
ENV PORT=8500
ENV LOG_LEVEL=INFO
ENV SERVICE_DISCOVERY_URL=http://consul:8500
ENV SERVICE_MESH_ENABLED=true

# Use nonroot user (distroless default)
USER 65532:65532

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD ["/usr/bin/python3", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8500/health')"]

# Expose ports
EXPOSE 8500

# Start application
CMD ["/usr/bin/python3", "-m", "controller.main"]
