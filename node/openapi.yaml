openapi: 3.0.3
info:
  title: Lucid Node Management API
  description: |
    REST API for managing worker nodes, pools, PoOT operations, and payouts in the Lucid system.
    
    Features:
    - Node lifecycle management (CRUD operations)
    - Node pool management and assignment
    - PoOT (Proof of Operational Time) calculation and validation
    - Payout processing and threshold management
    - Resource monitoring and metrics collection
    - Health checks and system status
  version: 1.0.0
  contact:
    name: Lucid Development Team
    email: dev@lucid-blockchain.org
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: http://node-management:8095
    description: Docker container service (internal)
  - url: http://localhost:8095
    description: Local development server

tags:
  - name: Health
    description: Health check and service info endpoints
  - name: Nodes
    description: Node management endpoints
  - name: Pools
    description: Node pool management endpoints
  - name: PoOT
    description: Proof of Operational Time endpoints
  - name: Payouts
    description: Payout processing endpoints
  - name: Metrics
    description: System metrics and monitoring endpoints

paths:
  /:
    get:
      tags:
        - Health
      summary: Root endpoint
      description: Returns service information
      operationId: root
      responses:
        '200':
          description: Service information
          content:
            application/json:
              schema:
                type: object
                properties:
                  service:
                    type: string
                    example: node-management
                  status:
                    type: string
                    example: running

  /health:
    get:
      tags:
        - Health
      summary: Health check endpoint
      description: Returns service health status and basic information
      operationId: healthCheck
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
        '503':
          description: Service is unhealthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /metrics:
    get:
      tags:
        - Metrics
      summary: Get system metrics
      description: Returns Prometheus-compatible metrics
      operationId: getMetrics
      responses:
        '200':
          description: System metrics
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MetricsResponse'

  /nodes:
    get:
      tags:
        - Nodes
      summary: List all nodes
      description: List all nodes, optionally filtered by pool and status
      operationId: listNodes
      parameters:
        - name: pool_id
          in: query
          description: Filter by pool ID
          required: false
          schema:
            type: string
        - name: status
          in: query
          description: Filter by node status
          required: false
          schema:
            type: string
      responses:
        '200':
          description: List of nodes
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/NodeInfo'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /nodes/{node_id}:
    get:
      tags:
        - Nodes
      summary: Get node by ID
      description: Get specific node information
      operationId: getNode
      parameters:
        - name: node_id
          in: path
          description: Node ID
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Node information
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/NodeInfo'
        '404':
          description: Node not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /nodes/{node_id}/join-pool:
    post:
      tags:
        - Nodes
      summary: Add node to pool
      description: Add a node to a specific pool
      operationId: joinPool
      parameters:
        - name: node_id
          in: path
          description: Node ID
          required: true
          schema:
            type: string
        - name: pool_id
          in: query
          description: Pool ID to join
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Node added to pool
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /nodes/{node_id}/leave-pool:
    post:
      tags:
        - Nodes
      summary: Remove node from pool
      description: Remove a node from a specific pool
      operationId: leavePool
      parameters:
        - name: node_id
          in: path
          description: Node ID
          required: true
          schema:
            type: string
        - name: pool_id
          in: query
          description: Pool ID to leave
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Node removed from pool
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /pools:
    get:
      tags:
        - Pools
      summary: List all pools
      description: List all node pools
      operationId: listPools
      responses:
        '200':
          description: List of pools
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/PoolInfo'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    post:
      tags:
        - Pools
      summary: Create new pool
      description: Create a new node pool
      operationId: createPool
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                pool_name:
                  type: string
                max_nodes:
                  type: integer
      responses:
        '200':
          description: Pool created
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                  pool_id:
                    type: string
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /pools/{pool_id}:
    get:
      tags:
        - Pools
      summary: Get pool by ID
      description: Get specific pool information
      operationId: getPool
      parameters:
        - name: pool_id
          in: path
          description: Pool ID
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Pool information
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PoolInfo'
        '404':
          description: Pool not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /poot/{node_id}:
    get:
      tags:
        - PoOT
      summary: Get PoOT proof for node
      description: Get PoOT proof for a specific node
      operationId: getPoOTProof
      parameters:
        - name: node_id
          in: path
          description: Node ID
          required: true
          schema:
            type: string
      responses:
        '200':
          description: PoOT proof
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PoOTProof'
        '404':
          description: PoOT proof not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    post:
      tags:
        - PoOT
      summary: Calculate PoOT for node
      description: Trigger PoOT calculation for a specific node
      operationId: calculatePoOT
      parameters:
        - name: node_id
          in: path
          description: Node ID
          required: true
          schema:
            type: string
      responses:
        '200':
          description: PoOT calculation started
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /poot/calculate-all:
    get:
      tags:
        - PoOT
      summary: Calculate PoOT for all nodes
      description: Trigger PoOT calculation for all nodes
      operationId: calculateAllPoOT
      responses:
        '200':
          description: PoOT calculation started for all nodes
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /payouts:
    get:
      tags:
        - Payouts
      summary: List all payouts
      description: List all payouts, optionally filtered by status
      operationId: listPayouts
      parameters:
        - name: status
          in: query
          description: Filter by payout status
          required: false
          schema:
            type: string
      responses:
        '200':
          description: List of payouts
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/PayoutInfo'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /payouts/{payout_id}:
    get:
      tags:
        - Payouts
      summary: Get payout by ID
      description: Get specific payout information
      operationId: getPayout
      parameters:
        - name: payout_id
          in: path
          description: Payout ID
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Payout information
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PayoutInfo'
        '404':
          description: Payout not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /payouts/process:
    post:
      tags:
        - Payouts
      summary: Process pending payouts
      description: Process all pending payouts that meet the threshold
      operationId: processPayouts
      responses:
        '200':
          description: Payout processing started
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /payouts/threshold:
    get:
      tags:
        - Payouts
      summary: Get payout threshold
      description: Get the current payout threshold in USDT
      operationId: getPayoutThreshold
      responses:
        '200':
          description: Payout threshold
          content:
            application/json:
              schema:
                type: object
                properties:
                  threshold_usdt:
                    type: number
                    format: float
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  schemas:
    HealthResponse:
      type: object
      required:
        - status
        - service
        - version
        - timestamp
      properties:
        status:
          type: string
          enum: [healthy]
          description: Health status of the service
          example: healthy
        service:
          type: string
          description: Service identifier
          example: node-management
        version:
          type: string
          description: Service version
          example: "1.0.0"
          pattern: '^\d+\.\d+\.\d+$'
        timestamp:
          type: string
          format: date-time
          description: ISO 8601 timestamp of the health check
          example: "2025-01-27T12:00:00Z"
        active_nodes:
          type: integer
          description: Number of active nodes
          minimum: 0
          example: 5
        max_nodes_per_pool:
          type: integer
          description: Maximum nodes per pool
          minimum: 1
          example: 100
        payout_threshold_usdt:
          type: number
          format: float
          description: Payout threshold in USDT
          minimum: 0
          example: 10.0
      additionalProperties: false

    MetricsResponse:
      type: object
      required:
        - timestamp
      properties:
        node_metrics:
          type: object
          description: Node metrics
        pool_metrics:
          type: object
          description: Pool metrics
        timestamp:
          type: string
          format: date-time
          description: ISO 8601 timestamp
          example: "2025-01-27T12:00:00Z"

    NodeInfo:
      $ref: './node-schema.json#/definitions/NodeInfo'
    
    NodeMetrics:
      $ref: './node-schema.json#/definitions/NodeMetrics'

    PoolInfo:
      $ref: './pool-schema.json#/definitions/PoolInfo'
    
    PoolMetrics:
      $ref: './pool-schema.json#/definitions/PoolMetrics'

    PoOTProof:
      $ref: './poot-schema.json#/definitions/PoOTProof'

    PayoutInfo:
      $ref: './payout-schema.json#/definitions/PayoutInfo'
    
    PayoutStatistics:
      $ref: './payout-schema.json#/definitions/PayoutStatistics'

    ErrorResponse:
      type: object
      required:
        - detail
      properties:
        detail:
          type: string
          description: Error message
          example: "Node not found"

