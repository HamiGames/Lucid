# XRDP Service Monitoring Configuration
# File: RDP/xrdp/config/monitoring-config.yaml
# Purpose: Prometheus metrics, alerting rules, and monitoring setup for rdp-xrdp container

# Prometheus Metrics Configuration
prometheus:
  enabled: true
  port: 9090
  path: "/metrics"
  scrape_interval: 30s
  scrape_timeout: 10s
  
  # Metric labels
  labels:
    service: "rdp-xrdp"
    cluster: "application"
    platform: "arm64"
    environment: "production"

# Metrics Definitions
metrics:
  # Process Metrics
  process_metrics:
    - name: "xrdp_processes_total"
      type: "counter"
      description: "Total number of XRDP processes started"
      labels: ["status"]
    
    - name: "xrdp_processes_active"
      type: "gauge"
      description: "Number of currently active XRDP processes"
      labels: []
    
    - name: "xrdp_process_uptime_seconds"
      type: "gauge"
      description: "Uptime of individual XRDP processes in seconds"
      labels: ["process_id"]
    
    - name: "xrdp_process_memory_bytes"
      type: "gauge"
      description: "Memory usage of XRDP processes in bytes"
      labels: ["process_id"]
    
    - name: "xrdp_process_cpu_percent"
      type: "gauge"
      description: "CPU usage of XRDP processes (percentage)"
      labels: ["process_id"]
  
  # Configuration Metrics
  config_metrics:
    - name: "xrdp_config_creations_total"
      type: "counter"
      description: "Total number of XRDP configurations created"
      labels: ["status"]
    
    - name: "xrdp_config_validations_total"
      type: "counter"
      description: "Total number of XRDP configurations validated"
      labels: ["status"]
    
    - name: "xrdp_config_cleanups_total"
      type: "counter"
      description: "Total number of XRDP configurations cleaned up"
      labels: ["status"]
  
  # API Metrics
  api_metrics:
    - name: "xrdp_api_requests_total"
      type: "counter"
      description: "Total number of API requests"
      labels: ["endpoint", "method", "status_code"]
    
    - name: "xrdp_api_request_duration_seconds"
      type: "histogram"
      description: "API request duration in seconds"
      labels: ["endpoint", "method"]
      buckets: [0.005, 0.01, 0.025, 0.05, 0.1, 0.25, 0.5, 1.0, 2.5, 5.0, 10.0]
    
    - name: "xrdp_api_errors_total"
      type: "counter"
      description: "Total number of API errors"
      labels: ["endpoint", "method", "error_type"]
  
  # Health Metrics
  health_metrics:
    - name: "xrdp_health_check_total"
      type: "counter"
      description: "Total number of health checks"
      labels: ["status"]
    
    - name: "xrdp_service_uptime_seconds"
      type: "gauge"
      description: "Service uptime in seconds"
      labels: []

# Alerting Rules
alerts:
  # Process Alerts
  - name: "XRDPProcessHighFailureRate"
    condition: "rate(xrdp_processes_total{status='failed'}[5m]) > 0.1"
    severity: "warning"
    description: "XRDP process failure rate is high"
    duration: "5m"
    annotations:
      summary: "High XRDP process failure rate"
      description: "XRDP process failure rate is {{ $value }} failures per second"
  
  - name: "XRDPProcessMaxReached"
    condition: "xrdp_processes_active >= 10"
    severity: "critical"
    description: "Maximum number of XRDP processes reached"
    duration: "1m"
    annotations:
      summary: "Maximum XRDP processes reached"
      description: "Current active processes: {{ $value }}, Maximum: 10"
  
  - name: "XRDPProcessHighMemoryUsage"
    condition: "xrdp_process_memory_bytes > 536870912"
    severity: "warning"
    description: "XRDP process using excessive memory (>512MB)"
    duration: "5m"
    annotations:
      summary: "XRDP process high memory usage"
      description: "Process {{ $labels.process_id }} is using {{ $value }} bytes"
  
  - name: "XRDPProcessHighCPUUsage"
    condition: "xrdp_process_cpu_percent > 80"
    severity: "warning"
    description: "XRDP process using excessive CPU (>80%)"
    duration: "5m"
    annotations:
      summary: "XRDP process high CPU usage"
      description: "Process {{ $labels.process_id }} is using {{ $value }}% CPU"
  
  # API Alerts
  - name: "XRDPAPIHighErrorRate"
    condition: "rate(xrdp_api_errors_total[5m]) > 0.05"
    severity: "warning"
    description: "XRDP API error rate is high"
    duration: "5m"
    annotations:
      summary: "High XRDP API error rate"
      description: "API error rate is {{ $value }} errors per second"
  
  - name: "XRDPAPISlowResponse"
    condition: "histogram_quantile(0.95, xrdp_api_request_duration_seconds) > 2.0"
    severity: "warning"
    description: "XRDP API response time is slow (p95 > 2s)"
    duration: "5m"
    annotations:
      summary: "Slow XRDP API response time"
      description: "95th percentile response time is {{ $value }} seconds"
  
  # Health Alerts
  - name: "XRDPServiceUnhealthy"
    condition: "xrdp_health_check_total{status='unhealthy'} > 0"
    severity: "critical"
    description: "XRDP service is unhealthy"
    duration: "1m"
    annotations:
      summary: "XRDP service unhealthy"
      description: "Service health check failed"
  
  - name: "XRDPServiceDown"
    condition: "up{job='rdp-xrdp'} == 0"
    severity: "critical"
    description: "XRDP service is down"
    duration: "1m"
    annotations:
      summary: "XRDP service down"
      description: "Service is not responding to metrics scraping"

# Service Discovery
service_discovery:
  type: "static_configs"
  static_configs:
    - targets: ["rdp-xrdp:9090"]
      labels:
        job: "rdp-xrdp"
        cluster: "application"
        platform: "arm64"

# Logging Integration
logging:
  enabled: true
  level: "INFO"
  format: "json"
  fields:
    - "timestamp"
    - "level"
    - "service"
    - "message"
    - "process_id"
    - "endpoint"
    - "method"
    - "status_code"
    - "duration_ms"
    - "error"

# Tracing (if applicable)
tracing:
  enabled: false
  exporter: "jaeger"
  endpoint: "http://jaeger:14268/api/traces"
  sample_rate: 0.1

