# Lucid GUI API Bridge - Rate Limiting Configuration
# File: gui-api-bridge/config/rate-limit-config.yaml
# Purpose: Define rate limiting tiers, endpoint-specific limits, and bypass rules
# Aligned with 03-api-gateway/config/rate-limit-config.yaml

# Global Rate Limiting Configuration
global:
  enabled: true
  strategy: "sliding_window"  # Options: sliding_window, token_bucket, fixed_window
  redis_key_prefix: "ratelimit:gui-bridge"
  default_limit: 1000  # requests per minute
  default_burst: 200
  storage_backend: "redis"  # Options: redis, memory

# Rate Limit Tiers
tiers:
  public:
    description: "Unauthenticated users"
    requests_per_minute: 100
    burst_limit: 20
    window_seconds: 60
    penalty_seconds: 60

  authenticated:
    description: "Authenticated regular users"
    requests_per_minute: 1000
    burst_limit: 100
    window_seconds: 60
    penalty_seconds: 30

  developer:
    description: "Developer users"
    requests_per_minute: 5000
    burst_limit: 500
    window_seconds: 60
    penalty_seconds: 15

  node_operator:
    description: "Node operators"
    requests_per_minute: 5000
    burst_limit: 500
    window_seconds: 60
    penalty_seconds: 15

  admin:
    description: "Administrators"
    requests_per_minute: 10000
    burst_limit: 1000
    window_seconds: 60
    penalty_seconds: 0

  super_admin:
    description: "Super administrators"
    requests_per_minute: -1  # Unlimited
    burst_limit: -1
    window_seconds: 60
    penalty_seconds: 0

# Endpoint-Specific Rate Limits
endpoints:
  # Health Check Endpoints (No limits)
  "/health":
    tier: "public"
    requests_per_minute: -1
    burst_limit: -1

  "/api/v1":
    tier: "public"
    requests_per_minute: 1000
    burst_limit: 100
    window_seconds: 60

  # User Endpoints
  "/api/v1/user/profile":
    tier: "authenticated"
    requests_per_minute: 100
    burst_limit: 10
    window_seconds: 60

  "/api/v1/user/sessions":
    tier: "authenticated"
    requests_per_minute: 100
    burst_limit: 10
    window_seconds: 60

  "/api/v1/user/sessions/*/recover":
    tier: "authenticated"
    requests_per_minute: 50
    burst_limit: 5
    window_seconds: 60
    block_after_exceeded: true
    block_duration_seconds: 300

  # Developer Endpoints
  "/api/v1/developer/status":
    tier: "developer"
    requests_per_minute: 500
    burst_limit: 50
    window_seconds: 60

  "/api/v1/developer/sessions/*/recover":
    tier: "developer"
    requests_per_minute: 200
    burst_limit: 20
    window_seconds: 60

  # Node Operator Endpoints
  "/api/v1/node/status":
    tier: "node_operator"
    requests_per_minute: 500
    burst_limit: 50
    window_seconds: 60

  "/api/v1/node/earnings":
    tier: "node_operator"
    requests_per_minute: 100
    burst_limit: 10
    window_seconds: 60

  # Admin Endpoints
  "/api/v1/admin/status":
    tier: "admin"
    requests_per_minute: 1000
    burst_limit: 100
    window_seconds: 60

  "/api/v1/admin/services":
    tier: "admin"
    requests_per_minute: 100
    burst_limit: 10
    window_seconds: 60

  "/api/v1/admin/sessions/*/recover":
    tier: "admin"
    requests_per_minute: 500
    burst_limit: 50
    window_seconds: 60

  # WebSocket Endpoints (No rate limits - handled separately)
  "/ws":
    tier: "authenticated"
    requests_per_minute: -1
    burst_limit: -1

# IP-Based Rate Limiting
ip_limits:
  enabled: true
  default_limit: 500  # requests per minute per IP
  default_burst: 100
  whitelist:
    - "127.0.0.1"
    - "::1"
    - "172.20.0.0/16"  # Internal network
  blacklist: []

# User-Based Rate Limiting
user_limits:
  enabled: true
  default_limit: 1000  # requests per minute per user
  default_burst: 100
  per_role_limits:
    USER: 1000
    DEVELOPER: 5000
    NODE_OPERATOR: 5000
    ADMIN: 10000
    SUPER_ADMIN: -1  # Unlimited

# Rate Limit Headers
headers:
  enabled: true
  include_limit: true
  include_remaining: true
  include_reset: true
  include_retry_after: true

# Rate Limit Response Configuration
response:
  status_code: 429
  error_code: "LUCID_ERR_3001"
  message_template: "Rate limit exceeded. Maximum {limit} requests per {window} allowed."
  include_details: true
  include_retry_after: true

# Bypass Rules
bypass:
  enabled: true
  conditions:
    - type: "ip_whitelist"
      values: ["127.0.0.1", "::1", "172.20.0.0/16"]
    - type: "role"
      values: ["SUPER_ADMIN"]
    - type: "endpoint"
      values: ["/health", "/api/v1"]

# Monitoring and Alerting
monitoring:
  enabled: true
  log_exceeded: true
  alert_threshold: 0.8  # Alert when 80% of limit reached
  alert_channels:
    - "log"
    - "metrics"

# Rate Limit Storage
storage:
  backend: "redis"
  key_ttl_seconds: 120
  cleanup_interval_seconds: 300
