# Lucid Session Pipeline - Pipeline Configuration
# Optional YAML configuration for session pipeline orchestration
# File: sessions/config/pipeline-config.yaml
# Purpose: Define pipeline stages, worker configuration, and processing rules
# NOTE: All service URLs, ports, and database connections must be provided via
# environment variables from docker-compose.application.yml. Values here are
# documentation of expected environment variables and optional overrides.

# Global Pipeline Configuration
global:
  service_name: "lucid-pipeline-manager"
  service_version: "1.0.0"
  # Service host and port come from: SESSION_PIPELINE_HOST, SESSION_PIPELINE_PORT
  # Defaults documented for reference only
  debug: false
  log_level: "INFO"  # Override with LOG_LEVEL env var
  max_concurrent_sessions: 100
  pipeline_timeout_seconds: 300

# Pipeline Stages Configuration (6 states as per Step 15)
stages:
  recorder:
    enabled: true
    priority: 1
    dependencies: []
    workers:
      count: 2
      buffer_size: 1000
      timeout_seconds: 60
      retry_count: 3
      max_memory_mb: 1024
    config:
      frame_rate: 30
      resolution: "1920x1080"
      quality: "high"
      bitrate: "2000k"
      audio_enabled: true
      cursor_enabled: true

  chunk_generator:
    enabled: true
    priority: 2
    dependencies:
      - "recorder"
    workers:
      count: 3
      buffer_size: 800
      timeout_seconds: 45
      retry_count: 3
      max_memory_mb: 768
    config:
      chunk_size_mb: 10
      chunk_overlap_bytes: 0
      preserve_boundaries: true

  compressor:
    enabled: true
    priority: 3
    dependencies:
      - "chunk_generator"
    workers:
      count: 4
      buffer_size: 500
      timeout_seconds: 30
      retry_count: 3
      max_memory_mb: 512
    config:
      compression_algorithm: "zstd"  # Options: zstd, gzip, lz4
      compression_level: 6
      compression_threshold_bytes: 1024

  encryptor:
    enabled: true
    priority: 4
    dependencies:
      - "compressor"
    workers:
      count: 4
      buffer_size: 500
      timeout_seconds: 30
      retry_count: 3
      max_memory_mb: 512
    config:
      encryption_algorithm: "AES-256-GCM"
      key_rotation_interval_seconds: 3600
      key_derivation_iterations: 100000

  merkle_builder:
    enabled: true
    priority: 5
    dependencies:
      - "encryptor"
    workers:
      count: 2
      buffer_size: 300
      timeout_seconds: 20
      retry_count: 3
      max_memory_mb: 256
    config:
      hash_algorithm: "SHA256"
      tree_type: "binary"
      batch_size: 100
      include_proof_paths: true

  storage:
    enabled: true
    priority: 6
    dependencies:
      - "merkle_builder"
    workers:
      count: 2
      buffer_size: 100
      timeout_seconds: 60
      retry_count: 3
      max_memory_mb: 1024
    config:
      storage_backend: "mongodb"  # Options: mongodb, filesystem, s3
      # Storage paths come from volumes mounted in docker-compose
      storage_path: "/app/data/sessions"
      chunk_storage_path: "/app/data/chunks"
      max_storage_size_gb: 1000
      retention_days: 30

# Performance Configuration
performance:
  enable_compression: true
  enable_encryption: true
  enable_deduplication: true
  parallel_processing: true
  batch_processing: true
  batch_size: 100
  batch_timeout_seconds: 5

# Quality Configuration
quality:
  default_quality: "high"  # Options: low, medium, high, ultra
  default_frame_rate: 30
  default_resolution: "1920x1080"
  quality_threshold: 0.8
  quality_validation: true

# Network Configuration
# NOTE: Host and port MUST come from environment variables:
# - SESSION_PIPELINE_HOST (default: session-pipeline)
# - SESSION_PIPELINE_PORT (default: 8083)
# - SESSION_PIPELINE_URL (default: http://session-pipeline:8083)
network:
  host: "0.0.0.0"  # Bind address (always 0.0.0.0 in container)
  port: 8083  # Override with SESSION_PIPELINE_PORT env var
  grpc_port: 9087

# Database Configuration
# NOTE: Database URLs MUST come from environment variables:
# - MONGODB_URL (required, from .env.secrets)
# - REDIS_URL (from .env.core or .env.secrets)
# - ELASTICSEARCH_URL (from .env.core or .env.secrets)
# Values below are for documentation only - actual values come from env vars
database:
  mongodb_url: ""  # Set via MONGODB_URL env var (required)
  redis_url: ""    # Set via REDIS_URL env var
  elasticsearch_url: ""  # Set via ELASTICSEARCH_URL env var

# Monitoring Configuration
monitoring:
  metrics_enabled: true
  metrics_port: 9093
  health_check_interval: 30  # seconds
  prometheus_enabled: true
  jaeger_enabled: false
  jaeger_endpoint: null

# Error Handling
error_handling:
  retry_policies:
    max_retries: 3
    retry_delay_seconds: 1
    exponential_backoff: true
    backoff_multiplier: 2
  
  failure_handling:
    log_failures: true
    notify_on_failure: false
    queue_failed_items: true
    retry_failed_items: true
    max_retry_attempts: 5

# State Machine Configuration
state_machine:
  enabled: true
  state_transitions:
    - from: "recording"
      to: "chunking"
      condition: "chunk_size_reached"
    - from: "chunking"
      to: "compressing"
      condition: "chunk_ready"
    - from: "compressing"
      to: "encrypting"
      condition: "compression_complete"
    - from: "encrypting"
      to: "merkle_building"
      condition: "encryption_complete"
    - from: "merkle_building"
      to: "storing"
      condition: "merkle_complete"
    - from: "storing"
      to: "completed"
      condition: "storage_complete"