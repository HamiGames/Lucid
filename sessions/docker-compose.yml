# sessions/docker-compose.yml
# Lucid session services â€“ production spin-up

version: "3.8"

services:
  lucid-session-recorder:
    image: pickme/lucid-session-recorder:latest-arm64
    container_name: lucid-session-recorder
    restart: unless-stopped
    env_file:
      - ../configs/environment/.env.foundation
      - ../configs/environment/.env.core
      - ../configs/environment/.env.application
      - ../configs/environment/.env.secrets
    environment:
      - LUCID_ENV=production
      - LUCID_PLATFORM=arm64
      - PROJECT_ROOT=/mnt/myssd/Lucid/Lucid
      - SESSION_RECORDER_PORT=8090
      - SESSION_RECORDER_URL=http://lucid-session-recorder:8090
      - MONGODB_URI=mongodb://lucid:${MONGODB_PASSWORD}@lucid-mongodb:27017/lucid?authSource=admin
      - REDIS_URL=redis://:${REDIS_PASSWORD}@lucid-redis:6379/0
      - API_GATEWAY_URL=http://lucid-api-gateway:8080
    ports:
      - "8090:8090"
    networks:
      lucid-pi-network:
        ipv4_address: 172.20.0.30
    volumes:
      - session-recordings:/data/recordings
      - session-logs:/app/logs
    depends_on:
      lucid-mongodb:
        condition: service_healthy
      lucid-redis:
        condition: service_healthy
    user: "65532:65532"
    security_opt:
      - no-new-privileges:true
      - seccomp:unconfined
    cap_drop: ["ALL"]
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=200m
    healthcheck:
      test: ["CMD", "python3", "-c", "import sys; sys.exit(0)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  lucid-chunk-processor:
    image: pickme/lucid-chunk-processor:latest-arm64
    container_name: lucid-chunk-processor
    restart: unless-stopped
    env_file:
      - ../configs/environment/.env.foundation
      - ../configs/environment/.env.core
      - ../configs/environment/.env.application
      - ../configs/environment/.env.secrets
      - ../sessions/core/.env.chunker
    environment:
      - LUCID_ENV=production
      - LUCID_PLATFORM=arm64
      - PROJECT_ROOT=/mnt/myssd/Lucid/Lucid
      - CHUNK_PROCESSOR_PORT=8091
      - CHUNK_PROCESSOR_URL=http://lucid-chunk-processor:8091
      - MONGODB_URI=mongodb://lucid:${MONGODB_PASSWORD}@lucid-mongodb:27017/lucid?authSource=admin
      - REDIS_URL=redis://:${REDIS_PASSWORD}@lucid-redis:6379/0
      - SESSION_RECORDER_URL=http://lucid-session-recorder:8090
    ports:
      - "8091:8091"
    networks:
      lucid-pi-network:
        ipv4_address: 172.20.0.31
    volumes:
      - session-chunks:/data/chunks
      - chunk-logs:/app/logs
    depends_on:
      lucid-session-recorder:
        condition: service_healthy
      lucid-mongodb:
        condition: service_healthy
      lucid-redis:
        condition: service_healthy
    user: "65532:65532"
    security_opt:
      - no-new-privileges:true
      - seccomp:unconfined
    cap_drop: ["ALL"]
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=200m
    healthcheck:
      test: ["CMD", "python3", "-c", "import sys; sys.exit(0)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  lucid-session-storage:
    image: pickme/lucid-session-storage:latest-arm64
    container_name: lucid-session-storage
    restart: unless-stopped
    env_file:
      - ../configs/environment/.env.foundation
      - ../configs/environment/.env.core
      - ../configs/environment/.env.application
      - ../configs/environment/.env.secrets
    environment:
      - LUCID_ENV=production
      - LUCID_PLATFORM=arm64
      - PROJECT_ROOT=/mnt/myssd/Lucid/Lucid
      - SESSION_STORAGE_PORT=8082
      - SESSION_STORAGE_HOST=0.0.0.0
      - SESSION_STORAGE_URL=http://lucid-session-storage:8082
      - MONGODB_URI=mongodb://lucid:${MONGODB_PASSWORD}@lucid-mongodb:27017/lucid?authSource=admin
      - REDIS_URL=redis://:${REDIS_PASSWORD}@lucid-redis:6379/0
      - ELASTICSEARCH_URI=http://lucid-elasticsearch:9200
    ports:
      - "8082:8082"
    networks:
      lucid-pi-network:
        ipv4_address: 172.20.0.32
    volumes:
      - session-storage-data:/data/sessions
      - session-encrypted-data:/data/encrypted
      - session-storage-logs:/app/logs
    depends_on:
      lucid-mongodb:
        condition: service_healthy
      lucid-redis:
        condition: service_healthy
      lucid-elasticsearch:
        condition: service_healthy
    user: "65532:65532"
    security_opt:
      - no-new-privileges:true
      - seccomp:unconfined
    cap_drop: ["ALL"]
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=200m
    healthcheck:
      test: ["CMD", "/usr/bin/python3.11", "-c", "import socket; s = socket.socket(); s.settimeout(2); result = s.connect_ex(('127.0.0.1', 8082)); s.close(); exit(0 if result == 0 else 1)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  lucid-session-api:
    image: pickme/lucid-session-api:latest-arm64
    container_name: lucid-session-api
    restart: unless-stopped
    env_file:
      - ../configs/environment/.env.foundation
      - ../configs/environment/.env.core
      - ../configs/environment/.env.application
      - ../configs/environment/.env.secrets
    environment:
      - LUCID_ENV=production
      - LUCID_PLATFORM=arm64
      - PROJECT_ROOT=/mnt/myssd/Lucid/Lucid
      - SESSION_API_PORT=8087
      - SESSION_API_URL=http://lucid-session-api:8087
      - MONGODB_URI=mongodb://lucid:${MONGODB_PASSWORD}@lucid-mongodb:27017/lucid?authSource=admin
      - REDIS_URL=redis://:${REDIS_PASSWORD}@lucid-redis:6379/0
      - SESSION_RECORDER_URL=http://lucid-session-recorder:8090
      - SESSION_STORAGE_URL=http://lucid-session-storage:8082
      - API_GATEWAY_URL=http://lucid-api-gateway:8080
    ports:
      - "8087:8087"
    networks:
      lucid-pi-network:
        ipv4_address: 172.20.0.33
      lucid-gui-network:
        ipv4_address: 172.22.0.33
    volumes:
      - session-api-logs:/app/logs
      - session-readonly-data:/data/sessions:ro
    depends_on:
      lucid-session-recorder:
        condition: service_healthy
      lucid-session-storage:
        condition: service_healthy
      lucid-mongodb:
        condition: service_healthy
      lucid-redis:
        condition: service_healthy
    user: "65532:65532"
    security_opt:
      - no-new-privileges:true
      - seccomp:unconfined
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=100m
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8087/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

networks:
  lucid-pi-network:
    external: true
    name: lucid-pi-network
  lucid-gui-network:
    external: true
    name: lucid-gui-network

volumes:
  session-recordings:
    name: lucid-session-recordings
  session-logs:
    name: lucid-session-logs
  session-chunks:
    name: lucid-session-chunks
  chunk-logs:
    name: lucid-chunk-processor-logs
  session-storage-data:
    name: lucid-session-storage-data
  session-encrypted-data:
    name: lucid-session-encrypted-data
  session-storage-logs:
    name: lucid-session-storage-logs
  session-api-logs:
    name: lucid-session-api-logs
  session-readonly-data:
    name: lucid-session-api-data
