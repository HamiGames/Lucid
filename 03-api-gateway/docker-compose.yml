# 03-api-gateway/docker-compose.yml
# Lucid API Gateway â€“ relies on foundation MongoDB/Redis and tor-proxy
# Aligned with @constants: TOR_PROXY_* env vars, onion-state volume
# SECURITY NOTE: All sensitive variables are loaded from .env files, not exposed here

version: "3.8"

services:
  lucid-api-gateway:
    image: pickme/lucid-api-gateway:latest-arm64
    container_name: lucid-api-gateway
    restart: unless-stopped
    env_file:
      - ../configs/environment/.env.foundation
      - ../configs/environment/.env.tor-proxy
      - ../configs/environment/.env.api-gateway
      - ../configs/environment/.env.secrets
    ports:
      - "${HTTP_PORT:-8080}:8080"
    environment:
      # Service Identification
      - SERVICE_NAME=lucid-api-gateway
      - SERVICE_VERSION=${SERVICE_VERSION:-1.0.0}
      - API_VERSION=${API_VERSION:-v1}
      - ENVIRONMENT=${ENVIRONMENT:-production}
      - LUCID_PLATFORM=${LUCID_PLATFORM:-arm64}
      - HTTP_PORT=${HTTP_PORT:-8080}
      - HOST=${HOST:-0.0.0.0}
    networks:
      lucid-pi-network:
        ipv4_address: ${API_GATEWAY_IP:-172.20.0.18}
    volumes:
      - api-gateway-certs:/certs:ro
      - api-gateway-logs:/app/logs
      - ./config/rate-limit-config.yaml:/app/config/rate-limit-config.yaml:ro
      - ./config/routing-config.yaml:/app/config/routing-config.yaml:ro
    healthcheck:
      test:
        [
          "CMD",
          "python3",
          "-c",
          "import urllib.request; urllib.request.urlopen('http://localhost:8080/api/v1/meta/health', timeout=5)",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    # Depend on tor-proxy for outbound connections, and foundation services
    depends_on:
      tor-proxy:
        condition: service_healthy
      lucid-mongodb:
        condition: service_healthy
      lucid-redis:
        condition: service_healthy
    labels:
      - "lucid.service=lucid-api-gateway"
      - "lucid.type=distroless"
      - "lucid.platform=arm64"
      - "lucid.cluster=application"

networks:
  lucid-pi-network:
    external: true
    name: lucid-pi-network

volumes:
  api-gateway-certs:
    name: lucid-api-gateway-certs
  api-gateway-logs:
    name: lucid-api-gateway-logs
