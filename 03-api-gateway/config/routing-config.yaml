# Lucid API Gateway - Routing Configuration
# Optional YAML configuration for API Gateway routing rules
# File: 03-api-gateway/config/routing-config.yaml
# Purpose: Define routing rules, upstream services, and load balancing

# Global Routing Configuration
global:
  default_timeout_seconds: 30
  max_retries: 3
  retry_delay_seconds: 1
  health_check_interval_seconds: 30
  circuit_breaker_enabled: true
  circuit_breaker_failure_threshold: 5
  circuit_breaker_success_threshold: 2
  circuit_breaker_timeout_seconds: 60

# Upstream Services Configuration
upstream_services:
  auth_service:
    url: "http://lucid-auth-service:8089"
    timeout_seconds: 30
    max_connections: 1000
    health_check:
      enabled: true
      path: "/health"
      interval_seconds: 30
      timeout_seconds: 5
      unhealthy_threshold: 3
      healthy_threshold: 2
    load_balancing:
      strategy: "round_robin"  # Options: round_robin, least_conn, ip_hash, random
      weight: 100
    retry:
      enabled: true
      max_attempts: 3
      retry_on: ["5xx", "timeout", "connect_failure"]
      backoff_multiplier: 2

  blockchain_engine:
    url: "http://blockchain-engine:8084"
    timeout_seconds: 60
    max_connections: 500
    health_check:
      enabled: true
      path: "/health"
      interval_seconds: 30
    load_balancing:
      strategy: "round_robin"
      weight: 100
    retry:
      enabled: true
      max_attempts: 3
      retry_on: ["5xx", "timeout"]

  session_anchoring:
    url: "http://session-anchoring:8085"
    timeout_seconds: 45
    max_connections: 500
    health_check:
      enabled: true
      path: "/health"
      interval_seconds: 30
    load_balancing:
      strategy: "round_robin"
      weight: 100

  block_manager:
    url: "http://block-manager:8086"
    timeout_seconds: 45
    max_connections: 500
    health_check:
      enabled: true
      path: "/health"
      interval_seconds: 30
    load_balancing:
      strategy: "round_robin"
      weight: 100

  data_chain:
    url: "http://data-chain:8087"
    timeout_seconds: 60
    max_connections: 500
    health_check:
      enabled: true
      path: "/health"
      interval_seconds: 30
    load_balancing:
      strategy: "round_robin"
      weight: 100

  session_api:
    url: "http://lucid-session-api:8087"
    timeout_seconds: 30
    max_connections: 1000
    health_check:
      enabled: true
      path: "/health"
      interval_seconds: 30
    load_balancing:
      strategy: "round_robin"
      weight: 100

  tron_payment:
    url: "http://tron-client:8091"
    timeout_seconds: 60
    max_connections: 200
    health_check:
      enabled: true
      path: "/health"
      interval_seconds: 30
    load_balancing:
      strategy: "round_robin"
      weight: 100

# Route Definitions
routes:
  # Authentication Routes
  - path: "/api/v1/auth/*"
    upstream: "auth_service"
    methods: ["GET", "POST", "PUT", "DELETE", "PATCH"]
    authentication_required: false
    rate_limit:
      enabled: true
      requests_per_minute: 100
      burst_size: 20
    timeout_seconds: 30

  # Blockchain Routes
  - path: "/api/v1/blockchain/*"
    upstream: "blockchain_engine"
    methods: ["GET", "POST", "PUT"]
    authentication_required: true
    rate_limit:
      enabled: true
      requests_per_minute: 500
      burst_size: 50
    timeout_seconds: 60

  # Session Anchoring Routes
  - path: "/api/v1/anchoring/*"
    upstream: "session_anchoring"
    methods: ["GET", "POST"]
    authentication_required: true
    rate_limit:
      enabled: true
      requests_per_minute: 300
      burst_size: 30
    timeout_seconds: 45

  # Block Manager Routes
  - path: "/api/v1/blocks/*"
    upstream: "block_manager"
    methods: ["GET", "POST"]
    authentication_required: true
    rate_limit:
      enabled: true
      requests_per_minute: 300
      burst_size: 30
    timeout_seconds: 45

  # Data Chain Routes
  - path: "/api/v1/data-chain/*"
    upstream: "data_chain"
    methods: ["GET", "POST", "PUT"]
    authentication_required: true
    rate_limit:
      enabled: true
      requests_per_minute: 500
      burst_size: 50
    timeout_seconds: 60

  # Session Management Routes
  - path: "/api/v1/sessions/*"
    upstream: "session_api"
    methods: ["GET", "POST", "PUT", "DELETE"]
    authentication_required: true
    rate_limit:
      enabled: true
      requests_per_minute: 1000
      burst_size: 100
    timeout_seconds: 30

  # TRON Payment Routes
  - path: "/api/v1/payments/*"
    upstream: "tron_payment"
    methods: ["GET", "POST"]
    authentication_required: true
    rate_limit:
      enabled: true
      requests_per_minute: 200
      burst_size: 20
    timeout_seconds: 60

  # Health Check Routes (No upstream)
  - path: "/health"
    upstream: null
    methods: ["GET"]
    authentication_required: false
    rate_limit:
      enabled: false
    timeout_seconds: 5

  - path: "/api/v1/meta/*"
    upstream: null
    methods: ["GET"]
    authentication_required: false
    rate_limit:
      enabled: false
    timeout_seconds: 5

# Path Rewriting Rules
path_rewrites:
  - pattern: "^/api/v1/auth/(.*)"
    replacement: "/auth/$1"
    upstream: "auth_service"
  
  - pattern: "^/api/v1/blockchain/(.*)"
    replacement: "/api/v1/blockchain/$1"
    upstream: "blockchain_engine"
  
  - pattern: "^/api/v1/anchoring/(.*)"
    replacement: "/api/v1/anchoring/$1"
    upstream: "session_anchoring"
  
  - pattern: "^/api/v1/blocks/(.*)"
    replacement: "/api/v1/blocks/$1"
    upstream: "block_manager"
  
  - pattern: "^/api/v1/data-chain/(.*)"
    replacement: "/api/v1/data-chain/$1"
    upstream: "data_chain"
  
  - pattern: "^/api/v1/sessions/(.*)"
    replacement: "/api/v1/sessions/$1"
    upstream: "session_api"
  
  - pattern: "^/api/v1/payments/(.*)"
    replacement: "/api/v1/payments/$1"
    upstream: "tron_payment"

# Request/Response Transformation
transformations:
  request_headers:
    - name: "X-Forwarded-For"
      value: "$remote_addr"
    - name: "X-Real-IP"
      value: "$remote_addr"
    - name: "X-Forwarded-Proto"
      value: "$scheme"
    - name: "X-Request-ID"
      value: "$request_id"
  
  response_headers:
    - name: "X-Request-ID"
      value: "$request_id"
    - name: "X-Service-Name"
      value: "api-gateway"
    - name: "X-Upstream-Service"
      value: "$upstream_service"

# Caching Configuration
caching:
  enabled: true
  default_ttl_seconds: 300
  max_cache_size_mb: 100
  cache_key_strategy: "path_and_query"
  cacheable_methods: ["GET"]
  cacheable_paths:
    - "/api/v1/meta/*"
    - "/api/v1/blockchain/info"
    - "/api/v1/blockchain/status"
  no_cache_headers:
    - "Authorization"
    - "X-No-Cache"

# Security Headers
security_headers:
  enabled: true
  headers:
    - name: "X-Content-Type-Options"
      value: "nosniff"
    - name: "X-Frame-Options"
      value: "DENY"
    - name: "X-XSS-Protection"
      value: "1; mode=block"
    - name: "Strict-Transport-Security"
      value: "max-age=31536000; includeSubDomains"
    - name: "Content-Security-Policy"
      value: "default-src 'self'"

# Error Handling
error_handling:
  default_error_pages:
    404: "/errors/404.html"
    500: "/errors/500.html"
    502: "/errors/502.html"
    503: "/errors/503.html"
    504: "/errors/504.html"
  
  error_response_format: "json"
  include_stack_trace: false
  log_errors: true

# Monitoring and Observability
monitoring:
  enabled: true
  metrics:
    enabled: true
    endpoint: "/metrics"
    include_upstream_metrics: true
  
  tracing:
    enabled: false
    provider: "jaeger"
    endpoint: "http://jaeger:14268/api/traces"
    sampling_rate: 0.1
  
  logging:
    enabled: true
    format: "json"
    level: "INFO"
    include_request_body: false
    include_response_body: false
    sensitive_headers: ["Authorization", "Cookie", "X-Auth-Token"]

