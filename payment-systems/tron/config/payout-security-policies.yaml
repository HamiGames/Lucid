# LUCID TRON Payout Router - Security Policies Configuration
# File: payment-systems/tron/config/payout-security-policies.yaml
# Purpose: Role-based access control, approval workflows, and compliance rules

# Role-Based Access Control (RBAC)
rbac:
  roles:
    USER:
      description: "Standard user - can only request payouts"
      permissions:
        - "payout:create:own"
        - "payout:list:own"
        - "payout:cancel:own"
        - "payout:view:own"
      rate_limits:
        requests_per_hour: 10
        payouts_per_day: 5
        max_amount_per_payout: 1000.0
        max_daily_total: 5000.0
    
    NODE_OPERATOR:
      description: "Node operator - can manage payouts for nodes"
      permissions:
        - "payout:create:node"
        - "payout:list:node"
        - "payout:cancel:node"
        - "payout:view:node"
        - "payout:route:direct"
        - "payout:batch:create"
      rate_limits:
        requests_per_hour: 100
        payouts_per_day: 50
        max_amount_per_payout: 10000.0
        max_daily_total: 100000.0
    
    APPROVER:
      description: "Approver - can approve high-value payouts"
      permissions:
        - "payout:approve"
        - "payout:reject"
        - "payout:view:all"
        - "payout:list:all"
      rate_limits:
        requests_per_hour: 500
        payouts_per_day: unlimited
        max_amount_per_payout: unlimited
        max_daily_total: unlimited
    
    ADMIN:
      description: "Admin - full payout system access"
      permissions:
        - "payout:*"
        - "batch:*"
        - "route:*"
        - "compliance:*"
      rate_limits:
        requests_per_hour: unlimited
        payouts_per_day: unlimited
        max_amount_per_payout: unlimited
        max_daily_total: unlimited
    
    SUPER_ADMIN:
      description: "Super admin - system-wide access"
      permissions:
        - "*"
      rate_limits:
        requests_per_hour: unlimited
        payouts_per_day: unlimited
        max_amount_per_payout: unlimited
        max_daily_total: unlimited

# Approval Workflows
approval_workflows:
  default:
    name: "Standard Approval Workflow"
    description: "Standard approval for regular payouts"
    stages:
      - stage: 1
        name: "validation"
        description: "Automatic validation of payout"
        required_approvals: 0
        timeout_minutes: 5
      
      - stage: 2
        name: "processing"
        description: "Transaction processing"
        required_approvals: 0
        timeout_minutes: 30
      
      - stage: 3
        name: "confirmation"
        description: "Blockchain confirmation"
        required_approvals: 0
        timeout_minutes: 60
  
  high_value:
    name: "High-Value Approval Workflow"
    description: "Approval required for high-value payouts"
    amount_threshold: 5000.0
    stages:
      - stage: 1
        name: "validation"
        description: "Automatic validation of payout"
        required_approvals: 0
        timeout_minutes: 5
      
      - stage: 2
        name: "approval"
        description: "Manual approval required"
        required_approvals: 1
        required_roles: ["APPROVER", "ADMIN"]
        timeout_minutes: 30
      
      - stage: 3
        name: "processing"
        description: "Transaction processing"
        required_approvals: 0
        timeout_minutes: 30
      
      - stage: 4
        name: "confirmation"
        description: "Blockchain confirmation"
        required_approvals: 0
        timeout_minutes: 60
  
  batch:
    name: "Batch Approval Workflow"
    description: "Approval for batch payouts"
    batch_size_threshold: 20
    stages:
      - stage: 1
        name: "validation"
        description: "Batch validation and aggregation"
        required_approvals: 0
        timeout_minutes: 10
      
      - stage: 2
        name: "approval"
        description: "Batch approval"
        required_approvals: 1
        required_roles: ["APPROVER", "ADMIN"]
        timeout_minutes: 60
      
      - stage: 3
        name: "processing"
        description: "Batch transaction processing"
        required_approvals: 0
        timeout_minutes: 60
      
      - stage: 4
        name: "confirmation"
        description: "Batch confirmation"
        required_approvals: 0
        timeout_minutes: 120
  
  emergency:
    name: "Emergency Payout Workflow"
    description: "Fast-track approval for emergency situations"
    stages:
      - stage: 1
        name: "validation"
        description: "Fast validation"
        required_approvals: 0
        timeout_minutes: 1
      
      - stage: 2
        name: "approval"
        description: "Emergency approval"
        required_approvals: 2
        required_roles: ["ADMIN", "SUPER_ADMIN"]
        timeout_minutes: 5
      
      - stage: 3
        name: "processing"
        description: "Emergency processing"
        required_approvals: 0
        timeout_minutes: 15
      
      - stage: 4
        name: "confirmation"
        description: "Confirmation"
        required_approvals: 0
        timeout_minutes: 30

# Compliance Rules
compliance:
  aml:
    enabled: true
    provider: "internal"
    check_recipient: true
    check_sender: true
    check_patterns: true
    
    # Amount-based AML triggers
    triggers:
      - amount_threshold: 10000.0
        action: "require_kyc"
        description: "KYC required for amounts over 10000 USDT"
      
      - amount_threshold: 50000.0
        action: "require_approval"
        description: "Approval required for amounts over 50000 USDT"
      
      - amount_threshold: 100000.0
        action: "manual_review"
        description: "Manual review required for amounts over 100000 USDT"
    
    # Pattern-based AML triggers
    patterns:
      - pattern: "multiple_rapid_payouts"
        threshold: 10
        window_minutes: 60
        action: "alert"
        description: "Alert on 10+ payouts in 1 hour"
      
      - pattern: "circular_payouts"
        threshold: 5
        window_hours: 24
        action: "manual_review"
        description: "Manual review for circular payment patterns"
      
      - pattern: "sanctions_list_match"
        threshold: 1
        action: "block"
        description: "Block if recipient matches sanctions list"
  
  kyc:
    enabled: true
    required_for_amounts: 10000.0
    cache_valid_days: 365
    
    verification_levels:
      basic:
        description: "Basic KYC - name and address"
        required_fields: ["full_name", "address"]
        valid_days: 180
      
      enhanced:
        description: "Enhanced KYC - additional identity verification"
        required_fields: ["full_name", "address", "id_document", "photo"]
        valid_days: 365
      
      advanced:
        description: "Advanced KYC - full PEP and source of funds checks"
        required_fields: ["full_name", "address", "id_document", "photo", "source_of_funds"]
        valid_days: 180

# Transaction Monitoring
transaction_monitoring:
  enabled: true
  
  rules:
    - rule_id: "high_frequency"
      description: "High frequency transaction check"
      threshold: 100
      window_minutes: 60
      action: "alert"
      severity: "warning"
    
    - rule_id: "large_amount"
      description: "Large amount transaction check"
      threshold: 50000.0
      action: "manual_review"
      severity: "high"
    
    - rule_id: "unusual_recipient"
      description: "Transaction to unusual recipient"
      checks:
        - new_recipient_first_time: true
        - recipient_not_in_whitelist: true
      action: "alert"
      severity: "warning"
    
    - rule_id: "velocity_check"
      description: "Rapid succession transactions"
      threshold: 5
      window_minutes: 10
      action: "manual_review"
      severity: "high"

# Audit and Logging
audit:
  enabled: true
  log_level: "detailed"
  
  log_events:
    - "payout:create"
    - "payout:approve"
    - "payout:reject"
    - "payout:cancel"
    - "payout:execute"
    - "payout:confirm"
    - "payout:fail"
    - "batch:create"
    - "batch:approve"
    - "batch:execute"
    - "compliance:check"
    - "aml:alert"
    - "kyc:verify"
    - "approval:grant"
    - "approval:deny"
  
  retention_policy:
    days: 90
    archive_location: "/data/audit-archive"
    encryption_enabled: true

# Rate Limiting
rate_limiting:
  enabled: true
  
  limits:
    # API rate limits
    api_requests_per_second: 100
    api_requests_per_minute: 1000
    
    # Payout creation limits (per user)
    payout_create_per_minute: 10
    payout_create_per_hour: 50
    payout_create_per_day: 100
    
    # Batch limits
    batch_create_per_hour: 10
    batch_max_size: 100
    
    # Route limits
    route_requests_per_minute: 50
    
  # Bypass conditions
  bypass:
    - role: "ADMIN"
    - role: "SUPER_ADMIN"

# IP Whitelisting
ip_whitelist:
  enabled: false
  
  allowed_ips:
    - "127.0.0.1"
    - "::1"
  
  # Add production IPs as needed
  # - "xxx.xxx.xxx.xxx"

# JWT/Token Security
token_security:
  algorithm: "HS256"
  expiration_minutes: 60
  refresh_window_minutes: 10
  
  claims_validation:
    required: ["sub", "role", "iat", "exp"]
    check_aud: false
  
  signature_verification: true
  revocation_check: true

# Encryption
encryption:
  enabled: true
  algorithm: "AES-256-GCM"
  key_rotation_days: 90
  
  fields_to_encrypt:
    - "payout.recipient_address"
    - "payout.transaction_hash"
    - "batch.payout_ids"

# Security Headers
security_headers:
  "X-Content-Type-Options": "nosniff"
  "X-Frame-Options": "DENY"
  "X-XSS-Protection": "1; mode=block"
  "Strict-Transport-Security": "max-age=31536000; includeSubDomains"
  "Content-Security-Policy": "default-src 'self'"
  "Referrer-Policy": "strict-origin-when-cross-origin"

# CORS Security
cors:
  enabled: true
  allowed_origins:
    - "http://localhost:3000"
    - "http://localhost:8080"
  credentials: true
  methods: ["GET", "POST", "PUT", "DELETE", "OPTIONS"]
  headers: ["Content-Type", "Authorization"]
  max_age_seconds: 3600

# Incident Response
incident_response:
  enabled: true
  
  procedures:
    high_value_fraud:
      severity: "critical"
      actions:
        - "immediate_alert"
        - "block_recipient"
        - "pause_automated_approvals"
        - "escalate_to_security_team"
    
    system_compromise:
      severity: "critical"
      actions:
        - "immediate_shutdown"
        - "alert_all_admins"
        - "preserve_audit_logs"
        - "initiate_incident_investigation"
    
    data_breach:
      severity: "critical"
      actions:
        - "notify_compliance"
        - "rotate_encryption_keys"
        - "audit_system_access"
        - "prepare_breach_notification"
