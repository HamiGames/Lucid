# LUCID TRON Client - Prometheus Alert Rules
# File: payment-systems/tron/config/alerts.yaml
# Purpose: Define alert rules for tron-client service monitoring

# Alert Groups
groups:
  - name: tron_client_alerts
    interval: 30s
    rules:
      # Circuit Breaker Alerts
      - alert: TronClientCircuitBreakerOpen
        expr: tron_circuit_breaker_state{breaker_name="tron_network"} == 1
        for: 1m
        labels:
          severity: critical
          service: tron-client
          component: circuit_breaker
        annotations:
          summary: "TRON Client circuit breaker is OPEN"
          description: "Circuit breaker {{ $labels.breaker_name }} has been open for more than 1 minute"
          runbook: "Check TRON network connectivity and service health"
      
      # Network Status Alerts
      - alert: TronClientNetworkDisconnected
        expr: tron_network_status == 0
        for: 2m
        labels:
          severity: critical
          service: tron-client
          component: network
        annotations:
          summary: "TRON Client network disconnected"
          description: "TRON network connection has been down for more than 2 minutes"
          runbook: "Check TRON network endpoint and API key configuration"
      
      # High Error Rate Alerts
      - alert: TronClientHighErrorRate
        expr: rate(tron_network_errors_total[5m]) > 10
        for: 5m
        labels:
          severity: warning
          service: tron-client
          component: network
        annotations:
          summary: "TRON Client high error rate"
          description: "Error rate is {{ $value }} errors/second over the last 5 minutes"
          runbook: "Check network connectivity and TRON API status"
      
      # Transaction Failure Rate Alert
      - alert: TronClientHighTransactionFailureRate
        expr: |
          rate(tron_transactions_total{status="failed"}[5m]) /
          rate(tron_transactions_total[5m]) > 0.1
        for: 5m
        labels:
          severity: warning
          service: tron-client
          component: transactions
        annotations:
          summary: "TRON Client high transaction failure rate"
          description: "Transaction failure rate is {{ $value | humanizePercentage }}"
          runbook: "Check transaction validation and network status"
      
      # Pending Transactions Alert
      - alert: TronClientTooManyPendingTransactions
        expr: tron_pending_transactions > 100
        for: 10m
        labels:
          severity: warning
          service: tron-client
          component: transactions
        annotations:
          summary: "TRON Client too many pending transactions"
          description: "There are {{ $value }} pending transactions"
          runbook: "Check transaction confirmation monitoring"
      
      # Network Latency Alert
      - alert: TronClientHighNetworkLatency
        expr: histogram_quantile(0.95, rate(tron_network_latency_seconds_bucket[5m])) > 5.0
        for: 5m
        labels:
          severity: warning
          service: tron-client
          component: network
        annotations:
          summary: "TRON Client high network latency"
          description: "95th percentile latency is {{ $value }}s"
          runbook: "Check TRON network status and endpoint performance"
      
      # Service Health Alert
      - alert: TronClientServiceUnhealthy
        expr: tron_service_health{component="tron_client"} == 0
        for: 2m
        labels:
          severity: critical
          service: tron-client
          component: service
        annotations:
          summary: "TRON Client service unhealthy"
          description: "Service health check failed for component {{ $labels.component }}"
          runbook: "Check service logs and dependencies (MongoDB, Redis, TRON network)"
      
      # Connection Pool Exhaustion Alert
      - alert: TronClientConnectionPoolExhausted
        expr: |
          tron_connection_pool_active / tron_connection_pool_size{state="total"} > 0.9
        for: 5m
        labels:
          severity: warning
          service: tron-client
          component: connection_pool
        annotations:
          summary: "TRON Client connection pool nearly exhausted"
          description: "{{ $value | humanizePercentage }} of connection pool is active"
          runbook: "Check connection pool configuration and network load"
      
      # Rate Limit Hits Alert
      - alert: TronClientHighRateLimitHits
        expr: rate(tron_rate_limit_hits_total[5m]) > 5
        for: 5m
        labels:
          severity: warning
          service: tron-client
          component: rate_limiting
        annotations:
          summary: "TRON Client high rate limit hits"
          description: "Rate limit is being hit {{ $value }} times/second"
          runbook: "Check rate limit configuration and request patterns"
      
      # Monitoring Tasks Alert
      - alert: TronClientMonitoringTasksDown
        expr: tron_monitoring_tasks == 0
        for: 2m
        labels:
          severity: warning
          service: tron-client
          component: monitoring
        annotations:
          summary: "TRON Client monitoring tasks stopped"
          description: "No monitoring tasks are running"
          runbook: "Check service initialization and monitoring task startup"
      
      # Uptime Alert (for long-running services)
      - alert: TronClientServiceRestarted
        expr: |
          changes(tron_service_uptime_seconds[10m]) > 0
        labels:
          severity: info
          service: tron-client
          component: service
        annotations:
          summary: "TRON Client service restarted"
          description: "Service uptime counter reset detected"
          runbook: "Check service logs for restart reason"

# Alert Notification Configuration
notifications:
  # AlertManager integration
  alertmanager:
    enabled: true
    url: "${ALERTMANAGER_URL:-http://alertmanager:9093}"
    timeout: 10s
  
  # Email notifications
  email:
    enabled: false
    smtp_server: "${SMTP_SERVER}"
    smtp_port: "${SMTP_PORT:-587}"
    from_address: "${ALERT_EMAIL_FROM}"
    to_addresses: "${ALERT_EMAIL_TO}"
  
  # Webhook notifications
  webhook:
    enabled: true
    url: "${ALERT_WEBHOOK_URL}"
    timeout: 5s
  
  # Slack notifications
  slack:
    enabled: false
    webhook_url: "${SLACK_WEBHOOK_URL}"
    channel: "#alerts"
    username: "TRON Client Alerts"

# Alert Severity Levels
severity:
  critical:
    response_time: "5 minutes"
    escalation: ["oncall_engineer", "team_lead", "cto"]
  
  warning:
    response_time: "15 minutes"
    escalation: ["oncall_engineer", "team_lead"]
  
  info:
    response_time: "1 hour"
    escalation: ["oncall_engineer"]

