# Phase 2 Core Services - Docker Compose Configuration
# Step 45: Docker Compose Configurations - Core Phase
# Includes: API Gateway, Blockchain Core, Service Mesh

version: '3.8'

services:
  # ===========================================
  # API GATEWAY SERVICES
  # ===========================================
  
  # API Gateway
  api-gateway:
    image: ${LUCID_REGISTRY:-ghcr.io}/${LUCID_IMAGE_NAME:-HamiGames/Lucid}/api-gateway:${LUCID_TAG:-latest}
    container_name: lucid-api-gateway
    restart: unless-stopped
    ports:
      - "8080:8080"
      - "8081:8081"
    environment:
      - SERVICE_NAME=lucid-api-gateway
      - PORT=8080
      - HTTPS_PORT=8081
      - HOST=0.0.0.0
      - LOG_LEVEL=INFO
      - DEBUG=false
      - AUTH_SERVICE_URL=http://lucid-auth-service:8089
      - MONGODB_URI=mongodb://lucid:lucid@lucid-mongodb:27017/lucid?authSource=admin
      - REDIS_URI=redis://lucid-redis:6379/0
      - RATE_LIMIT_ENABLED=true
      - RATE_LIMIT_REQUESTS_PER_MINUTE=100
      - CORS_ENABLED=true
      - CORS_ORIGINS=${CORS_ORIGINS:-*}
    volumes:
      - api_gateway_logs:/app/logs
    networks:
      - lucid-dev
    depends_on:
      lucid-auth-service:
        condition: service_healthy
      lucid-mongodb:
        condition: service_healthy
      lucid-redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    labels:
      - "com.lucid.phase=core"
      - "com.lucid.service=api-gateway"
      - "com.lucid.cluster=01-api-gateway"

  # ===========================================
  # BLOCKCHAIN CORE SERVICES
  # ===========================================

  # Blockchain Core Engine
  blockchain-core:
    image: ${LUCID_REGISTRY:-ghcr.io}/${LUCID_IMAGE_NAME:-HamiGames/Lucid}/blockchain-core:${LUCID_TAG:-latest}
    container_name: lucid-blockchain-core
    restart: unless-stopped
    ports:
      - "8084:8084"
    environment:
      - SERVICE_NAME=lucid-blockchain-core
      - PORT=8084
      - HOST=0.0.0.0
      - LOG_LEVEL=INFO
      - DEBUG=false
      - MONGODB_URI=mongodb://lucid:lucid@lucid-mongodb:27017/lucid?authSource=admin
      - REDIS_URI=redis://lucid-redis:6379/0
      - CONSENSUS_ALGORITHM=PoOT
      - BLOCK_TIME_SECONDS=10
      - MAX_TRANSACTIONS_PER_BLOCK=1000
    volumes:
      - blockchain_data:/app/data
      - blockchain_logs:/app/logs
    networks:
      - lucid-dev
    depends_on:
      lucid-mongodb:
        condition: service_healthy
      lucid-redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8084/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    labels:
      - "com.lucid.phase=core"
      - "com.lucid.service=blockchain"
      - "com.lucid.cluster=02-blockchain-core"

  # Blockchain Engine
  blockchain-engine:
    image: ${LUCID_REGISTRY:-ghcr.io}/${LUCID_IMAGE_NAME:-HamiGames/Lucid}/blockchain-engine:${LUCID_TAG:-latest}
    container_name: lucid-blockchain-engine
    restart: unless-stopped
    ports:
      - "8085:8085"
    environment:
      - SERVICE_NAME=lucid-blockchain-engine
      - PORT=8085
      - HOST=0.0.0.0
      - LOG_LEVEL=INFO
      - DEBUG=false
      - MONGODB_URI=mongodb://lucid:lucid@lucid-mongodb:27017/lucid?authSource=admin
      - REDIS_URI=redis://lucid-redis:6379/0
      - BLOCKCHAIN_CORE_URL=http://lucid-blockchain-core:8084
    volumes:
      - blockchain_engine_data:/app/data
      - blockchain_engine_logs:/app/logs
    networks:
      - lucid-dev
    depends_on:
      lucid-blockchain-core:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8085/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    labels:
      - "com.lucid.phase=core"
      - "com.lucid.service=blockchain-engine"
      - "com.lucid.cluster=02-blockchain-core"

  # Session Anchoring Service
  session-anchoring:
    image: ${LUCID_REGISTRY:-ghcr.io}/${LUCID_IMAGE_NAME:-HamiGames/Lucid}/session-anchoring:${LUCID_TAG:-latest}
    container_name: lucid-session-anchoring
    restart: unless-stopped
    ports:
      - "8086:8086"
    environment:
      - SERVICE_NAME=lucid-session-anchoring
      - PORT=8086
      - HOST=0.0.0.0
      - LOG_LEVEL=INFO
      - DEBUG=false
      - MONGODB_URI=mongodb://lucid:lucid@lucid-mongodb:27017/lucid?authSource=admin
      - REDIS_URI=redis://lucid-redis:6379/0
      - BLOCKCHAIN_CORE_URL=http://lucid-blockchain-core:8084
    volumes:
      - anchoring_data:/app/data
      - anchoring_logs:/app/logs
    networks:
      - lucid-dev
    depends_on:
      lucid-blockchain-core:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8086/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    labels:
      - "com.lucid.phase=core"
      - "com.lucid.service=session-anchoring"
      - "com.lucid.cluster=02-blockchain-core"

  # Block Manager
  block-manager:
    image: ${LUCID_REGISTRY:-ghcr.io}/${LUCID_IMAGE_NAME:-HamiGames/Lucid}/block-manager:${LUCID_TAG:-latest}
    container_name: lucid-block-manager
    restart: unless-stopped
    ports:
      - "8087:8087"
    environment:
      - SERVICE_NAME=lucid-block-manager
      - PORT=8087
      - HOST=0.0.0.0
      - LOG_LEVEL=INFO
      - DEBUG=false
      - MONGODB_URI=mongodb://lucid:lucid@lucid-mongodb:27017/lucid?authSource=admin
      - REDIS_URI=redis://lucid-redis:6379/0
      - BLOCKCHAIN_CORE_URL=http://lucid-blockchain-core:8084
    volumes:
      - block_manager_data:/app/data
      - block_manager_logs:/app/logs
    networks:
      - lucid-dev
    depends_on:
      lucid-blockchain-core:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8087/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    labels:
      - "com.lucid.phase=core"
      - "com.lucid.service=block-manager"
      - "com.lucid.cluster=02-blockchain-core"

  # Data Chain Service
  data-chain:
    image: ${LUCID_REGISTRY:-ghcr.io}/${LUCID_IMAGE_NAME:-HamiGames/Lucid}/data-chain:${LUCID_TAG:-latest}
    container_name: lucid-data-chain
    restart: unless-stopped
    ports:
      - "8088:8088"
    environment:
      - SERVICE_NAME=lucid-data-chain
      - PORT=8088
      - HOST=0.0.0.0
      - LOG_LEVEL=INFO
      - DEBUG=false
      - MONGODB_URI=mongodb://lucid:lucid@lucid-mongodb:27017/lucid?authSource=admin
      - REDIS_URI=redis://lucid-redis:6379/0
      - BLOCKCHAIN_CORE_URL=http://lucid-blockchain-core:8084
    volumes:
      - data_chain_data:/app/data
      - data_chain_logs:/app/logs
    networks:
      - lucid-dev
    depends_on:
      lucid-blockchain-core:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8088/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    labels:
      - "com.lucid.phase=core"
      - "com.lucid.service=data-chain"
      - "com.lucid.cluster=02-blockchain-core"

  # ===========================================
  # SERVICE MESH SERVICES
  # ===========================================

  # Service Mesh Controller
  service-mesh-controller:
    image: ${LUCID_REGISTRY:-ghcr.io}/${LUCID_IMAGE_NAME:-HamiGames/Lucid}/service-mesh-controller:${LUCID_TAG:-latest}
    container_name: lucid-service-mesh-controller
    restart: unless-stopped
    ports:
      - "8500:8500"  # Consul HTTP
      - "8501:8501"  # Consul HTTPS
      - "8502:8502"  # Consul gRPC
    environment:
      - SERVICE_NAME=lucid-service-mesh-controller
      - PORT=8500
      - HOST=0.0.0.0
      - LOG_LEVEL=INFO
      - DEBUG=false
      - CONSUL_DATACENTER=lucid-dc
      - CONSUL_SERVER=true
      - CONSUL_BOOTSTRAP_EXPECT=1
      - CONSUL_BIND_INTERFACE=eth0
      - CONSUL_CLIENT_INTERFACE=eth0
    volumes:
      - consul_data:/consul/data
      - consul_logs:/app/logs
    networks:
      - lucid-dev
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8500/v1/status/leader || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    labels:
      - "com.lucid.phase=core"
      - "com.lucid.service=service-mesh"
      - "com.lucid.cluster=10-cross-cluster-integration"

# ===========================================
# NETWORKS
# ===========================================
networks:
  lucid-dev:
    name: lucid-dev_lucid_net
    driver: bridge
    attachable: true
    ipam:
      config:
        - subnet: 172.20.0.0/16
          gateway: 172.20.0.1

# ===========================================
# VOLUMES
# ===========================================
volumes:
  # API Gateway volumes
  api_gateway_logs:
    driver: local
  
  # Blockchain volumes
  blockchain_data:
    driver: local
  blockchain_logs:
    driver: local
  blockchain_engine_data:
    driver: local
  blockchain_engine_logs:
    driver: local
  anchoring_data:
    driver: local
  anchoring_logs:
    driver: local
  block_manager_data:
    driver: local
  block_manager_logs:
    driver: local
  data_chain_data:
    driver: local
  data_chain_logs:
    driver: local
  
  # Service Mesh volumes
  consul_data:
    driver: local
  consul_logs:
    driver: local
