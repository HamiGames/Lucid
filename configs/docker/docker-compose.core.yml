name: lucid-core
services:
  api-gateway:
    image: pickme/lucid-api-gateway:latest-arm64
    container_name: api-gateway
    restart: unless-stopped
    env_file:
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.foundation
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.core
    networks:
      - lucid-pi-network
    ports:
      - "8080:8080"
    volumes:
      - /mnt/myssd/Lucid/Lucid/logs/api-gateway:/app/logs:rw
      - /mnt/myssd/Lucid/Lucid/data/api-gateway/cache:/app/cache:rw
      - api-gateway-tmp:/tmp/api
    environment:
      - LUCID_ENV=production
      - LUCID_PLATFORM=arm64
      - API_GATEWAY_HOST=api-gateway
      - API_GATEWAY_PORT=8080
      - API_GATEWAY_URL=http://api-gateway:8080
      - AUTH_SERVICE_URL=${AUTH_SERVICE_URL}
      - MONGODB_URL=${MONGODB_URL}
      - REDIS_URL=${REDIS_URL}
    user: "65532:65532"
    security_opt:
      - no-new-privileges:true
      - seccomp:unconfined
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=100m
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    labels:
      - "lucid.service=api-gateway"
      - "lucid.type=distroless"
      - "lucid.platform=arm64"
      - "lucid.security=hardened"
      - "lucid.cluster=core"
    depends_on:
      tor-proxy:
        condition: service_started

  blockchain-engine:
    image: pickme/lucid-blockchain-engine:latest-arm64
    container_name: blockchain-engine
    restart: unless-stopped
    env_file:
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.foundation
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.core
    networks:
      - lucid-pi-network
    ports:
      - "8084:8084"
    volumes:
      - /mnt/myssd/Lucid/Lucid/data/blockchain:/app/data:rw
      - /mnt/myssd/Lucid/Lucid/logs/blockchain-engine:/app/logs:rw
      - blockchain-cache:/tmp/blockchain
    environment:
      - LUCID_ENV=production
      - LUCID_PLATFORM=arm64
      - BLOCKCHAIN_ENGINE_HOST=blockchain-engine
      - BLOCKCHAIN_ENGINE_PORT=8084
      - BLOCKCHAIN_ENGINE_URL=http://blockchain-engine:8084
      - MONGODB_URL=${MONGODB_URL}
      - REDIS_URL=${REDIS_URL}
    user: "65532:65532"
    security_opt:
      - no-new-privileges:true
      - seccomp:unconfined
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=200m
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8084/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    labels:
      - "lucid.service=blockchain-engine"
      - "lucid.type=distroless"
      - "lucid.platform=arm64"
      - "lucid.security=hardened"
      - "lucid.cluster=core"
    depends_on:
      tor-proxy:
        condition: service_started

  service-mesh:
    image: pickme/lucid-service-mesh-controller:latest-arm64
    container_name: service-mesh
    restart: unless-stopped
    env_file:
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.foundation
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.core
    networks:
      - lucid-pi-network
    ports:
      - "8500:8500"
    volumes:
      - /mnt/myssd/Lucid/Lucid/logs/service-mesh:/app/logs:rw
      - /mnt/myssd/Lucid/Lucid/data/service-mesh/config:/app/config:rw
      - service-mesh-cache:/tmp/mesh
    environment:
      - LUCID_ENV=production
      - LUCID_PLATFORM=arm64
      - SERVICE_MESH_HOST=service-mesh
      - SERVICE_MESH_PORT=8500
      - SERVICE_MESH_URL=http://service-mesh:8500
      - MONGODB_URL=${MONGODB_URL}
      - REDIS_URL=${REDIS_URL}
    user: "65532:65532"
    security_opt:
      - no-new-privileges:true
      - seccomp:unconfined
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=100m
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8500/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    labels:
      - "lucid.service=service-mesh"
      - "lucid.type=distroless"
      - "lucid.platform=arm64"
      - "lucid.security=hardened"
      - "lucid.cluster=core"
    depends_on:
      tor-proxy:
        condition: service_started

  session-anchoring:
    image: pickme/lucid-session-anchoring:latest-arm64
    container_name: session-anchoring
    restart: unless-stopped
    env_file:
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.secrets
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.foundation
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.core
    networks:
      - lucid-pi-network
    ports:
      - "8085:8085"
    volumes:
      - /mnt/myssd/Lucid/Lucid/data/session-anchoring:/app/data:rw
      - /mnt/myssd/Lucid/Lucid/logs/session-anchoring:/app/logs:rw
      - session-anchoring-cache:/tmp/anchoring
    environment:
      - LUCID_ENV=production
      - LUCID_PLATFORM=arm64
      - SESSION_ANCHORING_HOST=session-anchoring
      - SESSION_ANCHORING_PORT=8085
      - SESSION_ANCHORING_URL=http://session-anchoring:8085
      - MONGODB_URL=${MONGODB_URL}
      - REDIS_URL=${REDIS_URL}
      - BLOCKCHAIN_ENGINE_URL=${BLOCKCHAIN_ENGINE_URL}
    user: "65532:65532"
    security_opt:
      - no-new-privileges:true
      - seccomp:unconfined
    cap_drop:
      - ALL
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=100m
    healthcheck:
      test: ["CMD", "python3", "-c", "import sys; sys.exit(0)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    labels:
      - "lucid.service=session-anchoring"
      - "lucid.type=distroless"
      - "lucid.platform=arm64"
      - "lucid.security=hardened"
      - "lucid.cluster=core"
    depends_on:
      tor-proxy:
        condition: service_started

  block-manager:
    image: pickme/lucid-block-manager:latest-arm64
    container_name: block-manager
    restart: unless-stopped
    env_file:
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.secrets
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.foundation
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.core
    networks:
      - lucid-pi-network
    volumes:
      - /mnt/myssd/Lucid/Lucid/data/block-manager:/app/data:rw
      - /mnt/myssd/Lucid/Lucid/logs/block-manager:/app/logs:rw
      - block-manager-cache:/tmp/blocks
    environment:
      - LUCID_ENV=production
      - LUCID_PLATFORM=arm64
      - BLOCK_MANAGER_HOST=block-manager
      - BLOCK_MANAGER_PORT=8086
      - BLOCK_MANAGER_URL=http://block-manager:8086
      - MONGODB_URL=${MONGODB_URL}
      - REDIS_URL=${REDIS_URL}
      - BLOCKCHAIN_ENGINE_URL=${BLOCKCHAIN_ENGINE_URL}
    user: "65532:65532"
    security_opt:
      - no-new-privileges:true
      - seccomp:unconfined
    cap_drop:
      - ALL
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=100m
    healthcheck:
      test: ["CMD", "python3", "-c", "import sys; sys.exit(0)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    labels:
      - "lucid.service=block-manager"
      - "lucid.type=distroless"
      - "lucid.platform=arm64"
      - "lucid.security=hardened"
      - "lucid.cluster=core"
    depends_on:
      tor-proxy:
        condition: service_started

  data-chain:
    image: pickme/lucid-data-chain:latest-arm64
    container_name: data-chain
    restart: unless-stopped
    env_file:
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.secrets
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.foundation
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.core
    networks:
      - lucid-pi-network
    volumes:
      - /mnt/myssd/Lucid/Lucid/data/data-chain:/app/data:rw
      - /mnt/myssd/Lucid/Lucid/logs/data-chain:/app/logs:rw
      - data-chain-cache:/tmp/chain
    environment:
      - LUCID_ENV=production
      - LUCID_PLATFORM=arm64
      - DATA_CHAIN_HOST=data-chain
      - DATA_CHAIN_PORT=8087
      - DATA_CHAIN_URL=http://data-chain:8087
      - MONGODB_URL=${MONGODB_URL}
      - REDIS_URL=${REDIS_URL}
      - BLOCKCHAIN_ENGINE_URL=${BLOCKCHAIN_ENGINE_URL}
    user: "65532:65532"
    security_opt:
      - no-new-privileges:true
      - seccomp:unconfined
    cap_drop:
      - ALL
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=100m
    healthcheck:
      test: ["CMD", "python3", "-c", "import sys; sys.exit(0)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    labels:
      - "lucid.service=data-chain"
      - "lucid.type=distroless"
      - "lucid.platform=arm64"
      - "lucid.security=hardened"
      - "lucid.cluster=core"
    depends_on:
      tor-proxy:
        condition: service_started

  lucid-tunnel-tools:
    image: pickme/lucid-tunnel-tools:latest-arm64
    container_name: lucid-tunnel-tools
    restart: unless-stopped
    env_file:
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.foundation
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.core
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.secrets
    networks:
      - lucid-pi-network
    ports:
      - "7000:7000"
    volumes:
      - /mnt/myssd/Lucid/Lucid/data/tor:/var/lib/tor:ro
      - /mnt/myssd/Lucid/Lucid/data/onion:/run/lucid/onion:rw
      - /mnt/myssd/Lucid/Lucid/data/tunnel:/var/lib/tunnel:rw
      - /mnt/myssd/Lucid/Lucid/logs/tunnel-tools:/app/logs:rw
    environment:
      - LUCID_ENV=production
      - LUCID_PLATFORM=arm64
      - CONTROL_HOST=tor-proxy
      - CONTROL_PORT=9051
      - COOKIE_FILE=/var/lib/tor/control_auth_cookie
      - ONION_PORTS=80 lucid_api:8081
      - WRITE_ENV=/app/scripts/.onion.env
      - ROTATE_INTERVAL=0
      - TUNNEL_PORT=7000
      - TUNNEL_MODE=client
      - TOR_PROXY=tor-proxy:9050
    user: "65532:65532"
    security_opt:
      - no-new-privileges:true
      - seccomp:unconfined
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=100m
    healthcheck:
      test:
        [
          "CMD",
          "python3",
          "-c",
          "import socket; s=socket.socket(); s.connect(('tor-proxy', 9051)); s.close(); exit(0)",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 45s
    depends_on:
      tor-proxy:
        condition: service_started

networks:
  lucid-pi-network:
    external: true
    name: lucid-pi-network

volumes:
  api-gateway-tmp:
    driver: local
    name: lucid-api-gateway-tmp
  blockchain-cache:
    driver: local
    name: lucid-blockchain-cache
  service-mesh-cache:
    driver: local
    name: lucid-service-mesh-cache
  session-anchoring-cache:
    driver: local
    name: lucid-session-anchoring-cache
  block-manager-cache:
    driver: local
    name: lucid-block-manager-cache
  data-chain-cache:
    driver: local
    name: lucid-data-chain-cache
