# Phase 3 Application Services - Docker Compose Configuration
# Step 24: Phase 3 Docker Compose
# Includes: Session Management, RDP Services, Node Management
# Target: Raspberry Pi ARM64 deployment

version: '3.8'

services:
  # ===========================================
  # SESSION MANAGEMENT SERVICES (5 containers)
  # ===========================================
  
  # Session Pipeline Manager
  lucid-session-pipeline:
    image: pickme/lucid-session-pipeline:latest-arm64
    container_name: lucid-session-pipeline
    restart: unless-stopped
    ports:
      - "8083:8083"
    environment:
      - SERVICE_NAME=lucid-session-pipeline
      - PORT=8083
      - HOST=0.0.0.0
      - LOG_LEVEL=INFO
      - DEBUG=false
      - MONGODB_URI=mongodb://lucid:lucid@lucid-mongodb:27017/lucid?authSource=admin
      - REDIS_URI=redis://lucid-redis:6379/0
      - PIPELINE_MAX_CONCURRENT_SESSIONS=10
      - PIPELINE_CHUNK_SIZE_MB=1
      - PIPELINE_COMPRESSION_LEVEL=6
    volumes:
      - /mnt/myssd/Lucid/logs/session-pipeline:/app/logs
      - /mnt/myssd/Lucid/data/session-pipeline:/app/data
    networks:
      - lucid-pi-network
    depends_on:
      lucid-mongodb:
        condition: service_healthy
      lucid-redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8083/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    labels:
      - "com.lucid.phase=application"
      - "com.lucid.service=session-pipeline"
      - "com.lucid.cluster=03-session-management"

  # Session Recorder
  lucid-session-recorder:
    image: pickme/lucid-session-recorder:latest-arm64
    container_name: lucid-session-recorder
    restart: unless-stopped
    ports:
      - "8084:8084"
    environment:
      - SERVICE_NAME=lucid-session-recorder
      - PORT=8084
      - HOST=0.0.0.0
      - LOG_LEVEL=INFO
      - DEBUG=false
      - MONGODB_URI=mongodb://lucid:lucid@lucid-mongodb:27017/lucid?authSource=admin
      - REDIS_URI=redis://lucid-redis:6379/0
      - RECORDING_QUALITY=high
      - RECORDING_FPS=30
      - RECORDING_BITRATE=2000k
    volumes:
      - /mnt/myssd/Lucid/logs/session-recorder:/app/logs
      - /mnt/myssd/Lucid/data/session-recorder:/app/data
      - /mnt/myssd/Lucid/recordings:/app/recordings
    networks:
      - lucid-pi-network
    depends_on:
      lucid-mongodb:
        condition: service_healthy
      lucid-redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8084/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    labels:
      - "com.lucid.phase=application"
      - "com.lucid.service=session-recorder"
      - "com.lucid.cluster=03-session-management"

  # Chunk Processor
  lucid-chunk-processor:
    image: pickme/lucid-chunk-processor:latest-arm64
    container_name: lucid-chunk-processor
    restart: unless-stopped
    ports:
      - "8085:8085"
    environment:
      - SERVICE_NAME=lucid-chunk-processor
      - PORT=8085
      - HOST=0.0.0.0
      - LOG_LEVEL=INFO
      - DEBUG=false
      - MONGODB_URI=mongodb://lucid:lucid@lucid-mongodb:27017/lucid?authSource=admin
      - REDIS_URI=redis://lucid-redis:6379/0
      - PROCESSOR_CHUNK_SIZE_MB=1
      - PROCESSOR_ENCRYPTION_ENABLED=true
      - PROCESSOR_COMPRESSION_ENABLED=true
    volumes:
      - /mnt/myssd/Lucid/logs/chunk-processor:/app/logs
      - /mnt/myssd/Lucid/data/chunk-processor:/app/data
    networks:
      - lucid-pi-network
    depends_on:
      lucid-mongodb:
        condition: service_healthy
      lucid-redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8085/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    labels:
      - "com.lucid.phase=application"
      - "com.lucid.service=chunk-processor"
      - "com.lucid.cluster=03-session-management"

  # Session Storage
  lucid-session-storage:
    image: pickme/lucid-session-storage:latest-arm64
    container_name: lucid-session-storage
    restart: unless-stopped
    ports:
      - "8086:8086"
    environment:
      - SERVICE_NAME=lucid-session-storage
      - PORT=8086
      - HOST=0.0.0.0
      - LOG_LEVEL=INFO
      - DEBUG=false
      - MONGODB_URI=mongodb://lucid:lucid@lucid-mongodb:27017/lucid?authSource=admin
      - REDIS_URI=redis://lucid-redis:6379/0
      - STORAGE_MAX_SIZE_GB=100
      - STORAGE_RETENTION_DAYS=30
      - STORAGE_ENCRYPTION_ENABLED=true
    volumes:
      - /mnt/myssd/Lucid/logs/session-storage:/app/logs
      - /mnt/myssd/Lucid/data/session-storage:/app/data
      - /mnt/myssd/Lucid/sessions:/app/sessions
    networks:
      - lucid-pi-network
    depends_on:
      lucid-mongodb:
        condition: service_healthy
      lucid-redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8086/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    labels:
      - "com.lucid.phase=application"
      - "com.lucid.service=session-storage"
      - "com.lucid.cluster=03-session-management"

  # Session API Gateway
  lucid-session-api:
    image: pickme/lucid-session-api:latest-arm64
    container_name: lucid-session-api
    restart: unless-stopped
    ports:
      - "8087:8087"
    environment:
      - SERVICE_NAME=lucid-session-api
      - PORT=8087
      - HOST=0.0.0.0
      - LOG_LEVEL=INFO
      - DEBUG=false
      - MONGODB_URI=mongodb://lucid:lucid@lucid-mongodb:27017/lucid?authSource=admin
      - REDIS_URI=redis://lucid-redis:6379/0
      - API_RATE_LIMIT=1000
      - API_TIMEOUT=30
      - API_CORS_ENABLED=true
    volumes:
      - /mnt/myssd/Lucid/logs/session-api:/app/logs
      - /mnt/myssd/Lucid/data/session-api:/app/data
    networks:
      - lucid-pi-network
    depends_on:
      lucid-mongodb:
        condition: service_healthy
      lucid-redis:
        condition: service_healthy
      lucid-session-pipeline:
        condition: service_healthy
      lucid-session-recorder:
        condition: service_healthy
      lucid-chunk-processor:
        condition: service_healthy
      lucid-session-storage:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8087/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    labels:
      - "com.lucid.phase=application"
      - "com.lucid.service=session-api"
      - "com.lucid.cluster=03-session-management"

  # ===========================================
  # RDP SERVICES (4 containers)
  # ===========================================

  # RDP Server Manager
  lucid-rdp-server-manager:
    image: pickme/lucid-rdp-server-manager:latest-arm64
    container_name: lucid-rdp-server-manager
    restart: unless-stopped
    ports:
      - "8081:8081"
    environment:
      - SERVICE_NAME=lucid-rdp-server-manager
      - PORT=8081
      - HOST=0.0.0.0
      - LOG_LEVEL=INFO
      - DEBUG=false
      - MONGODB_URI=mongodb://lucid:lucid@lucid-mongodb:27017/lucid?authSource=admin
      - REDIS_URI=redis://lucid-redis:6379/0
      - XRDP_PORT=3389
      - MAX_CONCURRENT_SESSIONS=5
      - SESSION_TIMEOUT_MINUTES=60
    volumes:
      - /mnt/myssd/Lucid/logs/rdp-server-manager:/app/logs
      - /mnt/myssd/Lucid/data/rdp-server-manager:/app/data
    networks:
      - lucid-pi-network
    depends_on:
      lucid-mongodb:
        condition: service_healthy
      lucid-redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8081/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    labels:
      - "com.lucid.phase=application"
      - "com.lucid.service=rdp-server-manager"
      - "com.lucid.cluster=04-rdp-services"

  # XRDP Integration
  lucid-xrdp-integration:
    image: pickme/lucid-xrdp-integration:latest-arm64
    container_name: lucid-xrdp-integration
    restart: unless-stopped
    ports:
      - "3389:3389"
    environment:
      - SERVICE_NAME=lucid-xrdp-integration
      - PORT=3389
      - HOST=0.0.0.0
      - LOG_LEVEL=INFO
      - DEBUG=false
      - XRDP_LOG_LEVEL=INFO
      - XRDP_ENABLE_SYSLOG=false
      - XRDP_CHANNEL_RDPDR=true
      - XRDP_CHANNEL_RDPSND=true
      - XRDP_CHANNEL_DRDYNVC=true
      - XRDP_CHANNEL_CLIPRDR=true
    volumes:
      - /mnt/myssd/Lucid/logs/xrdp-integration:/app/logs
      - /mnt/myssd/Lucid/data/xrdp-integration:/app/data
    networks:
      - lucid-pi-network
    depends_on:
      lucid-rdp-server-manager:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "netstat -tuln | grep :3389 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    labels:
      - "com.lucid.phase=application"
      - "com.lucid.service=xrdp-integration"
      - "com.lucid.cluster=04-rdp-services"

  # Session Controller
  lucid-session-controller:
    image: pickme/lucid-session-controller:latest-arm64
    container_name: lucid-session-controller
    restart: unless-stopped
    ports:
      - "8082:8082"
    environment:
      - SERVICE_NAME=lucid-session-controller
      - PORT=8082
      - HOST=0.0.0.0
      - LOG_LEVEL=INFO
      - DEBUG=false
      - MONGODB_URI=mongodb://lucid:lucid@lucid-mongodb:27017/lucid?authSource=admin
      - REDIS_URI=redis://lucid-redis:6379/0
      - SESSION_RECORDING_PATH=/data/recordings
      - SESSION_RECORDING_FORMAT=mp4
      - SESSION_RECORDING_QUALITY=high
      - SESSION_RECORDING_BITRATE=2000k
      - SESSION_RECORDING_FPS=30
    volumes:
      - /mnt/myssd/Lucid/logs/session-controller:/app/logs
      - /mnt/myssd/Lucid/data/session-controller:/app/data
      - /mnt/myssd/Lucid/recordings:/app/recordings
    networks:
      - lucid-pi-network
    depends_on:
      lucid-mongodb:
        condition: service_healthy
      lucid-redis:
        condition: service_healthy
      lucid-rdp-server-manager:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8082/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    labels:
      - "com.lucid.phase=application"
      - "com.lucid.service=session-controller"
      - "com.lucid.cluster=04-rdp-services"

  # Resource Monitor
  lucid-resource-monitor:
    image: pickme/lucid-resource-monitor:latest-arm64
    container_name: lucid-resource-monitor
    restart: unless-stopped
    ports:
      - "8090:8090"
    environment:
      - SERVICE_NAME=lucid-resource-monitor
      - PORT=8090
      - HOST=0.0.0.0
      - LOG_LEVEL=INFO
      - DEBUG=false
      - MONGODB_URI=mongodb://lucid:lucid@lucid-mongodb:27017/lucid?authSource=admin
      - REDIS_URI=redis://lucid-redis:6379/0
      - MONITOR_CPU_THRESHOLD=80
      - MONITOR_MEMORY_THRESHOLD=80
      - MONITOR_DISK_THRESHOLD=90
      - MONITOR_INTERVAL_SECONDS=30
    volumes:
      - /mnt/myssd/Lucid/logs/resource-monitor:/app/logs
      - /mnt/myssd/Lucid/data/resource-monitor:/app/data
      - /proc:/host/proc:ro
      - /sys:/host/sys:ro
    networks:
      - lucid-pi-network
    depends_on:
      lucid-mongodb:
        condition: service_healthy
      lucid-redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8090/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    labels:
      - "com.lucid.phase=application"
      - "com.lucid.service=resource-monitor"
      - "com.lucid.cluster=04-rdp-services"

  # ===========================================
  # NODE MANAGEMENT (1 container)
  # ===========================================

  # Node Management
  lucid-node-management:
    image: pickme/lucid-node-management:latest-arm64
    container_name: lucid-node-management
    restart: unless-stopped
    ports:
      - "8095:8095"
    environment:
      - SERVICE_NAME=lucid-node-management
      - PORT=8095
      - HOST=0.0.0.0
      - LOG_LEVEL=INFO
      - DEBUG=false
      - MONGODB_URI=mongodb://lucid:lucid@lucid-mongodb:27017/lucid?authSource=admin
      - REDIS_URI=redis://lucid-redis:6379/0
      - NODE_POOL_MAX_NODES=100
      - PAYOUT_THRESHOLD_USDT=10
      - POOT_CALCULATION_ENABLED=true
      - NODE_REGISTRATION_ENABLED=true
    volumes:
      - /mnt/myssd/Lucid/logs/node-management:/app/logs
      - /mnt/myssd/Lucid/data/node-management:/app/data
    networks:
      - lucid-pi-network
    depends_on:
      lucid-mongodb:
        condition: service_healthy
      lucid-redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8095/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    labels:
      - "com.lucid.phase=application"
      - "com.lucid.service=node-management"
      - "com.lucid.cluster=05-node-management"

# ===========================================
# NETWORKS
# ===========================================
networks:
  lucid-pi-network:
    name: lucid-pi-network
    driver: bridge
    attachable: true
    external: true
    ipam:
      config:
        - subnet: 172.20.0.0/16
          gateway: 172.20.0.1

# ===========================================
# VOLUMES
# ===========================================
# All volumes are mounted directly to /mnt/myssd/Lucid on the Pi
# No named volumes needed - using host path mounts for better performance