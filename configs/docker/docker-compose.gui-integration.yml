# GUI-Docker Integration Configuration
# Integrates Electron GUI with Docker backend services
# Step 33: GUI Environment Configuration from lucid-container-build-plan.plan.md

name: lucid-gui-integration
services:
  # ===========================================
  # GUI BACKEND SERVICES
  # ===========================================

  # GUI API Bridge Service
  gui-api-bridge:
    image: pickme/lucid-gui-api-bridge:latest-arm64
    container_name: lucid-gui-api-bridge
    restart: unless-stopped
    env_file:
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.secrets
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.core
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.application
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.foundation
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.gui
    ports:
      - "8102:8102"
    environment:
      - SERVICE_NAME=lucid-gui-api-bridge
      - PORT=8102
      - HOST=0.0.0.0
      - LOG_LEVEL=INFO
      - DEBUG=false
      - LUCID_ENV=production
      - LUCID_PLATFORM=arm64
      - API_GATEWAY_URL=http://lucid-api-gateway:8080
      - BLOCKCHAIN_ENGINE_URL=http://lucid-blockchain-engine:8084
      - AUTH_SERVICE_URL=http://lucid-auth-service:8089
      - SESSION_API_URL=http://lucid-session-api:8113
      - NODE_MANAGEMENT_URL=http://lucid-node-management:8095
      - ADMIN_INTERFACE_URL=http://lucid-admin-interface:8083
      - TRON_PAYMENT_URL=http://lucid-tron-client:8091
      - MONGODB_URL=mongodb://lucid:${MONGODB_PASSWORD}@lucid-mongodb:27017/lucid?authSource=admin
      - REDIS_URL=redis://:${REDIS_PASSWORD}@lucid-redis:6379/0
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
    volumes:
      - /mnt/myssd/Lucid/Lucid/logs/gui-api-bridge:/app/logs
      - /mnt/myssd/Lucid/Lucid/data/gui-api-bridge:/app/data
    networks:
      - lucid-pi-network
      - lucid-gui-network
    depends_on:
      lucid-api-gateway:
        condition: service_healthy
    healthcheck:
      test:
        [
          "CMD",
          "python3",
          "-c",
          "import socket; s = socket.socket(); s.settimeout(2); result = s.connect_ex(('127.0.0.1', 8102)); s.close(); exit(0 if result == 0 else 1)",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    labels:
      - "com.lucid.phase=gui"
      - "com.lucid.service=gui-api-bridge"
      - "com.lucid.cluster=gui-integration"
    user: "65532:65532"
    security_opt:
      - no-new-privileges:true
      - seccomp:unconfined
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE # Only for services that bind ports
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=100m

  # GUI Docker Manager Service
  gui-docker-manager:
    image: pickme/lucid-gui-docker-manager:latest-arm64
    container_name: lucid-gui-docker-manager
    restart: unless-stopped
    env_file:
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.secrets
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.core
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.application
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.foundation
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.gui
    ports:
      - "8098:8098"
    environment:
      - SERVICE_NAME=lucid-gui-docker-manager
      - PORT=8098
      - HOST=0.0.0.0
      - LOG_LEVEL=INFO
      - DEBUG=false
      - LUCID_ENV=production
      - LUCID_PLATFORM=arm64
      - DOCKER_HOST=unix:///var/run/docker.sock
      - DOCKER_API_VERSION=1.40
      - GUI_ACCESS_LEVELS_ENABLED=true
      - USER_SERVICES=foundation,core
      - DEVELOPER_SERVICES=foundation,core,application
      - ADMIN_SERVICES=foundation,core,application,support
      - MONGODB_URL=mongodb://lucid:${MONGODB_PASSWORD}@lucid-mongodb:27017/lucid?authSource=admin
      - REDIS_URL=redis://:${REDIS_PASSWORD}@lucid-redis:6379/0
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /mnt/myssd/Lucid/Lucid/logs/gui-docker-manager:/app/logs
      - /mnt/myssd/Lucid/Lucid/data/gui-docker-manager:/app/data
    networks:
      - lucid-pi-network
      - lucid-gui-network
    healthcheck:
      test:
        [
          "CMD",
          "python3",
          "-c",
          "import socket; s = socket.socket(); s.settimeout(2); result = s.connect_ex(('127.0.0.1', 8098)); s.close(); exit(0 if result == 0 else 1)",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    labels:
      - "com.lucid.phase=gui"
      - "com.lucid.service=gui-docker-manager"
      - "com.lucid.cluster=gui-integration"
    user: "65532:65532"
    security_opt:
      - no-new-privileges:true
      - seccomp:unconfined
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE # Only for services that bind ports
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=100m
  # GUI Tor Manager Service
  gui-tor-manager:
    image: pickme/lucid-gui-tor-manager:latest-arm64
    container_name: lucid-gui-tor-manager
    restart: unless-stopped
    env_file:
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.secrets
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.core
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.application
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.foundation
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.gui
    ports:
      - "8097:8097" # API port (FIXED: was 9050/9051)
    environment:
      - SERVICE_NAME=lucid-gui-tor-manager
      - PORT=8097 # ADDED: FastAPI port
      - HOST=0.0.0.0 # ADDED: FastAPI host
      - SERVICE_URL=http://lucid-gui-tor-manager:8097 # ADDED: Service URL
      - LUCID_ENV=production # ADDED
      - LUCID_PLATFORM=arm64 # ADDED
      - LOG_LEVEL=INFO # ADDED
      - DEBUG=false # ADDED
      - TOR_PROXY_URL=http://tor-proxy:9051 # ADDED: Connection to tor-proxy
      - TOR_PROXY_HOST=tor-proxy # ADDED: tor-proxy service name
      - TOR_SOCKS_PORT=9050 # Reference: tor-proxy SOCKS port
      - TOR_CONTROL_PORT=9051 # Reference: tor-proxy control port
      - TOR_DATA_DIR=/app/tor-data
      - TOR_LOG_LEVEL=notice
      - GUI_TOR_INTEGRATION=true
      - ONION_ADDRESS_MASKING=true
    volumes:
      - /mnt/myssd/Lucid/Lucid/data/tor:/app/tor-data:rw
      - /mnt/myssd/Lucid/Lucid/logs/gui-tor-manager:/app/logs:rw
      - onion-state:/run/lucid/onion:ro # ADDED: Read onion state from tor-proxy
    networks:
      - lucid-gui-network
      - lucid-pi-network # ADDED: To connect to tor-proxy
    depends_on:
      tor-proxy: # ADDED: Dependency on foundation tor-proxy
        condition: service_started
    healthcheck:
      test: [
          "CMD",
          "python3",
          "-c",
          "import socket; s = socket.socket(); s.settimeout(2); result = s.connect_ex(('127.0.0.1', 8097)); s.close(); exit(0 if result == 0 else 1)",
        ] # FIXED: Python socket check
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 60s
    labels:
      - "com.lucid.phase=gui"
      - "com.lucid.service=gui-tor-manager"
      - "com.lucid.cluster=gui-integration"
    user: "65532:65532"
    security_opt:
      - no-new-privileges:true
      - seccomp:unconfined
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE # Only for services that bind ports
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=100m
  # GUI Hardware Manager Service
  gui-hardware-manager:
    image: pickme/lucid-gui-hardware-manager:latest-arm64
    container_name: lucid-gui-hardware-manager
    restart: unless-stopped
    env_file:
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.secrets
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.core
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.application
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.foundation
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.gui
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.gui-hardware-manager
    ports:
      - "8099:8099"
    environment:
      - SERVICE_NAME=lucid-gui-hardware-manager
      - GUI_HARDWARE_MANAGER_HOST=0.0.0.0
      - GUI_HARDWARE_MANAGER_PORT=8099
      - GUI_HARDWARE_MANAGER_URL=http://gui-hardware-manager:8099
      - PORT=8099
      - HOST=0.0.0.0
      - LOG_LEVEL=INFO
      - DEBUG=false
      - LUCID_ENV=production
      - LUCID_PLATFORM=arm64
      # Hardware Configuration
      - HARDWARE_WALLET_ENABLED=true
      - LEDGER_ENABLED=true
      - LEDGER_VENDOR_ID=0x2c97
      - TREZOR_ENABLED=true
      - KEEPKEY_ENABLED=true
      - TRON_WALLET_SUPPORT=true
      # Database URLs (from .env.secrets)
      - MONGODB_URL=mongodb://lucid:${MONGODB_PASSWORD}@lucid-mongodb:27017/lucid?authSource=admin
      - REDIS_URL=redis://:${REDIS_PASSWORD}@lucid-redis:6379/0
      # Integration Service URLs
      - API_GATEWAY_URL=http://api-gateway:8080
      - AUTH_SERVICE_URL=http://lucid-auth-service:8089
      - GUI_API_BRIDGE_URL=http://gui-api-bridge:8102
      # Security
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
    volumes:
      - /mnt/myssd/Lucid/Lucid/logs/gui-hardware-manager:/app/logs
      - /mnt/myssd/Lucid/Lucid/data/gui-hardware-manager:/app/data
      # Writable tmpfs for USB device access
      - /tmp/usb-devices:/run/usb:rw
    networks:
      - lucid-pi-network
      - lucid-gui-network
    depends_on:
      tor-proxy:
        condition: service_started
      lucid-mongodb:
        condition: service_healthy
      lucid-redis:
        condition: service_healthy
      lucid-auth-service:
        condition: service_healthy
      api-gateway:
        condition: service_healthy
      gui-api-bridge:
        condition: service_healthy
    healthcheck:
      test:
        [
          "CMD",
          "python3",
          "-c",
          "import socket; s = socket.socket(); s.settimeout(2); result = s.connect_ex(('127.0.0.1', 8099)); s.close(); exit(0 if result == 0 else 1)",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    labels:
      - "com.lucid.phase=gui"
      - "com.lucid.service=gui-hardware-manager"
      - "com.lucid.cluster=gui-integration"
    user: "65532:65532"
    security_opt:
      - no-new-privileges:true
      - seccomp:unconfined
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=100m

  # ===========================================
  # ELECTRON GUI INTERFACES (Distroless)
  # ===========================================

  # Admin Interface - Distroless Electron GUI
  admin-interface:
    image: pickme/lucid-admin-interface:latest-arm64
    container_name: lucid-admin-interface
    restart: unless-stopped
    env_file:
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.secrets
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.core
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.application
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.foundation
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.gui
    ports:
      - "8120:8120"
      - "8100:8100"
    environment:
      - NODE_ENV=production
      - ELECTRON_GUI_PROFILE=admin
      - ELECTRON_GUI_NETWORK=lucid-pi-network
      - ELECTRON_GUI_API_BASE_URL=http://lucid-gui-api-bridge:8102/api/v1
      - ELECTRON_GUI_CONFIG_FILE=/app/configs/api-services.conf
      - ADMIN_INTERFACE_HOST=0.0.0.0
      - ADMIN_INTERFACE_PORT=8120
      - LOG_LEVEL=INFO
      - LUCID_ENV=production
    volumes:
      - /mnt/myssd/Lucid/Lucid/logs/admin-interface:/app/logs
      - /mnt/myssd/Lucid/Lucid/data/admin-interface:/app/data
    networks:
      - lucid-pi-network
      - lucid-gui-network
    depends_on:
      gui-api-bridge:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://127.0.0.1:8120/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    labels:
      - "com.lucid.phase=gui"
      - "com.lucid.service=admin-interface"
      - "com.lucid.cluster=gui-integration"
      - "com.lucid.profile=admin"
    user: "65532:65532"
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=100m

  # User Interface - Distroless Electron GUI
  user-interface:
    image: pickme/lucid-user-interface:latest-arm64
    container_name: lucid-user-interface
    restart: unless-stopped
    env_file:
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.secrets
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.core
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.application
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.foundation
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.gui
    ports:
      - "3001:3001"
    environment:
      - NODE_ENV=production
      - ELECTRON_GUI_PROFILE=user
      - ELECTRON_GUI_NETWORK=lucid-pi-network
      - ELECTRON_GUI_API_BASE_URL=http://lucid-gui-api-bridge:8102/api/v1
      - ELECTRON_GUI_CONFIG_FILE=/app/configs/api-services-user.conf
      - LOG_LEVEL=INFO
      - LUCID_ENV=production
    volumes:
      - /mnt/myssd/Lucid/Lucid/logs/user-interface:/app/logs
      - /mnt/myssd/Lucid/Lucid/data/user-interface:/app/data
    networks:
      - lucid-pi-network
      - lucid-gui-network
    depends_on:
      gui-api-bridge:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://127.0.0.1:3001/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    labels:
      - "com.lucid.phase=gui"
      - "com.lucid.service=user-interface"
      - "com.lucid.cluster=gui-integration"
      - "com.lucid.profile=user"
    user: "65532:65532"
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=100m

  # Node Operator Interface - Distroless Electron GUI
  node-interface:
    image: pickme/lucid-node-interface:latest-arm64
    container_name: lucid-node-interface
    restart: unless-stopped
    env_file:
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.secrets
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.core
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.application
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.foundation
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.gui
    ports:
      - "3002:3002"
    environment:
      - NODE_ENV=production
      - ELECTRON_GUI_PROFILE=node_operator
      - ELECTRON_GUI_NETWORK=lucid-pi-network
      - ELECTRON_GUI_API_BASE_URL=http://lucid-gui-api-bridge:8102/api/v1
      - ELECTRON_GUI_CONFIG_FILE=/app/configs/api-services-node.conf
      - LOG_LEVEL=INFO
      - LUCID_ENV=production
    volumes:
      - /mnt/myssd/Lucid/Lucid/logs/node-interface:/app/logs
      - /mnt/myssd/Lucid/Lucid/data/node-interface:/app/data
    networks:
      - lucid-pi-network
      - lucid-gui-network
    depends_on:
      gui-api-bridge:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://127.0.0.1:3002/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    labels:
      - "com.lucid.phase=gui"
      - "com.lucid.service=node-interface"
      - "com.lucid.cluster=gui-integration"
      - "com.lucid.profile=node_operator"
    user: "65532:65532"
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=100m

# ===========================================
# VOLUMES
# ===========================================
volumes:
  # Onion state shared between tor-proxy and gui-tor-manager
  onion-state:
    name: onion-state
    driver: local

# ===========================================
# NETWORKS
# ===========================================
networks:
  # Main Pi network (external)
  lucid-pi-network:
    name: lucid-pi-network
    external: true

  # GUI-specific network for secure communication
  lucid-gui-network:
    name: lucid-gui-network
    driver: bridge
    attachable: true
    ipam:
      config:
        - subnet: 172.22.0.0/16
          gateway: 172.22.0.1
# ===========================================
