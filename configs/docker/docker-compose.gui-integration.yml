# GUI-Docker Integration Configuration
# Integrates Electron GUI with Docker backend services
# Step 33: GUI Environment Configuration from lucid-container-build-plan.plan.md

name: lucid-gui-integration
services:
  # ===========================================
  # GUI BACKEND SERVICES
  # ===========================================

  # GUI API Bridge Service
  gui-api-bridge:
    image: pickme/lucid-gui-api-bridge:latest-arm64
    container_name: lucid-gui-api-bridge
    restart: unless-stopped
    env_file:
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.secrets
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.core
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.application
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.foundation
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.gui
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.gui-api-bridge
    ports:
      - "8102:8102"
    volumes:
      - /mnt/myssd/Lucid/Lucid/logs/gui-api-bridge:/app/logs
      - /mnt/myssd/Lucid/Lucid/data/gui-api-bridge:/app/data
    networks:
      - lucid-pi-network
      - lucid-gui-network
    depends_on:
      api-gateway:
        condition: service_healthy
    healthcheck:
      test:
        [
          "CMD",
          "python3",
          "-c",
          "import socket; s = socket.socket(); s.settimeout(2); result = s.connect_ex(('127.0.0.1', 8102)); s.close(); exit(0 if result == 0 else 1)",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    labels:
      - "com.lucid.phase=gui"
      - "com.lucid.service=gui-api-bridge"
      - "com.lucid.cluster=gui-integration"
    user: "65532:65532"
    security_opt:
      - no-new-privileges:true
      - seccomp:unconfined
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE # Only for services that bind ports
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=100m

  # GUI Docker Manager Service
  gui-docker-manager:
    image: pickme/lucid-gui-docker-manager:latest-arm64
    container_name: lucid-gui-docker-manager
    restart: unless-stopped
    env_file:
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.secrets
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.core
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.application
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.foundation
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.gui
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.gui-docker-manager
    ports:
      - "8098:8098"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /mnt/myssd/Lucid/Lucid/logs/gui-docker-manager:/app/logs
      - /mnt/myssd/Lucid/Lucid/data/gui-docker-manager:/app/data
    networks:
      - lucid-pi-network
      - lucid-gui-network
    depends_on:
      lucid-mongodb:
        condition: service_healthy
      lucid-redis:
        condition: service_healthy
      api-gateway:
        condition: service_healthy
    healthcheck:
      test:
        [
          "CMD",
          "python3",
          "-c",
          "import socket; s = socket.socket(); s.settimeout(2); result = s.connect_ex(('127.0.0.1', 8098)); s.close(); exit(0 if result == 0 else 1)",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    labels:
      - "com.lucid.phase=gui"
      - "com.lucid.service=gui-docker-manager"
      - "com.lucid.cluster=gui-integration"
    user: "65532:65532"
    security_opt:
      - no-new-privileges:true
      - seccomp:unconfined
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE # Only for services that bind ports
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=100m
  # GUI Tor Manager Service
  gui-tor-manager:
    image: pickme/lucid-gui-tor-manager:latest-arm64
    container_name: lucid-gui-tor-manager
    restart: unless-stopped
    env_file:
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.secrets
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.core
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.application
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.foundation
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.gui
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.gui-tor-manager
    ports:
      - "8097:8097"
    volumes:
      - /mnt/myssd/Lucid/Lucid/data/tor:/app/tor-data:rw
      - /mnt/myssd/Lucid/Lucid/logs/gui-tor-manager:/app/logs:rw
      - onion-state:/run/lucid/onion:ro # ADDED: Read onion state from tor-proxy
    networks:
      - lucid-gui-network
      - lucid-pi-network # ADDED: To connect to tor-proxy
    depends_on:
      tor-proxy: # ADDED: Dependency on foundation tor-proxy
        condition: service_started
    healthcheck:
      test: [
          "CMD",
          "python3",
          "-c",
          "import socket; s = socket.socket(); s.settimeout(2); result = s.connect_ex(('127.0.0.1', 8097)); s.close(); exit(0 if result == 0 else 1)",
        ] # FIXED: Python socket check
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 60s
    labels:
      - "com.lucid.phase=gui"
      - "com.lucid.service=gui-tor-manager"
      - "com.lucid.cluster=gui-integration"
    user: "65532:65532"
    security_opt:
      - no-new-privileges:true
      - seccomp:unconfined
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE # Only for services that bind ports
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=100m
  # GUI Hardware Manager Service
  gui-hardware-manager:
    image: pickme/lucid-gui-hardware-manager:latest-arm64
    container_name: lucid-gui-hardware-manager
    restart: unless-stopped
    env_file:
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.secrets
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.core
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.application
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.foundation
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.gui
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.gui-hardware-manager
    ports:
      - "8099:8099"
    volumes:
      - /mnt/myssd/Lucid/Lucid/logs/gui-hardware-manager:/app/logs
      - /mnt/myssd/Lucid/Lucid/data/gui-hardware-manager:/app/data
      # Writable tmpfs for USB device access (environment-aware path)
      - /run/usb-devices:/run/usb:rw
    networks:
      - lucid-pi-network
      - lucid-gui-network
    depends_on:
      tor-proxy:
        condition: service_started
      lucid-mongodb:
        condition: service_healthy
      lucid-redis:
        condition: service_healthy
      lucid-auth-service:
        condition: service_healthy
      api-gateway:
        condition: service_healthy
      gui-api-bridge:
        condition: service_healthy
    healthcheck:
      test:
        [
          "CMD",
          "python3",
          "-c",
          "import socket; s = socket.socket(); s.settimeout(2); result = s.connect_ex(('127.0.0.1', 8099)); s.close(); exit(0 if result == 0 else 1)",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    labels:
      - "com.lucid.phase=gui"
      - "com.lucid.service=gui-hardware-manager"
      - "com.lucid.cluster=gui-integration"
    user: "65532:65532"
    security_opt:
      - no-new-privileges:true
      - seccomp:unconfined
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=100m

  # ===========================================
  # ELECTRON GUI INTERFACES (Distroless)
  # ===========================================

  # Admin Interface - Distroless Electron GUI
  admin-interface:
    image: pickme/lucid-admin-interface:latest-arm64
    container_name: lucid-admin-interface
    restart: unless-stopped
    env_file:
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.secrets
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.core
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.application
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.foundation
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.gui
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.admin-interface
    ports:
      - "8120:8120"
      - "8100:8100"
    volumes:
      - /mnt/myssd/Lucid/Lucid/logs/admin-interface:/app/logs
      - /mnt/myssd/Lucid/Lucid/data/admin-interface:/app/data
    networks:
      - lucid-pi-network
      - lucid-gui-network
    depends_on:
      gui-api-bridge:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://127.0.0.1:8120/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    labels:
      - "com.lucid.phase=gui"
      - "com.lucid.service=admin-interface"
      - "com.lucid.cluster=gui-integration"
      - "com.lucid.profile=admin"
    user: "65532:65532"
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=100m

  # User Interface - Distroless Electron GUI
  user-interface:
    image: pickme/lucid-user-interface:latest-arm64
    container_name: lucid-user-interface
    restart: unless-stopped
    env_file:
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.secrets
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.core
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.application
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.foundation
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.gui
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.user-interface
    ports:
      - "3001:3001"
    volumes:
      - /mnt/myssd/Lucid/Lucid/logs/user-interface:/app/logs
      - /mnt/myssd/Lucid/Lucid/data/user-interface:/app/data
    networks:
      - lucid-pi-network
      - lucid-gui-network
    depends_on:
      gui-api-bridge:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://127.0.0.1:3001/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    labels:
      - "com.lucid.phase=gui"
      - "com.lucid.service=user-interface"
      - "com.lucid.cluster=gui-integration"
      - "com.lucid.profile=user"
    user: "65532:65532"
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=100m

  # Node Operator Interface - Distroless Electron GUI
  node-interface:
    image: pickme/lucid-node-interface:latest-arm64
    container_name: lucid-node-interface
    restart: unless-stopped
    env_file:
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.secrets
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.core
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.application
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.foundation
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.gui
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.node-interface
    ports:
      - "3002:3002"
    volumes:
      - /mnt/myssd/Lucid/Lucid/logs/node-interface:/app/logs
      - /mnt/myssd/Lucid/Lucid/data/node-interface:/app/data
    networks:
      - lucid-pi-network
      - lucid-gui-network
    depends_on:
      gui-api-bridge:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://127.0.0.1:3002/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    labels:
      - "com.lucid.phase=gui"
      - "com.lucid.service=node-interface"
      - "com.lucid.cluster=gui-integration"
      - "com.lucid.profile=node_operator"
    user: "65532:65532"
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=100m

# ===========================================
# VOLUMES
# ===========================================
volumes:
  # Onion state shared between tor-proxy and gui-tor-manager
  onion-state:
    name: onion-state
    external: true

# ===========================================
# NETWORKS
# ===========================================
networks:
  # Main Pi network (external)
  lucid-pi-network:
    name: lucid-pi-network
    external: true

  # GUI-specific network for secure communication
  lucid-gui-network:
    name: lucid-gui-network
    driver: bridge
    attachable: true
    ipam:
      config:
        - subnet: 172.22.0.0/16
          gateway: 172.22.0.1
# ===========================================
