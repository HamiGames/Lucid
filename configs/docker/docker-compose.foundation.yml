name: lucid-foundation
services:
  tor-proxy:
    image: pickme/lucid-tor-proxy:latest-arm64
    container_name: tor-proxy
    restart: unless-stopped
    env_file:
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.tor-proxy
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.foundation
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.secrets
    networks:
      lucid-pi-network:
        ipv4_address: 172.20.0.9
    ports:
      - "${TOR_PROXY_SOCKS_PORT:-9050}:${TOR_PROXY_SOCKS_PORT:-9050}"
      - "${TOR_PROXY_CONTROL_PORT:-9051}:${TOR_PROXY_CONTROL_PORT:-9051}"
      - "${TOR_PROXY_HTTP_PORT:-8888}:${TOR_PROXY_HTTP_PORT:-8888}"
    entrypoint: ["/usr/bin/tini", "--"]
    command: ["/usr/local/bin/entrypoint.sh"]
    volumes:
      - /mnt/myssd/Lucid/Lucid/data/tor:/var/lib/tor:rw
      - /mnt/myssd/Lucid/Lucid/logs/tor:/var/log/tor:rw
      - /mnt/myssd/Lucid/Lucid/02-network-security/tor/scripts:/usr/local/bin/tor-scripts:ro
      - tor-config:/etc/tor
      - onion-state:/run/lucid/onion
    healthcheck:
      test: ["CMD", "/bin/bash", "/usr/local/bin/tor-health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 45s
    labels:
      - "lucid.service=tor-proxy"
      - "lucid.type=distroless"
      - "lucid.platform=arm64"
      - "lucid.cluster=foundation"

  lucid-base:
    image: pickme/lucid-base:latest-arm64
    container_name: lucid-base
    restart: unless-stopped
    env_file:
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.foundation
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.distroless
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.core
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.secrets
    networks:
      lucid-pi-network:
        ipv4_address: ${LUCID_BASE_IP}
    volumes:
      - /mnt/myssd/Lucid/Lucid/logs/base:/var/log/lucid-base:rw
    labels:
      - "lucid.service=base-core"
      - "lucid.type=distroless"
      - "lucid.platform=arm64"
      - "lucid.cluster=foundation"

  lucid-base-python:
    image: pickme/lucid-base:python-distroless-arm64
    container_name: lucid-base-python
    restart: unless-stopped
    env_file:
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.foundation
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.distroless
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.core
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.secrets
    networks:
      lucid-pi-network:
        ipv4_address: ${LUCID_BASE_PY_IP}
    volumes:
      - /mnt/myssd/Lucid/Lucid/logs/python-base:/var/log/python-base:rw
    labels:
      - "lucid.service=base-python"
      - "lucid.type=distroless"
      - "lucid.platform=arm64"
      - "lucid.cluster=foundation"

  lucid-base-java:
    image: pickme/lucid-base:java-distroless-arm64
    container_name: lucid-base-java
    restart: unless-stopped
    env_file:
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.foundation
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.distroless
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.core
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.secrets
    networks:
      lucid-pi-network:
        ipv4_address: ${LUCID_BASE_JAVA_IP}
    volumes:
      - /mnt/myssd/Lucid/Lucid/logs/java-base:/var/log/java-base:rw
    labels:
      - "lucid.service=base-java"
      - "lucid.type=distroless"
      - "lucid.platform=arm64"
      - "lucid.cluster=foundation"

  lucid-server-tools:
    image: pickme/lucid-server-tools:latest-arm64
    container_name: lucid-server-tools
    restart: unless-stopped
    env_file:
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.foundation
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.server-tools
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.distroless
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.secrets
    depends_on:
      tor-proxy:
        condition: service_started
      lucid-redis:
        condition: service_healthy
    networks:
      lucid-pi-network:
        ipv4_address: ${LUCID_SERVER_TOOLS_IP}
    volumes:
      - /mnt/myssd/Lucid/Lucid/logs/server-tools:/var/log/server-tools:rw
    labels:
      - "lucid.service=server-tools"
      - "lucid.type=distroless"
      - "lucid.platform=arm64"
      - "lucid.cluster=foundation"

  lucid-service-mesh-controller:
    image: pickme/lucid-service-mesh-controller:latest-arm64
    container_name: lucid-service-mesh-controller
    restart: unless-stopped
    env_file:
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.foundation
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.support
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.distroless
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.secrets
    networks:
      lucid-pi-network:
        ipv4_address: ${LUCID_SERVICE_MESH_IP}
    volumes:
      - /mnt/myssd/Lucid/Lucid/logs/service-mesh:/var/log/service-mesh:rw
    depends_on:
      tor-proxy:
        condition: service_started
    entrypoint: ["python3"]
    command:
      [
        "-c",
        "import asyncio; from controller.main import main; asyncio.run(main())",
      ]
    labels:
      - "lucid.service=service-mesh-controller"
      - "lucid.type=distroless"
      - "lucid.platform=arm64"
      - "lucid.cluster=foundation"

  lucid-mongodb:
    image: pickme/lucid-mongodb:latest-arm64
    container_name: lucid-mongodb
    restart: unless-stopped
    env_file:
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.foundation
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.secrets
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.distroless
    networks:
      lucid-pi-network:
        ipv4_address: 172.20.0.11
    ports:
      - "${MONGODB_PORT}:${MONGODB_PORT}"
    entrypoint: []
    command:
      - /usr/bin/mongod
      - --auth
      - --bind_ip_all
      - --dbpath=/data/db
      - --logpath=/var/log/mongodb/mongod.log
      - --logappend
    depends_on:
      tor-proxy:
        condition: service_started
    user: "65532:65532"
    security_opt:
      - no-new-privileges:true
      - seccomp:unconfined
    cap_drop: ["ALL"]
    cap_add: ["NET_BIND_SERVICE"]
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=200m
    volumes:
      - /mnt/myssd/Lucid/Lucid/data/mongodb:/data/db:rw
      - /mnt/myssd/Lucid/Lucid/logs/mongodb:/var/log/mongodb:rw
      - mongodb-cache:/var/cache/mongodb
    healthcheck:
      test: ["CMD-SHELL", "mongosh --quiet --eval 'db.runCommand({ ping: 1 })'"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    labels:
      - "lucid.service=mongodb"
      - "lucid.type=distroless"
      - "lucid.platform=arm64"
      - "lucid.cluster=foundation"

  lucid-redis:
    image: pickme/lucid-redis:latest-arm64
    container_name: lucid-redis
    restart: unless-stopped
    env_file:
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.foundation
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.secrets
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.distroless
    networks:
      lucid-pi-network:
        ipv4_address: 172.20.0.12
    ports:
      - "${REDIS_PORT}:${REDIS_PORT}"
    depends_on:
      tor-proxy:
        condition: service_started
    user: "65532:65532"
    security_opt:
      - no-new-privileges:true
      - seccomp:unconfined
    cap_drop: ["ALL"]
    cap_add: ["NET_BIND_SERVICE"]
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=100m
    volumes:
      - /mnt/myssd/Lucid/Lucid/data/redis:/data:rw
      - /mnt/myssd/Lucid/Lucid/logs/redis:/var/log/redis:rw
      - redis-cache:/var/cache/redis
    healthcheck:
      test:
        ["CMD", "/usr/local/bin/redis-cli", "-a", "${REDIS_PASSWORD}", "ping"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    labels:
      - "lucid.service=redis"
      - "lucid.type=distroless"
      - "lucid.platform=arm64"
      - "lucid.cluster=foundation"

  lucid-elasticsearch:
    image: pickme/lucid-elasticsearch:latest-arm64
    container_name: lucid-elasticsearch
    restart: unless-stopped
    env_file:
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.foundation
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.secrets
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.distroless
    networks:
      lucid-pi-network:
        ipv4_address: 172.20.0.13
    ports:
      - "${ELASTICSEARCH_HTTP_PORT:-9200}:${ELASTICSEARCH_HTTP_PORT:-9200}"
      - "${ELASTICSEARCH_TRANSPORT_PORT:-9300}:${ELASTICSEARCH_TRANSPORT_PORT:-9300}"
    environment:
      - "ES_JAVA_OPTS=-Xms${ES_JAVA_HEAP:-256m} -Xmx${ES_JAVA_HEAP:-256m}"
      - "discovery.type=single-node"
      - "xpack.security.enabled=false"
    depends_on:
      tor-proxy:
        condition: service_started
    user: "65532:65532"
    security_opt:
      - no-new-privileges:true
      - seccomp:unconfined
    cap_drop: ["ALL"]
    cap_add: ["NET_BIND_SERVICE"]
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=200m
    volumes:
      - /mnt/myssd/Lucid/Lucid/data/elasticsearch:/usr/share/elasticsearch/data:rw
      - /mnt/myssd/Lucid/Lucid/logs/elasticsearch:/usr/share/elasticsearch/logs:rw
      - elasticsearch-cache:/tmp/elasticsearch
    healthcheck:
      test:
        ["CMD", "/usr/bin/curl", "-f", "http://localhost:9200/_cluster/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    labels:
      - "lucid.service=elasticsearch"
      - "lucid.type=distroless"
      - "lucid.platform=arm64"
      - "lucid.cluster=foundation"

  lucid-auth-service:
    image: pickme/lucid-auth-service:latest-arm64
    container_name: lucid-auth-service
    restart: unless-stopped
    env_file:
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.foundation
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.authentication
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.secrets
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.distroless
    networks:
      lucid-pi-network:
        ipv4_address: 172.20.0.14
    ports:
      - "${AUTH_SERVICE_PORT:-8089}:${AUTH_SERVICE_PORT:-8089}"
    working_dir: /app
    entrypoint: ["python3"]
    command: ["main.py"]
    depends_on:
      tor-proxy:
        condition: service_started
      lucid-mongodb:
        condition: service_healthy
      lucid-redis:
        condition: service_healthy
    user: "65532:65532"
    security_opt:
      - no-new-privileges:true
      - seccomp:unconfined
    cap_drop: ["ALL"]
    cap_add: ["NET_BIND_SERVICE"]
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=100m
    volumes:
      - /mnt/myssd/Lucid/Lucid/logs/auth:/app/logs:rw
      - auth-cache:/tmp/auth
    healthcheck:
      test: [
          "CMD",
          "python3",
          "-c",
          'import os, urllib.request, sys; port = os.getenv("AUTH_SERVICE_PORT", "8089"); \
          try: \
          resp = urllib.request.urlopen(f"http://localhost:{port}/health", timeout=5); \
          sys.exit(0 if resp.getcode() == 200 else 1); \
          except Exception: \
          sys.exit(1)',
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    labels:
      - "lucid.service=auth-service"
      - "lucid.type=distroless"
      - "lucid.platform=arm64"
      - "lucid.cluster=foundation"

volumes:
  mongodb-cache:
    driver: local
    name: lucid-mongodb-cache
  redis-cache:
    driver: local
    name: lucid-redis-cache
  elasticsearch-cache:
    driver: local
    name: lucid-elasticsearch-cache
  auth-cache:
    driver: local
    name: lucid-auth-cache
  tor-config:
    name: lucid-tor-config
    external: true
  onion-state:
    name: lucid-onion-state
    external: true

networks:
  lucid-pi-network:
    external: true
    name: lucid-pi-network
