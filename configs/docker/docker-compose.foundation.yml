version: "3.8"

services:
  lucid-mongodb:
    image: pickme/lucid-mongodb:latest-arm64
    container_name: lucid-mongodb
    restart: unless-stopped
    env_file:
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.foundation
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.secrets
    networks:
      - lucid-pi-network
    environment:
      - LUCID_ENV=production
      - LUCID_PLATFORM=arm64
      - MONGODB_HOST=lucid-mongodb
      - MONGODB_PORT=27017
      - MONGODB_DATABASE=lucid
      - MONGODB_USERNAME=lucid
      - MONGODB_PASSWORD=${MONGODB_PASSWORD}
      - MONGODB_AUTH_SOURCE=admin
      - MONGODB_RETRY_WRITES=false
    user: "65532:65532"
    security_opt:
      - no-new-privileges:true
      - seccomp:unconfined
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=200m
    volumes:
      - /mnt/myssd/Lucid/Lucid/data/mongodb:/data/db:rw
      - /mnt/myssd/Lucid/Lucid/logs/mongodb:/var/log/mongodb:rw
      - mongodb-cache:/var/cache/mongodb
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 27017 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    labels:
      - "lucid.service=mongodb"
      - "lucid.type=distroless"
      - "lucid.platform=arm64"
      - "lucid.security=hardened"
      - "lucid.cluster=foundation"

  lucid-redis:
    image: pickme/lucid-redis:latest-arm64
    container_name: lucid-redis
    restart: unless-stopped
    env_file:
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.secrets
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.foundation
    networks:
      - lucid-pi-network
    environment:
      - LUCID_ENV=production
      - LUCID_PLATFORM=arm64
      - REDIS_HOST=lucid-redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD}
    # FIX: Override command to run without config file
    command:
      [
        "/usr/local/bin/redis-server",
        "--bind",
        "0.0.0.0",
        "--port",
        "6379",
        "--dir",
        "/data",
      ]
    # OR create config file in tmpfs
    # command: ["sh", "-c", "echo 'port 6379\nbind 0.0.0.0\ndir /data' > /tmp/redis.conf && /usr/local/bin/redis-server /tmp/redis.conf"]
    user: "65532:65532"
    security_opt:
      - no-new-privileges:true
      - seccomp:unconfined
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=100m
    volumes:
      - /mnt/myssd/Lucid/Lucid/data/redis:/data:rw
      - /mnt/myssd/Lucid/Lucid/logs/redis:/var/log/redis:rw
      - redis-cache:/var/cache/redis
    healthcheck:
      test:
        [
          "CMD",
          "python3",
          "-c",
          "import socket; s=socket.socket(); s.connect(('localhost', 6379)); s.close(); exit(0)",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    labels:
      - "lucid.service=redis"
      - "lucid.type=distroless"
      - "lucid.platform=arm64"
      - "lucid.security=hardened"
      - "lucid.cluster=foundation"

  lucid-elasticsearch:
    image: pickme/lucid-elasticsearch:latest-arm64
    container_name: lucid-elasticsearch
    restart: unless-stopped
    env_file:
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.secrets
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.foundation
    networks:
      - lucid-pi-network
    environment:
      - LUCID_ENV=production
      - LUCID_PLATFORM=arm64
      - ELASTICSEARCH_HOST=lucid-elasticsearch
      - ELASTICSEARCH_PORT=9200
      - ELASTICSEARCH_USERNAME=elastic
      - ELASTICSEARCH_PASSWORD=${ELASTICSEARCH_PASSWORD}
    # FIX: Override entrypoint - elasticsearch binary is not a JAR
    entrypoint: []
    command: ["/usr/share/elasticsearch/bin/elasticsearch"]
    user: "65532:65532"
    security_opt:
      - no-new-privileges:true
      - seccomp:unconfined
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=200m
    volumes:
      - /mnt/myssd/Lucid/Lucid/data/elasticsearch:/usr/share/elasticsearch/data:rw
      - /mnt/myssd/Lucid/Lucid/logs/elasticsearch:/usr/share/elasticsearch/logs:rw
      - elasticsearch-cache:/tmp/elasticsearch
    healthcheck:
      test:
        [
          "CMD",
          "python3",
          "-c",
          "import urllib.request; urllib.request.urlopen('http://localhost:9200/_cluster/health').read(); exit(0)",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    labels:
      - "lucid.service=elasticsearch"
      - "lucid.type=distroless"
      - "lucid.platform=arm64"
      - "lucid.security=hardened"
      - "lucid.cluster=foundation"

  lucid-auth-service:
    image: pickme/lucid-auth-service:latest-arm64
    container_name: lucid-auth-service
    restart: unless-stopped
    env_file:
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.secrets
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.foundation
    networks:
      - lucid-pi-network
    environment:
      - LUCID_ENV=production
      - LUCID_PLATFORM=arm64
      - AUTH_SERVICE_HOST=lucid-auth-service
      - AUTH_SERVICE_PORT=8089
      - AUTH_SERVICE_URL=http://lucid-auth-service:8089
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
      - JWT_ALGORITHM=HS256
      - JWT_EXPIRATION=3600
      - MONGODB_URL=${MONGODB_URL}
      - REDIS_URL=${REDIS_URL}
    # FIX: Override entrypoint to use python3 and check if uvicorn is available
    entrypoint: ["python3"]
    command: ["main.py"]
    # OR if uvicorn is missing, we need to check if it's in the image
    # First check: docker run --rm pickme/lucid-auth-service:latest-arm64 python3 -c "import uvicorn; print('OK')"
    user: "65532:65532"
    security_opt:
      - no-new-privileges:true
      - seccomp:unconfined
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=100m
    volumes:
      - /mnt/myssd/Lucid/Lucid/logs/auth-service:/app/logs:rw
      - auth-cache:/tmp/auth
    healthcheck:
      test:
        [
          "CMD",
          "python3",
          "-c",
          "import urllib.request; urllib.request.urlopen('http://localhost:8089/health').read(); exit(0)",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    labels:
      - "lucid.service=auth-service"
      - "lucid.type=distroless"
      - "lucid.platform=arm64"
      - "lucid.security=hardened"
      - "lucid.cluster=foundation"

volumes:
  mongodb-cache:
    driver: local
    name: lucid-mongodb-cache
  redis-cache:
    driver: local
    name: lucid-redis-cache
  elasticsearch-cache:
    driver: local
    name: lucid-elasticsearch-cache
  auth-cache:
    driver: local
    name: lucid-auth-cache

networks:
  lucid-pi-network:
    external: true
    name: lucid-pi-network
