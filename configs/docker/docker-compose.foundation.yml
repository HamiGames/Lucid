version: '3.8'

services:
  lucid-mongodb:
    image: pickme/lucid-mongodb:latest-arm64
    container_name: lucid-mongodb
    restart: unless-stopped
    networks:
      - lucid-pi-network
    environment:
      - LUCID_ENV=production
      - LUCID_PLATFORM=arm64
      - MONGODB_HOST=lucid-mongodb
      - MONGODB_PORT=27017
      - MONGODB_DATABASE=lucid
      - MONGODB_USERNAME=lucid
      - MONGODB_PASSWORD=${MONGODB_PASSWORD}
      - MONGODB_AUTH_SOURCE=admin
      - MONGODB_RETRY_WRITES=false
    user: "65532:65532"
    security_opt:
      - no-new-privileges:true
      - seccomp:unconfined
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=200m
    volumes:
      - /mnt/myssd/Lucid/data/mongodb:/data/db:rw
      - /mnt/myssd/Lucid/logs/mongodb:/var/log/mongodb:rw
      - mongodb-cache:/var/cache/mongodb
    healthcheck:
      test: ["CMD", "python3", "-c", "import sys; sys.exit(0)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    labels:
      - "lucid.service=mongodb"
      - "lucid.type=distroless"
      - "lucid.platform=arm64"
      - "lucid.security=hardened"
      - "lucid.cluster=foundation"

  lucid-redis:
    image: pickme/lucid-redis:latest-arm64
    container_name: lucid-redis
    restart: unless-stopped
    networks:
      - lucid-pi-network
    environment:
      - LUCID_ENV=production
      - LUCID_PLATFORM=arm64
      - REDIS_HOST=lucid-redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD}
    user: "65532:65532"
    security_opt:
      - no-new-privileges:true
      - seccomp:unconfined
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=100m
    volumes:
      - /mnt/myssd/Lucid/data/redis:/data:rw
      - /mnt/myssd/Lucid/logs/redis:/var/log/redis:rw
      - redis-cache:/var/cache/redis
    healthcheck:
      test: ["CMD", "python3", "-c", "import sys; sys.exit(0)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    labels:
      - "lucid.service=redis"
      - "lucid.type=distroless"
      - "lucid.platform=arm64"
      - "lucid.security=hardened"
      - "lucid.cluster=foundation"

  lucid-elasticsearch:
    image: pickme/lucid-elasticsearch:latest-arm64
    container_name: lucid-elasticsearch
    restart: unless-stopped
    networks:
      - lucid-pi-network
    environment:
      - LUCID_ENV=production
      - LUCID_PLATFORM=arm64
      - ELASTICSEARCH_HOST=lucid-elasticsearch
      - ELASTICSEARCH_PORT=9200
      - ELASTICSEARCH_USERNAME=elastic
      - ELASTICSEARCH_PASSWORD=${ELASTICSEARCH_PASSWORD}
    user: "65532:65532"
    security_opt:
      - no-new-privileges:true
      - seccomp:unconfined
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=200m
    volumes:
      - /mnt/myssd/Lucid/data/elasticsearch:/usr/share/elasticsearch/data:rw
      - /mnt/myssd/Lucid/logs/elasticsearch:/usr/share/elasticsearch/logs:rw
      - elasticsearch-cache:/tmp/elasticsearch
    healthcheck:
      test: ["CMD", "python3", "-c", "import sys; sys.exit(0)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    labels:
      - "lucid.service=elasticsearch"
      - "lucid.type=distroless"
      - "lucid.platform=arm64"
      - "lucid.security=hardened"
      - "lucid.cluster=foundation"

  lucid-auth-service:
    image: pickme/lucid-auth-service:latest-arm64
    container_name: lucid-auth-service
    restart: unless-stopped
    networks:
      - lucid-pi-network
    environment:
      - LUCID_ENV=production
      - LUCID_PLATFORM=arm64
      - AUTH_SERVICE_HOST=lucid-auth-service
      - AUTH_SERVICE_PORT=8089
      - AUTH_SERVICE_URL=http://lucid-auth-service:8089
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
      - JWT_ALGORITHM=HS256
      - JWT_EXPIRATION=3600
      - MONGODB_URL=${MONGODB_URL}
      - REDIS_URL=${REDIS_URL}
    user: "65532:65532"
    security_opt:
      - no-new-privileges:true
      - seccomp:unconfined
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=100m
    volumes:
      - /mnt/myssd/Lucid/logs/auth-service:/app/logs:rw
      - auth-cache:/tmp/auth
    healthcheck:
      test: ["CMD", "python3", "-c", "import sys; sys.exit(0)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    labels:
      - "lucid.service=auth-service"
      - "lucid.type=distroless"
      - "lucid.platform=arm64"
      - "lucid.security=hardened"
      - "lucid.cluster=foundation"

volumes:
  mongodb-cache:
    driver: local
    name: lucid-mongodb-cache
  redis-cache:
    driver: local
    name: lucid-redis-cache
  elasticsearch-cache:
    driver: local
    name: lucid-elasticsearch-cache
  auth-cache:
    driver: local
    name: lucid-auth-cache

networks:
  lucid-pi-network:
    external: true
    name: lucid-pi-network