version: "3.8"

services:
  # =============================================================================
  # TOR PROXY GATEWAY - MUST START FIRST (Tor Portal for lucid-pi-network)
  # =============================================================================
  tor-proxy:
    image: pickme/lucid-tor-proxy:latest-arm64
    container_name: tor-proxy
    restart: unless-stopped
    env_file:
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.tor-proxy
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.secrets
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.foundation
    networks:
      lucid-pi-network:
        ipv4_address: 172.20.0.9
    ports:
      - "8888:8888"
      - "9050:9050"
      - "9051:9051"
    environment:
      - LUCID_ENV=production
      - LUCID_PLATFORM=arm64
      - TOR_SOCKS_PORT=${TOR_SOCKS_PORT:-9050}
      - TOR_CONTROL_PORT=${TOR_CONTROL_PORT:-9051}
      - TOR_DATA_DIR=/var/lib/tor
      - ONION_COUNT=${ONION_COUNT:-5}
      - CREATE_ONION=${CREATE_ONION:-1}
      - UPSTREAM_SERVICE=${UPSTREAM_SERVICE:-}
      - UPSTREAM_PORT=${UPSTREAM_PORT:-8081}
    entrypoint: ["/usr/bin/tini", "--"]
    command: ["/usr/local/bin/entrypoint.sh"]
    volumes:
      - /mnt/myssd/Lucid/Lucid/data/tor:/var/lib/tor:rw
      - /mnt/myssd/Lucid/Lucid/logs/tor:/var/log/tor:rw
      - /mnt/myssd/Lucid/Lucid/02-network-security/tor/scripts:/usr/local/bin/tor-scripts:ro
      - tor-config:/etc/tor
      - onion-state:/run/lucid/onion
    healthcheck:
      test: ["CMD", "/bin/bash", "/usr/local/bin/tor-health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 45s
    labels:
      - "lucid.service=tor-proxy"
      - "lucid.type=distroless"
      - "lucid.platform=arm64"
      - "lucid.security=hardened"
      - "lucid.cluster=foundation"
      - "lucid.tor.gateway=true"

  lucid-mongodb:
    image: pickme/lucid-mongodb:latest-arm64
    container_name: lucid-mongodb
    restart: unless-stopped
    env_file:
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.foundation
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.secrets
    networks:
      lucid-pi-network:
        ipv4_address: 172.20.0.11
    ports:
      - "27017:27017"
    environment:
      - LUCID_ENV=production
      - LUCID_PLATFORM=arm64
      - MONGODB_HOST=lucid-mongodb
      - MONGODB_PORT=27017
      - MONGODB_DATABASE=lucid
      - MONGO_INITDB_ROOT_USERNAME=lucid
      - MONGO_INITDB_ROOT_PASSWORD=${MONGODB_PASSWORD}
      - MONGO_INITDB_DATABASE=lucid
      - MONGODB_URI=mongodb://lucid:${MONGODB_PASSWORD}@lucid-mongodb:27017/lucid?authSource=admin
    depends_on:
      tor-proxy:
        condition: service_healthy
    user: "65532:65532"
    security_opt:
      - no-new-privileges:true
      - seccomp:unconfined
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=200m
    volumes:
      - /mnt/myssd/Lucid/Lucid/data/mongodb:/data/db:rw
      - /mnt/myssd/Lucid/Lucid/logs/mongodb:/var/log/mongodb:rw
      - mongodb-cache:/var/cache/mongodb
    healthcheck:
      test:
        [
          "CMD",
          "python3",
          "-c",
          "import socket; s=socket.socket(); s.connect(('localhost', 27017)); s.close(); exit(0)",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    labels:
      - "lucid.service=mongodb"
      - "lucid.type=distroless"
      - "lucid.platform=arm64"
      - "lucid.security=hardened"
      - "lucid.cluster=foundation"

  lucid-redis:
    image: pickme/lucid-redis:latest-arm64
    container_name: lucid-redis
    restart: unless-stopped
    env_file:
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.secrets
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.foundation
    networks:
      lucid-pi-network:
        ipv4_address: 172.20.0.12
    ports:
      - "6379:6379"
    environment:
      - LUCID_ENV=production
      - LUCID_PLATFORM=arm64
      - REDIS_HOST=172.20.0.12
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD}
      - REDIS_URL=redis://lucid-redis:6379/0
    command:
      - "/usr/local/bin/redis-server"
      - "--bind"
      - "0.0.0.0"
      - "--port"
      - "6379"
      - "--requirepass"
      - "${REDIS_PASSWORD}"
      - "--dir"
      - "/data"
      - "--daemonize"
      - "no"
    depends_on:
      tor-proxy:
        condition: service_healthy
    user: "65532:65532"
    security_opt:
      - no-new-privileges:true
      - seccomp:unconfined
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=100m
    volumes:
      - /mnt/myssd/Lucid/Lucid/data/redis:/data:rw
      - /mnt/myssd/Lucid/Lucid/logs/redis:/var/log/redis:rw
      - redis-cache:/var/cache/redis
    healthcheck:
      test:
        [
          "CMD",
          "python3",
          "-c",
          "import socket; s=socket.socket(); s.connect(('localhost', 6379)); s.close(); exit(0)",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    labels:
      - "lucid.service=redis"
      - "lucid.type=distroless"
      - "lucid.platform=arm64"
      - "lucid.security=hardened"
      - "lucid.cluster=foundation"

  lucid-elasticsearch:
    image: pickme/lucid-elasticsearch:latest-arm64
    container_name: lucid-elasticsearch
    restart: unless-stopped
    env_file:
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.secrets
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.foundation
    networks:
      lucid-pi-network:
        ipv4_address: 172.20.0.13
    ports:
      - "9200:9200"
      - "9300:9300"
    environment:
      - LUCID_ENV=production
      - LUCID_PLATFORM=arm64
      - ELASTICSEARCH_HOST=172.20.0.13
      - ELASTICSEARCH_HTTP_PORT=9200
      - ELASTICSEARCH_TRANSPORT_PORT=9300
      - ELASTICSEARCH_URI=http://lucid-elasticsearch:9200
      - discovery.type=single-node
      - xpack.security.enabled=false
      - ES_JAVA_OPTS=-Xms256m -Xmx256m
    entrypoint: []
    command:
      [
        "/usr/bin/java",
        "-Xms256m",
        "-Xmx256m",
        "-Des.network.host=0.0.0.0",
        "-Des.discovery.type=single-node",
        "-jar",
        "/usr/share/elasticsearch/lib/elasticsearch-*.jar",
      ]
    depends_on:
      tor-proxy:
        condition: service_healthy
    user: "65532:65532"
    security_opt:
      - no-new-privileges:true
      - seccomp:unconfined
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=200m
    volumes:
      - /mnt/myssd/Lucid/Lucid/data/elasticsearch:/usr/share/elasticsearch/data:rw
      - /mnt/myssd/Lucid/Lucid/logs/elasticsearch:/usr/share/elasticsearch/logs:rw
      - elasticsearch-cache:/tmp/elasticsearch
    healthcheck:
      test:
        [
          "CMD",
          "python3",
          "-c",
          "import urllib.request; urllib.request.urlopen('http://localhost:9200/_cluster/health').read(); exit(0)",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    labels:
      - "lucid.service=elasticsearch"
      - "lucid.type=distroless"
      - "lucid.platform=arm64"
      - "lucid.security=hardened"
      - "lucid.cluster=foundation"

  lucid-auth-service:
    image: pickme/lucid-auth-service:latest-arm64
    container_name: lucid-auth-service
    restart: unless-stopped
    env_file:
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.secrets
      - /mnt/myssd/Lucid/Lucid/configs/environment/.env.foundation
    networks:
      lucid-pi-network:
        ipv4_address: 172.20.0.14
    ports:
      - "8089:8089"
    environment:
      - LUCID_ENV=production
      - LUCID_PLATFORM=arm64
      - AUTH_SERVICE_HOST=172.20.0.14
      - AUTH_SERVICE_PORT=8089
      - AUTH_SERVICE_URL=http://lucid-auth-service:8089
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
      - JWT_ALGORITHM=HS256
      - MONGODB_URI=mongodb://lucid:${MONGODB_PASSWORD}@lucid-mongodb:27017/lucid_auth?authSource=admin
      - REDIS_URL=redis://lucid-redis:6379/6
      - TRON_NETWORK=mainnet
      - TRON_SIGNATURE_VERIFICATION_ENABLED=true
    depends_on:
      tor-proxy:
        condition: service_healthy
      lucid-mongodb:
        condition: service_healthy
      lucid-redis:
        condition: service_healthy
    entrypoint: ["python3"]
    command: ["main.py"]
    user: "65532:65532"
    security_opt:
      - no-new-privileges:true
      - seccomp:unconfined
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=100m
    volumes:
      - /mnt/myssd/Lucid/Lucid/logs/auth:/app/logs:rw
      - auth-cache:/tmp/auth
    healthcheck:
      test:
        [
          "CMD",
          "python3",
          "-c",
          "import urllib.request; urllib.request.urlopen('http://localhost:8089/health').read(); exit(0)",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    labels:
      - "lucid.service=auth-service"
      - "lucid.type=distroless"
      - "lucid.platform=arm64"
      - "lucid.security=hardened"
      - "lucid.cluster=foundation"

volumes:
  mongodb-cache:
    driver: local
    name: lucid-mongodb-cache
  redis-cache:
    driver: local
    name: lucid-redis-cache
  elasticsearch-cache:
    driver: local
    name: lucid-elasticsearch-cache
  auth-cache:
    driver: local
    name: lucid-auth-cache
  tor-config:
    driver: local
    name: lucid-tor-config
  onion-state:
    driver: local
    name: lucid-onion-state

networks:
  lucid-pi-network:
    external: true
    name: lucid-pi-network
