# Distroless Security Configuration for Lucid Project
# Security-focused configuration for distroless containers

version: '3.8'

services:
  # Security-hardened distroless configuration
  secure-distroless:
    image: pickme/lucid-base:latest-arm64
    environment:
      - PYTHONPATH=/app
      - PYTHONDONTWRITEBYTECODE=1
      - PYTHONUNBUFFERED=1
      - SECURITY_MODE=hardened
      - LOG_LEVEL=WARNING
    networks:
      - lucid-secure
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
      - seccomp:./seccomp-profiles/distroless-seccomp.json
      - apparmor:lucid-distroless
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=50m,mode=1777
      - /var/tmp:noexec,nosuid,size=25m,mode=1777
    cap_drop:
      - ALL
    cap_add: []
    user: "65532:65532"
    working_dir: /app
    healthcheck:
      test: ["python", "-c", "import sys; sys.exit(0)"]
      interval: 60s
      timeout: 5s
      retries: 2
      start_period: 10s
    ulimits:
      nofile:
        soft: 1024
        hard: 1024
      nproc:
        soft: 100
        hard: 100

  # Minimal security configuration
  minimal-secure:
    image: pickme/lucid-base:latest-arm64
    environment:
      - PYTHONPATH=/app
      - PYTHONDONTWRITEBYTECODE=1
      - PYTHONUNBUFFERED=1
      - SECURITY_MODE=minimal-secure
      - LOG_LEVEL=ERROR
    networks:
      - lucid-secure
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
      - seccomp:unconfined
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=25m,mode=1777
    cap_drop:
      - ALL
    user: "65532:65532"
    working_dir: /app
    healthcheck:
      test: ["python", "-c", "import sys; print('minimal secure healthy'); sys.exit(0)"]
      interval: 120s
      timeout: 5s
      retries: 1
      start_period: 5s
    ulimits:
      nofile:
        soft: 512
        hard: 512
      nproc:
        soft: 50
        hard: 50

  # Security monitoring for distroless containers
  security-monitor:
    image: pickme/lucid-base:latest-arm64
    environment:
      - PYTHONPATH=/app
      - SECURITY_MONITORING=true
      - LOG_LEVEL=INFO
    networks:
      - lucid-secure
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=100m
    cap_drop:
      - ALL
    cap_add:
      - NET_RAW
      - NET_ADMIN
    user: "65532:65532"
    working_dir: /app
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./security-logs:/logs:ro
    command: >
      python -c "
        print('Starting security monitoring...');
        import sys;
        sys.path.insert(0, '/app/scripts');
        exec(open('/app/scripts/security-monitor.py').read())
      "

networks:
  lucid-secure:
    name: lucid-pi-network
    external: true

volumes:
  security-logs:
    name: lucid-distroless-security-logs
  seccomp-profiles:
    name: lucid-seccomp-profiles
