# Distroless Build Configuration for Lucid Project
# Configuration for building distroless images with specific optimizations

version: '3.8'

services:
  # Build environment configuration
  distroless-builder:
    image: lucid/base:latest
    build:
      context: ../../infrastructure/docker/distroless/base
      dockerfile: Dockerfile.base.distroless
      platforms:
        - linux/amd64
        - linux/arm64
      args:
        BUILD_ENVIRONMENT: ${BUILD_ENVIRONMENT:-production}
        BUILD_TARGET: distroless
        OPTIMIZE_SIZE: ${OPTIMIZE_SIZE:-true}
        SECURITY_SCAN: ${SECURITY_SCAN:-true}
    environment:
      - BUILD_PLATFORM=${BUILD_PLATFORM:-linux/amd64,linux/arm64}
      - REGISTRY=${REGISTRY:-ghcr.io}
      - IMAGE_NAME=${IMAGE_NAME:-lucid}
      - VERSION=${VERSION:-latest}
      - PUSH_IMAGES=${PUSH_IMAGES:-false}
      - NO_CACHE=${NO_CACHE:-false}
    volumes:
      - ./build-cache:/cache
      - ./distroless-logs:/logs
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - build-network
    command: >
      sh -c "
        echo 'Starting distroless build process...' &&
        mkdir -p /cache /logs &&
        python /app/scripts/build-distroless.py
      "

  # Security scanner for distroless images
  security-scanner:
    image: aquasec/trivy:latest
    volumes:
      - ./security-reports:/reports
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - build-network
    command: >
      sh -c "
        echo 'Starting security scan...' &&
        mkdir -p /reports &&
        trivy image --format json --output /reports/security-report.json lucid/base:latest
      "

  # Layer optimizer for distroless images
  layer-optimizer:
    image: lucid/base:latest
    volumes:
      - ./optimization-reports:/reports
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - build-network
    environment:
      - OPTIMIZATION_TARGET=size
      - OPTIMIZATION_LEVEL=aggressive
    command: >
      sh -c "
        echo 'Starting layer optimization...' &&
        mkdir -p /reports &&
        python /app/scripts/optimize-layers.py --target distroless
      "

networks:
  build-network:
    driver: bridge
    name: lucid-distroless-build-network

volumes:
  build-cache:
    name: lucid-distroless-build-cache
  distroless-logs:
    name: lucid-distroless-logs
  security-reports:
    name: lucid-security-reports
  optimization-reports:
    name: lucid-optimization-reports
