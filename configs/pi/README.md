# Lucid Raspberry Pi Deployment Configuration

This directory contains configuration files and scripts for deploying Lucid to Raspberry Pi devices.

## Quick Start

1. **Generate SSH keys and configuration:**
   ```bash
   cd /path/to/Lucid
   ./scripts/build/env-build-pi.sh all
   ```

2. **Copy the public key to your Pi:**
   ```bash
   # On your Pi, add the public key to authorized_keys
   echo "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5..." >> ~/.ssh/authorized_keys
   chmod 600 ~/.ssh/authorized_keys
   ```

3. **Add GitHub secrets:**
   - Go to your repository Settings → Secrets and variables → Actions
   - Add `PI_SSH_KEY_B64` with the base64 encoded private key
   - Add `PI_USER` with your Pi username (default: pickme)

4. **Test deployment:**
   - Trigger the workflow manually or push to main branch
   - Monitor the deployment in the Actions tab

## Files

- `env-build-pi.sh` - Main setup script for generating keys and configuration
- `.env` - Environment configuration file (generated)
- `ssh/` - Directory containing SSH keys (generated)
- `github-secrets-instructions.md` - Instructions for configuring GitHub secrets

## Configuration

### Environment Variables

| Variable | Default | Description |
|----------|---------|-------------|
| `PI_HOST` | `192.168.0.75` | Raspberry Pi hostname or IP address |
| `PI_USER` | `pickme` | SSH username for Pi access |
| `PI_SSH_KEY_NAME` | `lucid_pi_key` | SSH key filename |

### GitHub Secrets

| Secret | Description | How to Get |
|--------|-------------|------------|
| `PI_SSH_KEY_B64` | Base64 encoded private SSH key | Generated by `env-build-pi.sh` |
| `PI_USER` | SSH username for Pi | Set in environment or script |

## Script Usage

The `env-build-pi.sh` script provides several commands:

```bash
# Generate SSH key pair
./scripts/build/env-build-pi.sh generate-keys

# Create environment configuration
./scripts/build/env-build-pi.sh setup-config

# Test SSH connection to Pi
./scripts/build/env-build-pi.sh validate

# Run all steps
./scripts/build/env-build-pi.sh all

# Show help
./scripts/build/env-build-pi.sh help
```

## Security Considerations

1. **SSH Key Security:**
   - Private keys are never committed to the repository
   - Keys are base64 encoded for GitHub secrets
   - Use ED25519 keys for better security

2. **Pi Configuration:**
   - Disable password authentication on Pi
   - Use key-based authentication only
   - Keep Pi updated with security patches

3. **Network Security:**
   - Use VPN or secure network for Pi access
   - Consider firewall rules for SSH access
   - Monitor SSH access logs

## Troubleshooting

### SSH Connection Issues

1. **Check Pi connectivity:**
   ```bash
   ping 192.168.0.75
   ```

2. **Verify SSH service:**
   ```bash
   ssh -v pickme@192.168.0.75
   ```

3. **Check key permissions:**
   ```bash
   ls -la ~/.ssh/
   chmod 600 ~/.ssh/authorized_keys
   ```

### GitHub Actions Issues

1. **Check secrets configuration:**
   - Verify secrets are properly set in repository settings
   - Ensure secret names match exactly: `PI_SSH_KEY_B64`, `PI_USER`

2. **Check workflow logs:**
   - Review Actions tab for detailed error messages
   - Look for SSH connection failures or permission issues

3. **Validate key format:**
   ```bash
   # Test base64 decoding
   echo "YOUR_BASE64_KEY" | base64 -d > test_key
   ssh-keygen -l -f test_key
   ```

## Deployment Workflow

The GitHub Actions workflow (`deploy-pi.yml`) performs these steps:

1. **Pre-deployment checks:**
   - Validate required secrets
   - Test SSH connectivity
   - Determine services to deploy

2. **Deployment preparation:**
   - Create deployment directory on Pi
   - Backup current deployment
   - Pull Docker images

3. **Service deployment:**
   - Stop existing services
   - Deploy new containers
   - Verify service health

4. **Post-deployment:**
   - Run health checks
   - Execute integration tests
   - Clean up old deployments

## Support

For issues or questions:

1. Check the troubleshooting section above
2. Review GitHub Actions logs
3. Verify Pi system requirements (Docker, disk space, etc.)
4. Ensure network connectivity between GitHub runners and Pi
