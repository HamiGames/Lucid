# Lucid RDP System - Fluentd Log Aggregation Configuration
# Step 49: Logging Configuration
# Document: BUILD_REQUIREMENTS_GUIDE.md Step 49

# ======================== Fluentd Configuration =========================

# ---------------------------------- System Settings ---------------------

<system>
  # Fluentd system configuration
  log_level info
  suppress_repeated_stacktrace true
  emit_error_log_interval 60s
  suppress_config_dump true
  without_source true
  process_name lucid-fluentd
  file_permission 0644
  dir_permission 0755
  worker_timeout 60s
  root_dir /opt/lucid/fluentd
  <log>
    level info
    format json
    time_format %Y-%m-%d %H:%M:%S
  </log>
</system>

# ---------------------------------- Global Settings ---------------------

# Global input settings
<source>
  @type forward
  @id lucid_forward
  port 24224
  bind 0.0.0.0
  <transport tcp>
    heartbeat_type tcp
    heartbeat_interval 1s
  </transport>
  <security>
    self_hostname lucid-fluentd
    shared_key lucid_shared_key_2024
  </security>
</source>

# Global HTTP input for web services
<source>
  @type http
  @id lucid_http
  port 9880
  bind 0.0.0.0
  <parse>
    @type json
    time_key timestamp
    time_format %Y-%m-%dT%H:%M:%S.%L%z
  </parse>
</source>

# ---------------------------------- Lucid Service Logs ------------------

# API Gateway Logs
<source>
  @type tail
  @id lucid_api_gateway
  path /opt/lucid/logs/api-gateway/*.log
  pos_file /opt/lucid/fluentd/pos/api-gateway.log.pos
  tag lucid.api-gateway
  <parse>
    @type json
    time_key timestamp
    time_format %Y-%m-%dT%H:%M:%S.%L%z
  </parse>
  <storage>
    @type local
    persistent true
    path /opt/lucid/fluentd/storage/api-gateway
  </storage>
</source>

# Blockchain Core Logs
<source>
  @type tail
  @id lucid_blockchain
  path /opt/lucid/logs/blockchain/*.log
  pos_file /opt/lucid/fluentd/pos/blockchain.log.pos
  tag lucid.blockchain
  <parse>
    @type json
    time_key timestamp
    time_format %Y-%m-%dT%H:%M:%S.%L%z
  </parse>
  <storage>
    @type local
    persistent true
    path /opt/lucid/fluentd/storage/blockchain
  </storage>
</source>

# Session Management Logs
<source>
  @type tail
  @id lucid_sessions
  path /opt/lucid/logs/sessions/*.log
  pos_file /opt/lucid/fluentd/pos/sessions.log.pos
  tag lucid.sessions
  <parse>
    @type json
    time_key timestamp
    time_format %Y-%m-%dT%H:%M:%S.%L%z
  </parse>
  <storage>
    @type local
    persistent true
    path /opt/lucid/fluentd/storage/sessions
  </storage>
</source>

# RDP Services Logs
<source>
  @type tail
  @id lucid_rdp
  path /opt/lucid/logs/rdp/*.log
  pos_file /opt/lucid/fluentd/pos/rdp.log.pos
  tag lucid.rdp
  <parse>
    @type json
    time_key timestamp
    time_format %Y-%m-%dT%H:%M:%S.%L%z
  </parse>
  <storage>
    @type local
    persistent true
    path /opt/lucid/fluentd/storage/rdp
  </storage>
</source>

# Node Management Logs
<source>
  @type tail
  @id lucid_nodes
  path /opt/lucid/logs/nodes/*.log
  pos_file /opt/lucid/fluentd/pos/nodes.log.pos
  tag lucid.nodes
  <parse>
    @type json
    time_key timestamp
    time_format %Y-%m-%dT%H:%M:%S.%L%z
  </parse>
  <storage>
    @type local
    persistent true
    path /opt/lucid/fluentd/storage/nodes
  </storage>
</source>

# Admin Interface Logs
<source>
  @type tail
  @id lucid_admin
  path /opt/lucid/logs/admin/*.log
  pos_file /opt/lucid/fluentd/pos/admin.log.pos
  tag lucid.admin
  <parse>
    @type json
    time_key timestamp
    time_format %Y-%m-%dT%H:%M:%S.%L%z
  </parse>
  <storage>
    @type local
    persistent true
    path /opt/lucid/fluentd/storage/admin
  </storage>
</source>

# TRON Payment Logs
<source>
  @type tail
  @id lucid_tron_payment
  path /opt/lucid/logs/tron-payment/*.log
  pos_file /opt/lucid/fluentd/pos/tron-payment.log.pos
  tag lucid.tron-payment
  <parse>
    @type json
    time_key timestamp
    time_format %Y-%m-%dT%H:%M:%S.%L%z
  </parse>
  <storage>
    @type local
    persistent true
    path /opt/lucid/fluentd/storage/tron-payment
  </storage>
</source>

# Authentication Service Logs
<source>
  @type tail
  @id lucid_auth
  path /opt/lucid/logs/auth/*.log
  pos_file /opt/lucid/fluentd/pos/auth.log.pos
  tag lucid.auth
  <parse>
    @type json
    time_key timestamp
    time_format %Y-%m-%dT%H:%M:%S.%L%z
  </parse>
  <storage>
    @type local
    persistent true
    path /opt/lucid/fluentd/storage/auth
  </storage>
</source>

# Database Service Logs
<source>
  @type tail
  @id lucid_database
  path /opt/lucid/logs/database/*.log
  pos_file /opt/lucid/fluentd/pos/database.log.pos
  tag lucid.database
  <parse>
    @type json
    time_key timestamp
    time_format %Y-%m-%dT%H:%M:%S.%L%z
  </parse>
  <storage>
    @type local
    persistent true
    path /opt/lucid/fluentd/storage/database
  </storage>
</source>

# Service Mesh Logs
<source>
  @type tail
  @id lucid_service_mesh
  path /opt/lucid/logs/service-mesh/*.log
  pos_file /opt/lucid/fluentd/pos/service-mesh.log.pos
  tag lucid.service-mesh
  <parse>
    @type json
    time_key timestamp
    time_format %Y-%m-%dT%H:%M:%S.%L%z
  </parse>
  <storage>
    @type local
    persistent true
    path /opt/lucid/fluentd/storage/service-mesh
  </storage>
</source>

# ---------------------------------- Security Logs -----------------------

# Security Audit Logs
<source>
  @type tail
  @id lucid_security
  path /opt/lucid/logs/security/*.log
  pos_file /opt/lucid/fluentd/pos/security.log.pos
  tag lucid.security
  <parse>
    @type json
    time_key timestamp
    time_format %Y-%m-%dT%H:%M:%S.%L%z
  </parse>
  <storage>
    @type local
    persistent true
    path /opt/lucid/fluentd/storage/security
  </storage>
</source>

# Authentication Audit Logs
<source>
  @type tail
  @id lucid_auth_audit
  path /opt/lucid/logs/auth/audit/*.log
  pos_file /opt/lucid/fluentd/pos/auth-audit.log.pos
  tag lucid.auth-audit
  <parse>
    @type json
    time_key timestamp
    time_format %Y-%m-%dT%H:%M:%S.%L%z
  </parse>
  <storage>
    @type local
    persistent true
    path /opt/lucid/fluentd/storage/auth-audit
  </storage>
</source>

# ---------------------------------- Performance Logs ---------------------

# Performance Monitoring Logs
<source>
  @type tail
  @id lucid_performance
  path /opt/lucid/logs/performance/*.log
  pos_file /opt/lucid/fluentd/pos/performance.log.pos
  tag lucid.performance
  <parse>
    @type json
    time_key timestamp
    time_format %Y-%m-%dT%H:%M:%S.%L%z
  </parse>
  <storage>
    @type local
    persistent true
    path /opt/lucid/fluentd/storage/performance
  </storage>
</source>

# Metrics Logs
<source>
  @type tail
  @id lucid_metrics
  path /opt/lucid/logs/metrics/*.log
  pos_file /opt/lucid/fluentd/pos/metrics.log.pos
  tag lucid.metrics
  <parse>
    @type json
    time_key timestamp
    time_format %Y-%m-%dT%H:%M:%S.%L%z
  </parse>
  <storage>
    @type local
    persistent true
    path /opt/lucid/fluentd/storage/metrics
  </storage>
</source>

# ---------------------------------- Application Logs ---------------------

# Application Error Logs
<source>
  @type tail
  @id lucid_errors
  path /opt/lucid/logs/errors/*.log
  pos_file /opt/lucid/fluentd/pos/errors.log.pos
  tag lucid.errors
  <parse>
    @type json
    time_key timestamp
    time_format %Y-%m-%dT%H:%M:%S.%L%z
  </parse>
  <storage>
    @type local
    persistent true
    path /opt/lucid/fluentd/storage/errors
  </storage>
</source>

# Application Debug Logs
<source>
  @type tail
  @id lucid_debug
  path /opt/lucid/logs/debug/*.log
  pos_file /opt/lucid/fluentd/pos/debug.log.pos
  tag lucid.debug
  <parse>
    @type json
    time_key timestamp
    time_format %Y-%m-%dT%H:%M:%S.%L%z
  </parse>
  <storage>
    @type local
    persistent true
    path /opt/lucid/fluentd/storage/debug
  </storage>
</source>

# ---------------------------------- Monitoring Logs ---------------------

# Prometheus Logs
<source>
  @type tail
  @id lucid_prometheus
  path /opt/lucid/logs/monitoring/prometheus/*.log
  pos_file /opt/lucid/fluentd/pos/prometheus.log.pos
  tag lucid.prometheus
  <parse>
    @type json
    time_key timestamp
    time_format %Y-%m-%dT%H:%M:%S.%L%z
  </parse>
  <storage>
    @type local
    persistent true
    path /opt/lucid/fluentd/storage/prometheus
  </storage>
</source>

# Grafana Logs
<source>
  @type tail
  @id lucid_grafana
  path /opt/lucid/logs/monitoring/grafana/*.log
  pos_file /opt/lucid/fluentd/pos/grafana.log.pos
  tag lucid.grafana
  <parse>
    @type json
    time_key timestamp
    time_format %Y-%m-%dT%H:%M:%S.%L%z
  </parse>
  <storage>
    @type local
    persistent true
    path /opt/lucid/fluentd/storage/grafana
  </storage>
</source>

# ---------------------------------- Network Logs -------------------------

# Tor Network Logs
<source>
  @type tail
  @id lucid_tor
  path /opt/lucid/logs/network/tor/*.log
  pos_file /opt/lucid/fluentd/pos/tor.log.pos
  tag lucid.tor
  <parse>
    @type json
    time_key timestamp
    time_format %Y-%m-%dT%H:%M:%S.%L%z
  </parse>
  <storage>
    @type local
    persistent true
    path /opt/lucid/fluentd/storage/tor
  </storage>
</source>

# Network Tunnel Logs
<source>
  @type tail
  @id lucid_tunnels
  path /opt/lucid/logs/network/tunnels/*.log
  pos_file /opt/lucid/fluentd/pos/tunnels.log.pos
  tag lucid.tunnels
  <parse>
    @type json
    time_key timestamp
    time_format %Y-%m-%dT%H:%M:%S.%L%z
  </parse>
  <storage>
    @type local
    persistent true
    path /opt/lucid/fluentd/storage/tunnels
  </storage>
</source>

# ---------------------------------- System Logs --------------------------

# System Logs
<source>
  @type tail
  @id lucid_system
  path /var/log/syslog
  pos_file /opt/lucid/fluentd/pos/system.log.pos
  tag lucid.system
  <parse>
    @type syslog
    time_format %b %d %H:%M:%S
  </parse>
  <storage>
    @type local
    persistent true
    path /opt/lucid/fluentd/storage/system
  </storage>
</source>

# Docker Logs
<source>
  @type tail
  @id lucid_docker
  path /var/lib/docker/containers/*/*.log
  pos_file /opt/lucid/fluentd/pos/docker.log.pos
  tag lucid.docker
  <parse>
    @type json
    time_key timestamp
    time_format %Y-%m-%dT%H:%M:%S.%L%z
  </parse>
  <storage>
    @type local
    persistent true
    path /opt/lucid/fluentd/storage/docker
  </storage>
</source>

# ---------------------------------- Log Processing -----------------------

# Add service metadata to all logs
<filter lucid.**>
  @type record_transformer
  <record>
    service_name ${tag_parts[1]}
    log_type ${tag_parts[2]}
    environment production
    cluster lucid-rdp
    version 1.0.0
  </record>
</filter>

# Add host information
<filter lucid.**>
  @type record_transformer
  <record>
    hostname ${hostname}
    host_ip ${host}
    fluentd_version ${fluentd_version}
  </record>
</filter>

# Parse JSON fields for better searchability
<filter lucid.**>
  @type parser
  key_name message
  reserve_data true
  <parse>
    @type json
    time_key timestamp
    time_format %Y-%m-%dT%H:%M:%S.%L%z
  </parse>
</filter>

# Add severity levels based on log content
<filter lucid.**>
  @type grep
  <regexp>
    key level
    pattern /^(ERROR|FATAL|CRITICAL)$/
  </regexp>
</filter>

# ---------------------------------- Elasticsearch Output ---------------

# Main Elasticsearch output for all Lucid logs
<match lucid.**>
  @type elasticsearch
  @id lucid_elasticsearch
  host elasticsearch
  port 9200
  index_name lucid-logs
  type_name _doc
  <buffer>
    @type file
    path /opt/lucid/fluentd/buffer/elasticsearch
    flush_mode interval
    flush_interval 5s
    chunk_limit_size 8MB
    queue_limit_length 32
    retry_max_times 3
    retry_wait 1s
    retry_exponential_backoff_base 2s
    retry_exponential_backoff_max 64s
  </buffer>
  <transport>
    @type http
    <http>
      @type http
      endpoint http://elasticsearch:9200
      <auth>
        @type basic
        username elastic
        password lucid_elastic_password
      </auth>
    </http>
  </transport>
  <format>
    @type json
  </format>
</match>

# Security logs to separate index
<match lucid.security>
  @type elasticsearch
  @id lucid_security_elasticsearch
  host elasticsearch
  port 9200
  index_name lucid-security-logs
  type_name _doc
  <buffer>
    @type file
    path /opt/lucid/fluentd/buffer/security
    flush_mode interval
    flush_interval 1s
    chunk_limit_size 2MB
    queue_limit_length 16
    retry_max_times 5
    retry_wait 1s
  </buffer>
  <transport>
    @type http
    <http>
      @type http
      endpoint http://elasticsearch:9200
      <auth>
        @type basic
        username elastic
        password lucid_elastic_password
      </auth>
    </http>
  </transport>
  <format>
    @type json
  </format>
</match>

# Performance logs to separate index
<match lucid.performance>
  @type elasticsearch
  @id lucid_performance_elasticsearch
  host elasticsearch
  port 9200
  index_name lucid-performance-logs
  type_name _doc
  <buffer>
    @type file
    path /opt/lucid/fluentd/buffer/performance
    flush_mode interval
    flush_interval 10s
    chunk_limit_size 16MB
    queue_limit_length 64
    retry_max_times 3
    retry_wait 2s
  </buffer>
  <transport>
    @type http
    <http>
      @type http
      endpoint http://elasticsearch:9200
      <auth>
        @type basic
        username elastic
        password lucid_elastic_password
      </auth>
    </http>
  </transport>
  <format>
    @type json
  </format>
</match>

# ---------------------------------- File Output (Backup) -----------------

# Backup file output for critical logs
<match lucid.security>
  @type file
  @id lucid_security_file
  path /opt/lucid/logs/backup/security
  append true
  <format>
    @type json
  </format>
  <buffer>
    @type file
    path /opt/lucid/fluentd/buffer/security-file
    flush_mode interval
    flush_interval 30s
    chunk_limit_size 1MB
    queue_limit_length 8
  </buffer>
</match>

# Backup file output for audit logs
<match lucid.auth-audit>
  @type file
  @id lucid_audit_file
  path /opt/lucid/logs/backup/audit
  append true
  <format>
    @type json
  </format>
  <buffer>
    @type file
    path /opt/lucid/fluentd/buffer/audit-file
    flush_mode interval
    flush_interval 60s
    chunk_limit_size 2MB
    queue_limit_length 16
  </buffer>
</match>

# ---------------------------------- Monitoring Output --------------------

# Prometheus metrics output
<match lucid.metrics>
  @type prometheus
  @id lucid_prometheus_output
  <metric>
    name lucid_log_events_total
    type counter
    desc Total number of log events
    <labels>
      service ${service_name}
      level ${level}
    </labels>
  </metric>
  <metric>
    name lucid_log_errors_total
    type counter
    desc Total number of error log events
    <labels>
      service ${service_name}
    </labels>
  </metric>
</match>

# ---------------------------------- Alerting Output -----------------------

# Critical error alerting
<match lucid.**>
  @type grep
  <regexp>
    key level
    pattern /^(ERROR|FATAL|CRITICAL)$/
  </regexp>
  @type webhook
  @id lucid_alert_webhook
  webhook_url http://alertmanager:9093/api/v1/alerts
  <format>
    @type json
  </format>
</match>

# ---------------------------------- Health Check -------------------------

# Health check endpoint
<source>
  @type monitor_agent
  @id lucid_monitor
  bind 0.0.0.0
  port 24220
</source>

# ---------------------------------- Configuration Notes ------------------

# Fluentd Configuration Features:
# - Structured JSON logging for all services
# - Elasticsearch integration for log storage
# - File-based buffering for reliability
# - Service-specific log routing
# - Security log isolation
# - Performance log optimization
# - Backup file outputs
# - Prometheus metrics integration
# - Webhook alerting
# - Health monitoring

# Log Processing Pipeline:
# 1. Log collection from all Lucid services
# 2. JSON parsing and field extraction
# 3. Metadata enrichment
# 4. Service-specific routing
# 5. Elasticsearch indexing
# 6. Backup file storage
# 7. Metrics collection
# 8. Alert generation

# Buffer Configuration:
# - File-based buffering for reliability
# - Configurable flush intervals
# - Retry mechanisms for failures
# - Exponential backoff for retries
# - Queue size limits
# - Chunk size optimization

# Security Features:
# - Authentication for Elasticsearch
# - Secure log transmission
# - Audit log protection
# - Sensitive data filtering
# - Access control

# Performance Optimization:
# - Batch processing
# - Compression
# - Connection pooling
# - Memory management
# - Disk I/O optimization

# Monitoring Integration:
# - Prometheus metrics
# - Health checks
# - Performance monitoring
# - Error tracking
# - Alert management

# ---------------------------------- Directory Structure ------------------

# Fluentd Directory Structure:
# /opt/lucid/fluentd/
# ├── buffer/
# │   ├── elasticsearch/
# │   ├── security/
# │   ├── performance/
# │   ├── security-file/
# │   └── audit-file/
# ├── storage/
# │   ├── api-gateway/
# │   ├── blockchain/
# │   ├── sessions/
# │   ├── rdp/
# │   ├── nodes/
# │   ├── admin/
# │   ├── tron-payment/
# │   ├── auth/
# │   ├── database/
# │   ├── service-mesh/
# │   ├── security/
# │   ├── performance/
# │   ├── metrics/
# │   ├── errors/
# │   ├── debug/
# │   ├── prometheus/
# │   ├── grafana/
# │   ├── tor/
# │   ├── tunnels/
# │   ├── system/
# │   └── docker/
# └── pos/
#     ├── api-gateway.log.pos
#     ├── blockchain.log.pos
#     ├── sessions.log.pos
#     ├── rdp.log.pos
#     ├── nodes.log.pos
#     ├── admin.log.pos
#     ├── tron-payment.log.pos
#     ├── auth.log.pos
#     ├── database.log.pos
#     ├── service-mesh.log.pos
#     ├── security.log.pos
#     ├── performance.log.pos
#     ├── metrics.log.pos
#     ├── errors.log.pos
#     ├── debug.log.pos
#     ├── prometheus.log.pos
#     ├── grafana.log.pos
#     ├── tor.log.pos
#     ├── tunnels.log.pos
#     ├── system.log.pos
#     └── docker.log.pos

# ---------------------------------- Integration Notes --------------------

# This configuration integrates with:
# - All Lucid RDP services
# - Elasticsearch for log storage
# - Prometheus for metrics
# - Grafana for visualization
# - AlertManager for alerting
# - Docker container logging
# - System logging
# - Security auditing

# Log formats supported:
# - JSON structured logs
# - Syslog format
# - Docker log format
# - Custom Lucid log format
# - Prometheus metrics format

# ---------------------------------- Security Considerations --------------

# Security features implemented:
# - Authentication for Elasticsearch
# - Secure log transmission
# - Audit log protection
# - Sensitive data filtering
# - Access control
# - Log integrity verification
# - Encryption in transit
# - Secure storage

# ---------------------------------- Performance Considerations ------------

# Performance optimizations:
# - Batch processing for efficiency
# - Compression to reduce bandwidth
# - Connection pooling
# - Memory management
# - Disk I/O optimization
# - Retry mechanisms
# - Buffer management
# - Chunk size optimization

# ---------------------------------- Compliance Notes ---------------------

# Compliance features:
# - Audit log retention
# - Security log protection
# - Data integrity
# - Access logging
# - Error tracking
# - Performance monitoring
# - Alert management
# - Backup procedures

# ---------------------------------- Maintenance Notes --------------------

# Maintenance procedures:
# - Regular buffer cleanup
# - Log rotation management
# - Performance monitoring
# - Error handling
# - Backup verification
# - Security updates
# - Configuration updates
# - Service monitoring

# ---------------------------------- End of Configuration -----------------

# This configuration file is part of the Lucid RDP System
# Step 49: Logging Configuration
# Build Requirements Guide compliance
# Production-ready log aggregation setup
