# Lucid RDP System - Log Rotation Configuration
# Step 49: Logging Configuration
# Document: BUILD_REQUIREMENTS_GUIDE.md Step 49

# ======================== Log Rotation Configuration =========================

# ---------------------------------- Global Settings --------------------------

# Rotate logs daily
daily

# Keep 30 days of logs
rotate 30

# Compress rotated logs
compress

# Delay compression until next rotation
delaycompress

# Don't error if log file is missing
missingok

# Don't rotate empty logs
notifempty

# Create new log files with proper permissions
create 644 root root

# ---------------------------------- Lucid System Logs -----------------------

# API Gateway Logs
/opt/lucid/logs/api-gateway/*.log {
    daily
    rotate 30
    compress
    delaycompress
    missingok
    notifempty
    create 644 root root
    postrotate
        # Send USR1 signal to API Gateway service
        docker kill -s USR1 lucid-api-gateway 2>/dev/null || true
    endscript
}

# Blockchain Core Logs
/opt/lucid/logs/blockchain/*.log {
    daily
    rotate 30
    compress
    delaycompress
    missingok
    notifempty
    create 644 root root
    postrotate
        # Send USR1 signal to blockchain services
        docker kill -s USR1 lucid-blockchain-engine 2>/dev/null || true
        docker kill -s USR1 lucid-blockchain-anchoring 2>/dev/null || true
        docker kill -s USR1 lucid-blockchain-manager 2>/dev/null || true
        docker kill -s USR1 lucid-blockchain-data 2>/dev/null || true
    endscript
}

# Session Management Logs
/opt/lucid/logs/sessions/*.log {
    daily
    rotate 30
    compress
    delaycompress
    missingok
    notifempty
    create 644 root root
    postrotate
        # Send USR1 signal to session services
        docker kill -s USR1 lucid-session-pipeline 2>/dev/null || true
        docker kill -s USR1 lucid-session-recorder 2>/dev/null || true
        docker kill -s USR1 lucid-session-processor 2>/dev/null || true
        docker kill -s USR1 lucid-session-storage 2>/dev/null || true
        docker kill -s USR1 lucid-session-api 2>/dev/null || true
    endscript
}

# RDP Services Logs
/opt/lucid/logs/rdp/*.log {
    daily
    rotate 30
    compress
    delaycompress
    missingok
    notifempty
    create 644 root root
    postrotate
        # Send USR1 signal to RDP services
        docker kill -s USR1 lucid-rdp-server-manager 2>/dev/null || true
        docker kill -s USR1 lucid-rdp-xrdp 2>/dev/null || true
        docker kill -s USR1 lucid-rdp-controller 2>/dev/null || true
        docker kill -s USR1 lucid-rdp-monitor 2>/dev/null || true
    endscript
}

# Node Management Logs
/opt/lucid/logs/nodes/*.log {
    daily
    rotate 30
    compress
    delaycompress
    missingok
    notifempty
    create 644 root root
    postrotate
        # Send USR1 signal to node management service
        docker kill -s USR1 lucid-node-management 2>/dev/null || true
    endscript
}

# Admin Interface Logs
/opt/lucid/logs/admin/*.log {
    daily
    rotate 30
    compress
    delaycompress
    missingok
    notifempty
    create 644 root root
    postrotate
        # Send USR1 signal to admin interface
        docker kill -s USR1 lucid-admin-interface 2>/dev/null || true
    endscript
}

# TRON Payment Logs
/opt/lucid/logs/tron-payment/*.log {
    daily
    rotate 30
    compress
    delaycompress
    missingok
    notifempty
    create 644 root root
    postrotate
        # Send USR1 signal to TRON payment services
        docker kill -s USR1 lucid-tron-client 2>/dev/null || true
        docker kill -s USR1 lucid-tron-payout-router 2>/dev/null || true
        docker kill -s USR1 lucid-tron-wallet-manager 2>/dev/null || true
        docker kill -s USR1 lucid-tron-usdt-manager 2>/dev/null || true
        docker kill -s USR1 lucid-tron-staking 2>/dev/null || true
        docker kill -s USR1 lucid-tron-payment-gateway 2>/dev/null || true
    endscript
}

# Authentication Service Logs
/opt/lucid/logs/auth/*.log {
    daily
    rotate 30
    compress
    delaycompress
    missingok
    notifempty
    create 644 root root
    postrotate
        # Send USR1 signal to auth service
        docker kill -s USR1 lucid-auth-service 2>/dev/null || true
    endscript
}

# Database Service Logs
/opt/lucid/logs/database/*.log {
    daily
    rotate 30
    compress
    delaycompress
    missingok
    notifempty
    create 644 root root
    postrotate
        # Send USR1 signal to database services
        docker kill -s USR1 lucid-mongodb 2>/dev/null || true
        docker kill -s USR1 lucid-redis 2>/dev/null || true
        docker kill -s USR1 lucid-elasticsearch 2>/dev/null || true
    endscript
}

# Service Mesh Logs
/opt/lucid/logs/service-mesh/*.log {
    daily
    rotate 30
    compress
    delaycompress
    missingok
    notifempty
    create 644 root root
    postrotate
        # Send USR1 signal to service mesh
        docker kill -s USR1 lucid-service-mesh-controller 2>/dev/null || true
    endscript
}

# ---------------------------------- System Logs -----------------------------

# Nginx/Apache Logs (if used)
/var/log/nginx/*.log {
    daily
    rotate 30
    compress
    delaycompress
    missingok
    notifempty
    create 644 www-data www-data
    postrotate
        # Reload nginx configuration
        systemctl reload nginx 2>/dev/null || true
    endscript
}

# Docker Logs
/var/lib/docker/containers/*/*.log {
    daily
    rotate 7
    compress
    delaycompress
    missingok
    notifempty
    create 644 root root
    postrotate
        # Restart docker daemon to clean up old logs
        systemctl reload docker 2>/dev/null || true
    endscript
}

# System Logs
/var/log/syslog {
    daily
    rotate 7
    compress
    delaycompress
    missingok
    notifempty
    create 644 syslog adm
    postrotate
        # Reload syslog daemon
        systemctl reload rsyslog 2>/dev/null || true
    endscript
}

# ---------------------------------- Security Logs ---------------------------

# Security Audit Logs
/opt/lucid/logs/security/*.log {
    daily
    rotate 90
    compress
    delaycompress
    missingok
    notifempty
    create 600 root root
    postrotate
        # Security logs require special handling
        # No service restart needed for audit logs
    endscript
}

# Authentication Audit Logs
/opt/lucid/logs/auth/audit/*.log {
    daily
    rotate 365
    compress
    delaycompress
    missingok
    notifempty
    create 600 root root
    postrotate
        # Audit logs are critical - keep for 1 year
        # No service restart needed
    endscript
}

# ---------------------------------- Performance Logs -------------------------

# Performance Monitoring Logs
/opt/lucid/logs/performance/*.log {
    daily
    rotate 7
    compress
    delaycompress
    missingok
    notifempty
    create 644 root root
    postrotate
        # Performance logs are high volume - keep for 1 week
        # No service restart needed
    endscript
}

# Metrics Logs
/opt/lucid/logs/metrics/*.log {
    daily
    rotate 14
    compress
    delaycompress
    missingok
    notifempty
    create 644 root root
    postrotate
        # Metrics logs - keep for 2 weeks
        # No service restart needed
    endscript
}

# ---------------------------------- Application Logs -------------------------

# Application Error Logs
/opt/lucid/logs/errors/*.log {
    daily
    rotate 30
    compress
    delaycompress
    missingok
    notifempty
    create 644 root root
    postrotate
        # Error logs - keep for 30 days
        # No service restart needed
    endscript
}

# Application Debug Logs
/opt/lucid/logs/debug/*.log {
    daily
    rotate 7
    compress
    delaycompress
    missingok
    notifempty
    create 644 root root
    postrotate
        # Debug logs are high volume - keep for 1 week
        # No service restart needed
    endscript
}

# ---------------------------------- Backup Logs -----------------------------

# Backup Operation Logs
/opt/lucid/logs/backup/*.log {
    daily
    rotate 30
    compress
    delaycompress
    missingok
    notifempty
    create 644 root root
    postrotate
        # Backup logs - keep for 30 days
        # No service restart needed
    endscript
}

# ---------------------------------- Monitoring Logs -------------------------

# Prometheus Logs
/opt/lucid/logs/monitoring/prometheus/*.log {
    daily
    rotate 14
    compress
    delaycompress
    missingok
    notifempty
    create 644 root root
    postrotate
        # Send USR1 signal to Prometheus
        docker kill -s USR1 lucid-prometheus 2>/dev/null || true
    endscript
}

# Grafana Logs
/opt/lucid/logs/monitoring/grafana/*.log {
    daily
    rotate 14
    compress
    delaycompress
    missingok
    notifempty
    create 644 root root
    postrotate
        # Send USR1 signal to Grafana
        docker kill -s USR1 lucid-grafana 2>/dev/null || true
    endscript
}

# ---------------------------------- Network Logs ----------------------------

# Tor Network Logs
/opt/lucid/logs/network/tor/*.log {
    daily
    rotate 30
    compress
    delaycompress
    missingok
    notifempty
    create 644 root root
    postrotate
        # Send USR1 signal to Tor
        docker kill -s USR1 lucid-tor-proxy 2>/dev/null || true
    endscript
}

# Network Tunnel Logs
/opt/lucid/logs/network/tunnels/*.log {
    daily
    rotate 30
    compress
    delaycompress
    missingok
    notifempty
    create 644 root root
    postrotate
        # Send USR1 signal to tunnel services
        docker kill -s USR1 lucid-tunnel-manager 2>/dev/null || true
    endscript
}

# ---------------------------------- Configuration Notes ----------------------

# Log Rotation Schedule:
# - Daily rotation for all service logs
# - 30-day retention for most logs
# - 7-day retention for high-volume logs (performance, debug)
# - 14-day retention for monitoring logs
# - 90-day retention for security audit logs
# - 365-day retention for authentication audit logs

# Compression:
# - All rotated logs are compressed with gzip
# - Compression is delayed until next rotation to avoid conflicts

# Permissions:
# - Standard logs: 644 (readable by all)
# - Security logs: 600 (readable by root only)
# - Owner: root, Group: root (or appropriate service group)

# Service Restart:
# - USR1 signal sent to Docker containers for log rotation
# - System services use appropriate reload commands
# - Audit and security logs don't require service restart

# Directory Structure:
# /opt/lucid/logs/
# ├── api-gateway/
# ├── blockchain/
# ├── sessions/
# ├── rdp/
# ├── nodes/
# ├── admin/
# ├── tron-payment/
# ├── auth/
# ├── database/
# ├── service-mesh/
# ├── security/
# ├── performance/
# ├── metrics/
# ├── errors/
# ├── debug/
# ├── backup/
# ├── monitoring/
# └── network/

# ---------------------------------- Maintenance ------------------------------

# Manual log rotation:
# sudo logrotate -f /etc/logrotate.d/lucid-system

# Check logrotate status:
# sudo logrotate -d /etc/logrotate.d/lucid-system

# Force log rotation:
# sudo logrotate -f /etc/logrotate.d/lucid-system

# Check log file sizes:
# du -sh /opt/lucid/logs/*/

# Clean old logs manually:
# find /opt/lucid/logs -name "*.log.*" -mtime +30 -delete

# ---------------------------------- Integration ------------------------------

# This configuration integrates with:
# - Docker container logging
# - Systemd journal logging
# - Fluentd log aggregation
# - Elasticsearch log storage
# - Prometheus metrics collection
# - Grafana log visualization

# Log formats supported:
# - JSON structured logs
# - Plain text logs
# - Syslog format
# - Docker log format
# - Custom Lucid log format

# ---------------------------------- Security Considerations ------------------

# Security logs are protected with 600 permissions
# Audit logs are retained for compliance requirements
# Sensitive information is excluded from logs
# Log files are monitored for unauthorized access
# Log rotation prevents disk space exhaustion
# Compressed logs reduce storage requirements

# ---------------------------------- Performance Considerations ---------------

# High-volume logs have shorter retention periods
# Compression reduces storage requirements
# Daily rotation prevents large log files
# Service restart signals are optimized
# Log directory structure is organized for performance

# ---------------------------------- Compliance Notes -------------------------

# Log retention meets compliance requirements:
# - Security logs: 90 days minimum
# - Audit logs: 365 days minimum
# - Application logs: 30 days minimum
# - System logs: 7 days minimum

# Log formats support compliance reporting:
# - Structured JSON for automated analysis
# - Timestamped entries for audit trails
# - Service identification for accountability
# - Error tracking for incident response

# ---------------------------------- Monitoring Integration ------------------

# Log rotation events are monitored
# Disk space usage is tracked
# Log file integrity is verified
# Service health is maintained during rotation
# Performance impact is minimized

# ---------------------------------- Backup Integration ----------------------

# Rotated logs are included in backup procedures
# Compressed logs reduce backup storage requirements
# Log retention aligns with backup retention policies
# Critical logs are prioritized for backup
# Log recovery procedures are documented

# ---------------------------------- End of Configuration --------------------

# This configuration file is part of the Lucid RDP System
# Step 49: Logging Configuration
# Build Requirements Guide compliance
# Production-ready log rotation setup
