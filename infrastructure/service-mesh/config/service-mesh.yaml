# Lucid Service Mesh Configuration
# File: infrastructure/service-mesh/config/service-mesh.yaml
# Purpose: Comprehensive service mesh configuration for Lucid platform
# This file is loaded by infrastructure/service-mesh/controller/config_manager.py
# Default path: /config/service-mesh.yaml (configurable via SERVICE_MESH_CONFIG_PATH)

service_mesh:
  name: "lucid-service-mesh"
  version: "1.0.0"
  namespace: "lucid"
  description: "Lucid platform service mesh for service discovery, traffic management, and security"
  
  # Controller Configuration
  controller:
    port: 8600
    admin_port: 8601
    health_port: 8602
    log_level: "INFO"
    host: "0.0.0.0"
    cluster: "foundation"
    datacenter: "lucid-dc"
    
  # Service Discovery Configuration
  discovery:
    backend: "consul"
    consul_host: "lucid-service-mesh-controller"
    consul_port: 8500
    consul_datacenter: "lucid-dc"
    consul_node_name: "lucid-service-mesh-controller"
    service_ttl: 60
    health_check_interval: 30
    deregister_critical_service_after: 120
    auto_registration: true
    registration_interval: 30
    
  # Sidecar Proxy Configuration
  sidecar:
    enabled: true
    proxy_type: "envoy"
    envoy:
      admin_port: 15000
      proxy_port: 15001
      egress_port: 15006
      config_path: "/etc/envoy"
      bootstrap_config: "/etc/envoy/bootstrap.yaml"
      cluster_config: "/etc/envoy/cluster.yaml"
      listener_config: "/etc/envoy/listener.yaml"
      log_level: "info"
      
  # Security Configuration
  security:
    mtls:
      enabled: true
      cert_validity_days: 90
      auto_rotate: true
      verify_incoming: true
      verify_outgoing: true
      auto_encrypt: true
    acl:
      enabled: true
      default_policy: "deny"
      token_policies: true
    cert_manager:
      enabled: true
      ca_path: "/app/certs/ca.crt"
      cert_path: "/app/certs/server.crt"
      key_path: "/app/certs/server.key"
      
  # Networking Configuration
  networking:
    default_timeout: 30
    idle_timeout: 60
    retry_attempts: 3
    retry_on: ["5xx", "reset", "connect-failure", "refused-stream"]
    per_try_timeout: 5
    circuit_breaker:
      enabled: true
      failure_threshold: 5
      recovery_timeout: 30
      max_connections: 1000
      max_pending_requests: 1000
      max_requests: 1000
      max_retries: 3
    load_balancing:
      algorithm: "round_robin"
      health_check: true
      sticky_sessions: false
      
  # Observability Configuration
  observability:
    metrics:
      enabled: true
      prometheus_port: 9090
      stats_tags:
        - service
        - cluster
        - listener
    tracing:
      enabled: true
      backend: "zipkin"
      zipkin_endpoint: "/api/v2/spans"
      zipkin_cluster: "zipkin"
      zipkin_port: 9411
      trace_id_128bit: true
      shared_span_context: false
    logging:
      enabled: true
      log_level: "INFO"
      access_logs: true
      log_format: "json"

# Services Configuration
# Individual service configurations for service discovery and mesh integration
services:
  # Foundation Services (Phase 1)
  lucid-mongodb:
    name: "lucid-mongodb"
    port: 27017
    health_check: "/health"
    health_check_interval: 30
    tags: ["database", "foundation", "mongodb"]
    network: "lucid-pi-network"
    ipv4_address: "172.20.0.11"
    sidecar_enabled: false  # Database services typically don't use sidecars
    
  lucid-redis:
    name: "lucid-redis"
    port: 6379
    health_check: "/health"
    health_check_interval: 30
    tags: ["database", "foundation", "redis", "cache"]
    network: "lucid-pi-network"
    ipv4_address: "172.20.0.12"
    sidecar_enabled: false
    
  lucid-elasticsearch:
    name: "lucid-elasticsearch"
    port: 9200
    health_check: "/_cluster/health"
    health_check_interval: 30
    tags: ["database", "foundation", "elasticsearch", "search"]
    network: "lucid-pi-network"
    ipv4_address: "172.20.0.13"
    sidecar_enabled: false
    
  lucid-auth-service:
    name: "lucid-auth-service"
    port: 8089
    health_check: "/health"
    health_check_interval: 30
    tags: ["auth", "foundation", "authentication", "authorization"]
    network: "lucid-pi-network"
    ipv4_address: "172.20.0.14"
    sidecar_enabled: true
    circuit_breaker:
      failure_threshold: 5
      recovery_timeout: 30
      
  # Core Services (Phase 2)
  lucid-api-gateway:
    name: "lucid-api-gateway"
    port: 8080
    health_check: "/health"
    health_check_interval: 30
    tags: ["gateway", "core", "api", "routing"]
    network: "lucid-pi-network"
    ipv4_address: "172.20.0.10"
    sidecar_enabled: true
    circuit_breaker:
      failure_threshold: 5
      recovery_timeout: 30
    load_balancing:
      algorithm: "round_robin"
      
  lucid-service-mesh-controller:
    name: "lucid-service-mesh-controller"
    port: 8600
    admin_port: 8601
    health_check: "/v1/status/leader"
    health_check_interval: 30
    tags: ["service-mesh", "core", "consul", "discovery"]
    network: "lucid-pi-network"
    ipv4_address: "172.20.0.19"
    sidecar_enabled: false  # Controller doesn't use its own sidecar
    
  lucid-blockchain-engine:
    name: "lucid-blockchain-engine"
    port: 8084
    health_check: "/health"
    health_check_interval: 30
    tags: ["blockchain", "core", "consensus", "chain"]
    network: "lucid-pi-network"
    ipv4_address: "172.20.0.15"
    sidecar_enabled: true
    circuit_breaker:
      failure_threshold: 5
      recovery_timeout: 30
      
  lucid-session-anchoring:
    name: "lucid-session-anchoring"
    port: 8085
    health_check: "/health"
    health_check_interval: 30
    tags: ["blockchain", "core", "sessions", "anchoring"]
    network: "lucid-pi-network"
    ipv4_address: "172.20.0.16"
    sidecar_enabled: true
    
  lucid-block-manager:
    name: "lucid-block-manager"
    port: 8086
    health_check: "/health"
    health_check_interval: 30
    tags: ["blockchain", "core", "blocks", "management"]
    network: "lucid-pi-network"
    ipv4_address: "172.20.0.17"
    sidecar_enabled: true
    
  lucid-data-chain:
    name: "lucid-data-chain"
    port: 8087
    health_check: "/health"
    health_check_interval: 30
    tags: ["blockchain", "core", "data", "chain"]
    network: "lucid-pi-network"
    ipv4_address: "172.20.0.18"
    sidecar_enabled: true

# Policies Configuration
# Service mesh policies for traffic management, security, and governance
policies:
  # Default Traffic Policy
  default_traffic_policy:
    name: "default-traffic-policy"
    description: "Default traffic management policy for all services"
    enabled: true
    retry_policy:
      max_retries: 3
      retry_on: ["5xx", "reset", "connect-failure"]
      per_try_timeout: 5
    timeout_policy:
      request_timeout: 30
      idle_timeout: 60
    circuit_breaker:
      failure_threshold: 5
      recovery_timeout: 30
      max_connections: 1000
      max_pending_requests: 1000
      max_requests: 1000
      
  # Security Policy
  default_security_policy:
    name: "default-security-policy"
    description: "Default security policy for mTLS and access control"
    enabled: true
    mtls:
      enabled: true
      verify_incoming: true
      verify_outgoing: true
    acl:
      default_policy: "deny"
      allow_list: []
      deny_list: []
      
  # Rate Limiting Policy
  rate_limiting_policy:
    name: "rate-limiting-policy"
    description: "Rate limiting policy for API protection"
    enabled: true
    requests_per_second: 100
    burst_size: 200
    apply_to: ["lucid-api-gateway", "lucid-auth-service"]
    
  # Load Balancing Policy
  load_balancing_policy:
    name: "load-balancing-policy"
    description: "Load balancing configuration for service instances"
    enabled: true
    algorithm: "round_robin"
    health_check: true
    sticky_sessions: false
    apply_to: ["*"]  # Apply to all services

# Network Configuration
# Network topology and routing configuration
networks:
  lucid-pi-network:
    name: "lucid-pi-network"
    subnet: "172.20.0.0/16"
    gateway: "172.20.0.1"
    description: "Primary network for foundation and core services"
    
  lucid-tron-isolated:
    name: "lucid-tron-isolated"
    subnet: "172.21.0.0/16"
    gateway: "172.21.0.1"
    description: "Isolated network for TRON payment services"
    isolated: true
    
  lucid-gui-network:
    name: "lucid-gui-network"
    subnet: "172.22.0.0/16"
    gateway: "172.22.0.1"
    description: "Network for GUI integration services"

# Service Planes Configuration
# Logical grouping of services by function
service_planes:
  operations_plane:
    name: "operations"
    description: "Management and monitoring services"
    network: "lucid-pi-network"
    services:
      - "lucid-service-mesh-controller"
      - "lucid-admin-interface"
      - "lucid-gui-docker-manager"
      
  chain_plane:
    name: "blockchain"
    description: "Core blockchain operations"
    network: "lucid-pi-network"
    services:
      - "lucid-blockchain-engine"
      - "lucid-api-gateway"
      - "lucid-session-anchoring"
      - "lucid-block-manager"
      - "lucid-data-chain"
      
  wallet_plane:
    name: "wallet"
    description: "Payment operations (TRON only)"
    network: "lucid-tron-isolated"
    isolated: true
    services:
      - "lucid-tron-client"
      - "lucid-payout-router"
      - "lucid-wallet-manager"
      - "lucid-usdt-manager"
      
  gui_plane:
    name: "gui"
    description: "GUI integration services"
    network: "lucid-gui-network"
    services:
      - "lucid-gui-api-bridge"
      - "lucid-gui-tor-manager"
      - "lucid-gui-hardware-wallet"

# Integration Configuration
# External system integration settings
integration:
  consul_connect:
    enabled: true
    mesh_type: "consul-connect"
    
  envoy:
    enabled: true
    xds_cluster: "xds_cluster"
    xds_port: 8600
    admin_interface: true
    
  prometheus:
    enabled: true
    scrape_interval: 30
    metrics_path: "/metrics"
    
  zipkin:
    enabled: true
    endpoint: "/api/v2/spans"
    port: 9411

