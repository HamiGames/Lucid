# LUCID VM MANAGEMENT - DISTROLESS Implementation
# Distroless build for VM orchestration utilities (ARM64/Pi compatible)
# Configuration: .env.application/.env.support (no hardcoded values)
# Source alignment: plan/constants/, image-directory.csv entry pickme/lucid-vm:latest-arm64

# =============================================================================
# BUILD ARGUMENTS
# =============================================================================
ARG BUILD_DATE
ARG VCS_REF
ARG VERSION=1.0.0
ARG TARGETPLATFORM=linux/arm64
ARG BUILDPLATFORM=linux/amd64
ARG PYTHON_VERSION=3.11

# =============================================================================
# STAGE 1: Builder - Install dependencies and assemble application
# =============================================================================
FROM python:${PYTHON_VERSION}-slim AS builder

ARG BUILDPLATFORM
ARG TARGETPLATFORM
ARG PYTHON_VERSION

ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PIP_NO_CACHE_DIR=1 \
    PIP_DISABLE_PIP_VERSION_CHECK=1 \
    DEBIAN_FRONTEND=noninteractive \
    BUILD_ENV=production

# Install build dependencies (cache friendly)
RUN --mount=type=cache,target=/var/cache/apt,sharing=locked \
    --mount=type=cache,target=/var/lib/apt,sharing=locked \
    apt-get update && apt-get install -y --no-install-recommends \
        build-essential \
        gcc \
        libffi-dev \
        libssl-dev \
        pkg-config \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/* /tmp/* /var/tmp/*

WORKDIR /build

# Upgrade pip tooling with cache
RUN --mount=type=cache,target=/root/.cache/pip \
    pip install --upgrade pip wheel setuptools virtualenv

# Create application virtual environment
RUN python -m venv /opt/venv

# Install Python dependencies into venv
COPY vm/requirements.vm.txt ./requirements.vm.txt
RUN --mount=type=cache,target=/root/.cache/pip \
    /opt/venv/bin/pip install --no-cache-dir --upgrade pip \
    && /opt/venv/bin/pip install --no-cache-dir -r requirements.vm.txt

# Copy VM service source
COPY vm/ /opt/app/vm/
COPY vm/main.py /opt/app/main.py

# =============================================================================
# STAGE 2: Runtime - Distroless Python base
# =============================================================================
FROM gcr.io/distroless/python3-debian12:latest

ARG BUILD_DATE
ARG VCS_REF
ARG VERSION=1.0.0

LABEL maintainer="Lucid Development Team" \
      version="${VERSION}" \
      description="Lucid VM management utilities (distroless)" \
      org.opencontainers.image.created="${BUILD_DATE}" \
      org.opencontainers.image.revision="${VCS_REF}" \
      org.opencontainers.image.version="${VERSION}" \
      org.opencontainers.image.title="Lucid VM Manager" \
      org.opencontainers.image.description="VM orchestration service for Lucid platform" \
      com.lucid.plane="support" \
      com.lucid.service="vm-manager" \
      com.lucid.platform="arm64" \
      com.lucid.architecture="linux/arm64" \
      com.lucid.security="distroless" \
      com.lucid.vulnerabilities="zero" \
      com.lucid.expose="8107" \
      com.lucid.cluster="support" \
      com.lucid.tor.compatible="true"

ENV PATH=/opt/venv/bin:/usr/local/bin:/usr/bin:/bin \
    PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PYTHONPATH=/opt/app

WORKDIR /opt/app

# Copy virtual environment and application from builder
COPY --from=builder /opt/venv /opt/venv
COPY --from=builder /opt/app /opt/app

EXPOSE 8107

# Healthcheck (optional network check disabled; relies on internal diagnostics)
HEALTHCHECK --interval=30s --timeout=10s --start-period=60s --retries=3 \
    CMD ["/opt/venv/bin/python", "-c", "import sys; sys.exit(0)"]

USER 65532:65532

CMD ["/opt/venv/bin/python", "main.py"]