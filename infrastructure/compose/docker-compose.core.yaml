# LUCID CORE SERVICES - Distroless Deployment
# Phase 1: Core Support Services (MongoDB, Tor, API Gateway, API Server, Tools)
# Aligned with essentials.md and path_plan.md Phase 1 & 2
# Project Root: /mnt/myssd/Lucid/Lucid/

services:
  lucid-mongodb:
    image: pickme/lucid-mongodb:latest-arm64
    container_name: lucid-mongodb
    hostname: lucid-mongodb
    platform: linux/arm64
    restart: unless-stopped
    env_file:
      - ../../configs/environment/.env.foundation
    environment:
      - LUCID_ENV=production
      - LUCID_PLATFORM=arm64
      - PROJECT_ROOT=/mnt/myssd/Lucid/Lucid
      - MONGO_INITDB_ROOT_USERNAME=lucid
      - MONGO_INITDB_ROOT_PASSWORD=${MONGODB_PASSWORD}
      - MONGO_INITDB_DATABASE=lucid
      - MONGODB_URI=mongodb://lucid:${MONGODB_PASSWORD}@lucid-mongodb:27017/lucid?authSource=admin
      - MONGODB_HOST=172.20.0.11
      - MONGODB_PORT=27017
    volumes:
      - /mnt/myssd/Lucid/Lucid/data/mongodb:/data/db:rw
      - /mnt/myssd/Lucid/Lucid/logs/mongodb:/var/log/mongodb:rw
      - mongo_config:/data/configdb
    networks:
      lucid-pi-network:
        ipv4_address: 172.20.0.11
    ports:
      - "27017:27017"
    healthcheck:
      test: ["CMD-SHELL", "mongosh --quiet -u lucid -p ${MONGODB_PASSWORD} --authenticationDatabase admin --eval 'db.runCommand({ ping: 1 }).ok' | grep -q 1"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 15s
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 256M
          cpus: '0.25'
    labels:
      - "lucid.service=mongodb"
      - "lucid.type=foundation"
      - "lucid.platform=arm64"
      - "lucid.cluster=core"

  lucid-redis:
    image: pickme/lucid-redis:latest-arm64
    container_name: lucid-redis
    hostname: lucid-redis
    platform: linux/arm64
    restart: unless-stopped
    env_file:
      - ../../configs/environment/.env.foundation
    environment:
      - LUCID_ENV=production
      - LUCID_PLATFORM=arm64
      - PROJECT_ROOT=/mnt/myssd/Lucid/Lucid
      - REDIS_URL=redis://lucid-redis:6379/0
      - REDIS_HOST=172.20.0.12
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD}
    volumes:
      - /mnt/myssd/Lucid/Lucid/data/redis:/data:rw
      - /mnt/myssd/Lucid/Lucid/logs/redis:/var/log/redis:rw
    networks:
      lucid-pi-network:
        ipv4_address: 172.20.0.12
    ports:
      - "6379:6379"
    healthcheck:
      test: ["CMD-SHELL", "redis-cli -a ${REDIS_PASSWORD} ping | grep -q PONG"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.5'
        reservations:
          memory: 128M
          cpus: '0.25'
    labels:
      - "lucid.service=redis"
      - "lucid.type=foundation"
      - "lucid.platform=arm64"
      - "lucid.cluster=core"

  lucid-elasticsearch:
    image: pickme/lucid-elasticsearch:latest-arm64
    container_name: lucid-elasticsearch
    hostname: lucid-elasticsearch
    platform: linux/arm64
    restart: unless-stopped
    env_file:
      - ../../configs/environment/.env.foundation
    environment:
      - LUCID_ENV=production
      - LUCID_PLATFORM=arm64
      - PROJECT_ROOT=/mnt/myssd/Lucid/Lucid
      - ELASTICSEARCH_URI=http://lucid-elasticsearch:9200
      - ELASTICSEARCH_HOST=172.20.0.13
      - ELASTICSEARCH_HTTP_PORT=9200
      - ELASTICSEARCH_TRANSPORT_PORT=9300
      - discovery.type=single-node
      - xpack.security.enabled=false
      - ES_JAVA_OPTS=-Xms256m -Xmx256m
    volumes:
      - /mnt/myssd/Lucid/Lucid/data/elasticsearch:/usr/share/elasticsearch/data:rw
      - /mnt/myssd/Lucid/Lucid/logs/elasticsearch:/usr/share/elasticsearch/logs:rw
    networks:
      lucid-pi-network:
        ipv4_address: 172.20.0.13
    ports:
      - "9200:9200"
      - "9300:9300"
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:9200/_cluster/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '1.0'
        reservations:
          memory: 256M
          cpus: '0.25'
    labels:
      - "lucid.service=elasticsearch"
      - "lucid.type=foundation"
      - "lucid.platform=arm64"
      - "lucid.cluster=core"

  lucid-tor-proxy:
    image: pickme/lucid-tor-proxy:latest-arm64
    container_name: lucid-tor-proxy
    hostname: lucid-tor-proxy
    platform: linux/arm64
    pull_policy: always
    restart: unless-stopped
    env_file:
      - ../../configs/environment/.env.foundation
    environment:
      - LUCID_ENV=production
      - LUCID_PLATFORM=arm64
      - PROJECT_ROOT=/mnt/myssd/Lucid/Lucid
      - TOR_SOCKS_PORT=9050
      - TOR_CONTROL_PORT=9051
      - TOR_CONTROL_PASSWORD=${TOR_CONTROL_PASSWORD}
      - ONION_COUNT=5
      - TOR_DATA_DIR=/var/lib/tor
    volumes:
      - /mnt/myssd/Lucid/Lucid/data/tor:/var/lib/tor:rw
      - /mnt/myssd/Lucid/Lucid/data/onion:/run/lucid/onion:rw
      - /mnt/myssd/Lucid/Lucid/logs/tor:/var/log/tor:rw
    networks:
      - lucid-pi-network
    ports:
      - "9050:9050"
      - "9051:9051"
    healthcheck:
      test: ["CMD-SHELL", "/usr/local/bin/tor-health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 45s
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '1.0'
        reservations:
          memory: 128M
          cpus: '0.25'
    labels:
      - "lucid.service=tor-proxy"
      - "lucid.type=core"
      - "lucid.platform=arm64"
      - "lucid.cluster=core"

  lucid-api-server:
    image: pickme/lucid-api-server:latest-arm64
    container_name: lucid-api-server
    hostname: lucid-api-server
    platform: linux/arm64
    pull_policy: always
    restart: unless-stopped
    env_file:
      - ../../configs/environment/.env.foundation
      - ../../configs/environment/.env.core
    environment:
      - LUCID_ENV=production
      - LUCID_PLATFORM=arm64
      - PROJECT_ROOT=/mnt/myssd/Lucid/Lucid
      - API_HOST=0.0.0.0
      - API_PORT=8081
      - MONGODB_URI=mongodb://lucid:${MONGODB_PASSWORD}@lucid-mongodb:27017/lucid?authSource=admin
      - REDIS_URL=redis://lucid-redis:6379/0
      - ELASTICSEARCH_URI=http://lucid-elasticsearch:9200
      - API_GATEWAY_URL=http://lucid-api-gateway:8080
      - TOR_SOCKS=tor-proxy:9050
      - TOR_CONTROL_PORT=9051
      - ONION_DIR=/run/lucid/onion
    volumes:
      - /mnt/myssd/Lucid/Lucid/data/onion:/run/lucid/onion:ro
      - /mnt/myssd/Lucid/Lucid/logs/api-server:/app/logs:rw
    networks:
      - lucid-pi-network
    depends_on:
      lucid-mongodb:
        condition: service_healthy
      lucid-redis:
        condition: service_healthy
      lucid-tor-proxy:
        condition: service_healthy
    ports:
      - "8081:8081"
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://127.0.0.1:8081/health || exit 1"]
      interval: 20s
      timeout: 5s
      retries: 5
      start_period: 15s
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 256M
          cpus: '0.25'
    labels:
      - "lucid.service=api-server"
      - "lucid.type=core"
      - "lucid.platform=arm64"
      - "lucid.cluster=core"

  lucid-api-gateway:
    image: pickme/lucid-api-gateway:latest-arm64
    container_name: lucid-api-gateway
    hostname: lucid-api-gateway
    platform: linux/arm64
    pull_policy: always
    restart: unless-stopped
    env_file:
      - ../../configs/environment/.env.foundation
      - ../../configs/environment/.env.core
    environment:
      - LUCID_ENV=production
      - LUCID_PLATFORM=arm64
      - PROJECT_ROOT=/mnt/myssd/Lucid/Lucid
      - API_UPSTREAM=http://lucid-api-server:8081
      - GATEWAY_PORT=8080
      - API_GATEWAY_URL=http://lucid-api-gateway:8080
      - API_GATEWAY_HOST=172.20.0.10
      - MONGODB_URI=mongodb://lucid:${MONGODB_PASSWORD}@lucid-mongodb:27017/lucid?authSource=admin
      - REDIS_URL=redis://lucid-redis:6379/0
      - JWT_SECRET_KEY=${JWT_SECRET_KEY}
      - SSL_ENABLED=true
      - RATE_LIMIT_PER_MINUTE=1000
      - CORS_ALLOWED_ORIGINS=*
    volumes:
      - /mnt/myssd/Lucid/Lucid/data/onion:/run/lucid/onion:ro
      - /mnt/myssd/Lucid/Lucid/logs/api-gateway:/app/logs:rw
    networks:
      lucid-pi-network:
        ipv4_address: 172.20.0.10
    depends_on:
      - lucid-api-server
      - lucid-mongodb
      - lucid-redis
    ports:
      - "8080:8080"
      - "8081:8081"
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://127.0.0.1:8080/health || exit 1"]
      interval: 20s
      timeout: 5s
      retries: 5
      start_period: 10s
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '1.0'
        reservations:
          memory: 128M
          cpus: '0.25'
    labels:
      - "lucid.service=api-gateway"
      - "lucid.type=core"
      - "lucid.platform=arm64"
      - "lucid.cluster=core"

  lucid-tunnel-tools:
    image: pickme/lucid-tunnel-tools:latest-arm64
    container_name: lucid-tunnel-tools
    hostname: lucid-tunnel-tools
    platform: linux/arm64
    pull_policy: always
    restart: unless-stopped
    env_file:
      - ../../configs/environment/.env.foundation
      - ../../configs/environment/.env.core
    environment:
      - LUCID_ENV=production
      - LUCID_PLATFORM=arm64
      - PROJECT_ROOT=/mnt/myssd/Lucid/Lucid
      - TUNNEL_PORT=7000
      - TUNNEL_MODE=client
      - TOR_SOCKS=tor-proxy:9050
      - ONION_DIR=/run/lucid/onion
    volumes:
      - /mnt/myssd/Lucid/Lucid/data/onion:/run/lucid/onion:rw
      - /mnt/myssd/Lucid/Lucid/data/tunnel:/var/lib/tunnel:rw
      - /mnt/myssd/Lucid/Lucid/logs/tunnel-tools:/app/logs:rw
    networks:
      - lucid-pi-network
    depends_on:
      - lucid-tor-proxy
      - lucid-api-server
    ports:
      - "7000:7000"
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 7000 || exit 1"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.5'
        reservations:
          memory: 64M
          cpus: '0.1'
    labels:
      - "lucid.service=tunnel-tools"
      - "lucid.type=core"
      - "lucid.platform=arm64"
      - "lucid.cluster=core"

  lucid-server-tools:
    image: pickme/lucid-server-tools:latest-arm64
    container_name: lucid-server-tools
    hostname: lucid-server-tools
    platform: linux/arm64
    pull_policy: always
    restart: unless-stopped
    env_file:
      - ../../configs/environment/.env.foundation
      - ../../configs/environment/.env.core
    environment:
      - LUCID_ENV=production
      - LUCID_PLANE=ops
      - LUCID_PLATFORM=arm64
      - PROJECT_ROOT=/mnt/myssd/Lucid/Lucid
      - ONION_DIR=/run/lucid/onion
      - TUNNEL_DATA_DIR=/var/lib/tunnel
    volumes:
      - /mnt/myssd/Lucid/Lucid/data/onion:/run/lucid/onion:ro
      - /mnt/myssd/Lucid/Lucid/data/tunnel:/var/lib/tunnel:ro
      - /mnt/myssd/Lucid/Lucid/logs/server-tools:/app/logs:rw
    networks:
      - lucid-pi-network
    depends_on:
      - lucid-tor-proxy
      - lucid-mongodb
      - lucid-api-server
    healthcheck:
      test: ["CMD-SHELL", "/opt/lucid/scripts/health-check.sh || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s
    deploy:
      resources:
        limits:
          memory: 128M
          cpus: '0.25'
        reservations:
          memory: 32M
          cpus: '0.05'
    labels:
      - "lucid.service=server-tools"
      - "lucid.type=core"
      - "lucid.platform=arm64"
      - "lucid.cluster=core"

networks:
  lucid-pi-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
          gateway: 172.20.0.1
  lucid-tron-isolated:
    driver: bridge
    ipam:
      config:
        - subnet: 172.21.0.0/16
          gateway: 172.21.0.1
  lucid-gui-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.22.0.0/16
          gateway: 172.22.0.1

volumes:
  mongo_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /mnt/myssd/Lucid/Lucid/data/mongodb
  mongo_config:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /mnt/myssd/Lucid/Lucid/data/mongodb-config