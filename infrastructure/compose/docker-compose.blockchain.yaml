# LUCID BLOCKCHAIN SERVICES - Distroless Deployment
# Phase 3: Blockchain Services (API, Governance, VM, Ledger, Sessions Data)
# Aligned with LUCID_DISTROLESS_BUILD_GUIDE.md Phase 3.3


services:
  blockchain-api:
    image: pickme/lucid-blockchain-engine:latest-arm64
    container_name: blockchain-api
    restart: unless-stopped
    networks:
      - lucid-pi-network
    environment:
      - LUCID_ENV=production
      - LUCID_PLATFORM=arm64
      - BLOCKCHAIN_API_PORT=8084
      - TRON_NETWORK=shasta
      - TRON_RPC_URL=https://api.shasta.trongrid.io
      - MONGODB_URL=${MONGODB_URL}
      - REDIS_URL=${REDIS_URL}
    user: "65532:65532"
    security_opt:
      - no-new-privileges:true
      - seccomp:unconfined
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=200m
    volumes:
      - /mnt/myssd/Lucid/data/blockchain:/data/blockchain:rw
      - /mnt/myssd/Lucid/logs/blockchain-api:/app/logs:rw
      - blockchain-api-cache:/tmp/blockchain
    healthcheck:
      test: ["CMD", "python3", "-c", "import sys; sys.exit(0)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    labels:
      - "lucid.service=blockchain-api"
      - "lucid.type=distroless"
      - "lucid.platform=arm64"
      - "lucid.security=hardened"
      - "lucid.cluster=blockchain"

  blockchain-governance:
    image: pickme/lucid-blockchain-governance:latest-arm64
    container_name: blockchain-governance
    restart: unless-stopped
    networks:
      - lucid-pi-network
    environment:
      - LUCID_ENV=production
      - LUCID_PLATFORM=arm64
      - GOVERNANCE_PORT=8085
      - TRON_NETWORK=shasta
      - MONGODB_URL=${MONGODB_URL}
      - REDIS_URL=${REDIS_URL}
    user: "65532:65532"
    security_opt:
      - no-new-privileges:true
      - seccomp:unconfined
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=100m
    volumes:
      - /mnt/myssd/Lucid/data/governance:/data/governance:rw
      - /mnt/myssd/Lucid/logs/blockchain-governance:/app/logs:rw
      - blockchain-governance-cache:/tmp/governance
    healthcheck:
      test: ["CMD", "python3", "-c", "import sys; sys.exit(0)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    labels:
      - "lucid.service=blockchain-governance"
      - "lucid.type=distroless"
      - "lucid.platform=arm64"
      - "lucid.security=hardened"
      - "lucid.cluster=blockchain"

  blockchain-sessions-data:
    image: pickme/lucid-session-storage:latest-arm64
    container_name: blockchain-sessions-data
    restart: unless-stopped
    networks:
      - lucid-pi-network
    environment:
      - LUCID_ENV=production
      - LUCID_PLATFORM=arm64
      - SESSIONS_DATA_PORT=8086
      - TRON_NETWORK=shasta
      - MONGODB_URL=${MONGODB_URL}
      - REDIS_URL=${REDIS_URL}
    user: "65532:65532"
    security_opt:
      - no-new-privileges:true
      - seccomp:unconfined
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=100m
    volumes:
      - /mnt/myssd/Lucid/data/sessions:/data/sessions:ro
      - /mnt/myssd/Lucid/data/encrypted:/data/encrypted:ro
      - /mnt/myssd/Lucid/data/chain:/data/chain:rw
      - /mnt/myssd/Lucid/logs/blockchain-sessions-data:/app/logs:rw
      - blockchain-sessions-data-cache:/tmp/sessions
    healthcheck:
      test: ["CMD", "python3", "-c", "import sys; sys.exit(0)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    labels:
      - "lucid.service=blockchain-sessions-data"
      - "lucid.type=distroless"
      - "lucid.platform=arm64"
      - "lucid.security=hardened"
      - "lucid.cluster=blockchain"

  blockchain-vm:
    image: pickme/lucid-vm:latest-arm64
    container_name: blockchain-vm
    restart: unless-stopped
    networks:
      - lucid-pi-network
    environment:
      - LUCID_ENV=production
      - LUCID_PLATFORM=arm64
      - VM_SERVICE_PORT=8087
      - MONGODB_URL=${MONGODB_URL}
      - REDIS_URL=${REDIS_URL}
    user: "65532:65532"
    security_opt:
      - no-new-privileges:true
      - seccomp:unconfined
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=200m
    volumes:
      - /mnt/myssd/Lucid/data/vm:/data/vm:rw
      - /mnt/myssd/Lucid/logs/blockchain-vm:/app/logs:rw
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - blockchain-vm-cache:/tmp/vm
    healthcheck:
      test: ["CMD", "python3", "-c", "import sys; sys.exit(0)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    labels:
      - "lucid.service=blockchain-vm"
      - "lucid.type=distroless"
      - "lucid.platform=arm64"
      - "lucid.security=hardened"
      - "lucid.cluster=blockchain"

  blockchain-ledger:
    image: pickme/lucid-blockchain-ledger:latest-arm64
    container_name: blockchain-ledger
    restart: unless-stopped
    networks:
      - lucid-pi-network
    environment:
      - LUCID_ENV=production
      - LUCID_PLATFORM=arm64
      - LEDGER_PORT=8088
      - TRON_NETWORK=shasta
      - TRON_RPC_URL=https://api.shasta.trongrid.io
      - MONGODB_URL=${MONGODB_URL}
      - REDIS_URL=${REDIS_URL}
    user: "65532:65532"
    security_opt:
      - no-new-privileges:true
      - seccomp:unconfined
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=100m
    volumes:
      - /mnt/myssd/Lucid/data/ledger:/data/ledger:rw
      - /mnt/myssd/Lucid/logs/blockchain-ledger:/app/logs:rw
      - blockchain-ledger-cache:/tmp/ledger
    healthcheck:
      test: ["CMD", "python3", "-c", "import sys; sys.exit(0)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    labels:
      - "lucid.service=blockchain-ledger"
      - "lucid.type=distroless"
      - "lucid.platform=arm64"
      - "lucid.security=hardened"
      - "lucid.cluster=blockchain"

  on-system-chain-client:
    image: pickme/lucid-chain-client:latest-arm64
    container_name: on-system-chain-client
    restart: unless-stopped
    networks:
      - lucid-pi-network
    environment:
      - LUCID_ENV=production
      - LUCID_PLATFORM=arm64
      - CHAIN_CLIENT_PORT=8094
      - MONGODB_URL=${MONGODB_URL}
      - REDIS_URL=${REDIS_URL}
    user: "65532:65532"
    security_opt:
      - no-new-privileges:true
      - seccomp:unconfined
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=100m
    volumes:
      - /mnt/myssd/Lucid/data/chain:/data/chain:rw
      - /mnt/myssd/Lucid/logs/on-system-chain-client:/app/logs:rw
      - on-system-chain-client-cache:/tmp/chain
    healthcheck:
      test: ["CMD", "python3", "-c", "import sys; sys.exit(0)"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    labels:
      - "lucid.service=on-system-chain-client"
      - "lucid.type=distroless"
      - "lucid.platform=arm64"
      - "lucid.security=hardened"
      - "lucid.cluster=blockchain"

volumes:
  blockchain-api-cache:
    driver: local
    name: lucid-blockchain-api-cache
  blockchain-governance-cache:
    driver: local
    name: lucid-blockchain-governance-cache
  blockchain-sessions-data-cache:
    driver: local
    name: lucid-blockchain-sessions-data-cache
  blockchain-vm-cache:
    driver: local
    name: lucid-blockchain-vm-cache
  blockchain-ledger-cache:
    driver: local
    name: lucid-blockchain-ledger-cache
  on-system-chain-client-cache:
    driver: local
    name: lucid-on-system-chain-client-cache

networks:
  lucid-pi-network:
    external: true
    name: lucid-pi-network