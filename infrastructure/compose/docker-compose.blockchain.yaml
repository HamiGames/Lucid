# LUCID BLOCKCHAIN SERVICES - Distroless Deployment
# Phase 3: Blockchain Services (API, Governance, VM, Ledger, Sessions Data)
# Aligned with LUCID_DISTROLESS_BUILD_GUIDE.md Phase 3.3


services:
  blockchain-api:
    image: pickme/lucid:blockchain-api:latest
    container_name: blockchain_api
    pull_policy: always
    environment:
      BLOCKCHAIN_API_PORT: "8084"
      TRON_NETWORK: "shasta"
      TRON_RPC_URL: "https://api.shasta.trongrid.io"
      MONGODB_URL: "mongodb://lucid:lucid@lucid_mongo:27017/lucid"
    volumes:
      - contract_data:/data/blockchain
    networks:
      - lucid_core_net
    depends_on:
      - lucid_mongo
    ports:
      - "8084:8084"
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:8084/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 256M
          cpus: '0.25'

  blockchain-governance:
    image: pickme/lucid:blockchain-governance:latest
    container_name: blockchain_governance
    pull_policy: always
    environment:
      GOVERNANCE_PORT: "8085"
      TRON_NETWORK: "shasta"
      MONGODB_URL: "mongodb://lucid:lucid@lucid_mongo:27017/lucid"
    volumes:
      - contract_data:/data/governance
    networks:
      - lucid_core_net
    depends_on:
      - blockchain-api
    ports:
      - "8085:8085"
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:8085/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '1.0'
        reservations:
          memory: 128M
          cpus: '0.25'

  blockchain-sessions-data:
    image: pickme/lucid:blockchain-sessions-data:latest
    container_name: blockchain_sessions_data
    pull_policy: always
    environment:
      SESSIONS_DATA_PORT: "8086"
      TRON_NETWORK: "shasta"
      MONGODB_URL: "mongodb://lucid:lucid@lucid_mongo:27017/lucid"
    volumes:
      - sessions_data:/data/sessions:ro
      - encrypted_data:/data/encrypted:ro
      - chain_data:/data/chain
    networks:
      - lucid_core_net
    depends_on:
      - blockchain-api
    ports:
      - "8086:8086"
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:8086/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '1.0'
        reservations:
          memory: 128M
          cpus: '0.25'

  blockchain-vm:
    image: pickme/lucid:blockchain-vm:latest
    container_name: blockchain_vm
    pull_policy: always
    environment:
      VM_SERVICE_PORT: "8087"
      MONGODB_URL: "mongodb://lucid:lucid@lucid_mongo:27017/lucid"
    volumes:
      - contract_data:/data/vm
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - lucid_core_net
    depends_on:
      - blockchain-api
    ports:
      - "8087:8087"
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:8087/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 256M
          cpus: '0.25'

  blockchain-ledger:
    image: pickme/lucid:blockchain-ledger:latest
    container_name: blockchain_ledger
    pull_policy: always
    environment:
      LEDGER_PORT: "8088"
      TRON_NETWORK: "shasta"
      TRON_RPC_URL: "https://api.shasta.trongrid.io"
      MONGODB_URL: "mongodb://lucid:lucid@lucid_mongo:27017/lucid"
    volumes:
      - contract_data:/data/ledger
    networks:
      - lucid_core_net
    depends_on:
      - blockchain-api
    ports:
      - "8088:8088"
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:8088/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '1.0'
        reservations:
          memory: 128M
          cpus: '0.25'

  on-system-chain-client:
    image: pickme/lucid:on-system-chain-client:latest
    container_name: on_system_chain_client
    pull_policy: always
    environment:
      CHAIN_CLIENT_PORT: "8094"
      MONGODB_URL: "mongodb://lucid:lucid@lucid_mongo:27017/lucid"
    volumes:
      - chain_data:/data/chain
    networks:
      - lucid_core_net
    depends_on:
      - blockchain-api
    ports:
      - "8094:8094"
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:8094/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '1.0'
        reservations:
          memory: 128M
          cpus: '0.25'

networks:
  lucid_core_net:
    external: true

volumes:
  contract_data:
  sessions_data:
  encrypted_data:
  chain_data: